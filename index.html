<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="M√ºzikBox">
<meta name="theme-color" content="#07071a">
<title>üéµ M√ºzikBox Pro</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
:root{
  --p:#8b5cf6;--p2:#a78bfa;--p3:#6d28d9;--p4:#4c1d95;
  --g:#10b981;--r:#ef4444;--o:#f59e0b;--b:#3b82f6;--pk:#ec4899;
  --dark:#07071a;--c1:#0f0f24;--c2:#161632;--c3:#1e1e40;
  --t:#fff;--t2:#8080a8;--bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.13);
  --st:env(safe-area-inset-top,0px);--sb:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;overflow:hidden;background:var(--dark)}
body{color:var(--t);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{display:none}

/* BG */
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse at 20% 20%,rgba(109,40,217,.25) 0%,transparent 55%),
             radial-gradient(ellipse at 80% 80%,rgba(76,29,149,.2) 0%,transparent 55%),
             var(--dark)}

/* SHELL */
.shell{position:relative;z-index:1;max-width:430px;margin:0 auto;height:100%;display:flex;flex-direction:column;overflow:hidden}

/* TOPBAR */
.topbar{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:calc(var(--st) + 12px) 18px 0;height:calc(var(--st) + 56px)}
.brand{display:flex;align-items:center;gap:9px}
.brand-ico{width:36px;height:36px;background:linear-gradient(135deg,var(--p3),var(--b));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 0 18px rgba(139,92,246,.4)}
.brand-txt{font-size:19px;font-weight:800}
.brand-txt b{color:var(--p2)}
.badge{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff;
  font-size:10px;font-weight:800;min-width:22px;height:22px;padding:0 6px;
  border-radius:11px;display:flex;align-items:center;justify-content:center}

/* TABS */
.tabs{flex-shrink:0;display:flex;gap:5px;padding:10px 18px 8px}
.tab{flex:1;padding:9px 2px;background:var(--c1);border:1px solid var(--bd);
  border-radius:13px;color:var(--t2);font-size:10px;font-weight:800;
  cursor:pointer;text-align:center;transition:all .22s;
  display:flex;flex-direction:column;align-items:center;gap:3px}
.tab i{font-size:17px;font-style:normal}
.tab.on{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff;
  border-color:transparent;box-shadow:0 4px 16px rgba(139,92,246,.38)}

/* PAGES */
.pages{flex:1;overflow:hidden;position:relative}
.pg{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;
  padding:10px 18px 200px;display:none;-webkit-overflow-scrolling:touch}
.pg.on{display:block}

/* WELCOME */
.welcome{display:flex;flex-direction:column;align-items:center;padding:20px 16px;text-align:center}
.w-ico{font-size:60px;margin-bottom:14px;display:block;animation:wp 2s ease-in-out infinite}
@keyframes wp{0%,100%{transform:scale(1)}50%{transform:scale(1.07)}}
.w-title{font-size:21px;font-weight:800;margin-bottom:8px}
.w-sub{font-size:13px;color:var(--t2);line-height:1.7;margin-bottom:20px}

/* FILE SELECT BUTTON ‚Äî iOS i√ßin √∂zel */
.pick-wrap{position:relative;width:100%;max-width:300px;margin-bottom:12px}
.pick-inp{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;font-size:16px}
.pick-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:16px;color:#fff;font-size:16px;font-weight:700;
  display:flex;align-items:center;justify-content:center;gap:10px;
  box-shadow:0 8px 24px rgba(139,92,246,.4);pointer-events:none}

.pick-wrap2{position:relative;width:100%;max-width:300px;margin-bottom:16px}
.pick-inp2{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;font-size:16px}
.pick-btn2{width:100%;padding:14px;background:var(--c1);
  border:1.5px solid var(--bd2);border-radius:16px;color:var(--t);
  font-size:15px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:10px;pointer-events:none}

.how-box{background:var(--c1);border:1px solid var(--bd);border-radius:16px;
  padding:14px;margin-top:10px;text-align:left;width:100%;max-width:340px}
.how-ttl{font-size:12px;font-weight:800;color:var(--p2);margin-bottom:10px}
.how-row{display:flex;gap:10px;align-items:flex-start;margin-bottom:8px}
.how-n{width:20px;height:20px;background:linear-gradient(135deg,var(--p3),var(--p));
  border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:800;flex-shrink:0;color:#fff}
.how-t{font-size:12px;color:var(--t2);line-height:1.5;padding-top:2px}
.how-t b{color:var(--t)}

/* RESTORE BANNER */
.r-ban{background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(59,130,246,.07));
  border:1px solid rgba(16,185,129,.22);border-radius:14px;padding:12px 14px;
  margin-bottom:12px;display:none;align-items:center;gap:11px}
.r-ban.show{display:flex}
.rb-info{flex:1}
.rb-title{font-size:14px;font-weight:700;margin-bottom:2px}
.rb-sub{font-size:12px;color:var(--t2)}
.rb-btn{background:linear-gradient(135deg,var(--p3),var(--p));border:none;
  border-radius:10px;color:#fff;padding:8px 13px;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0}

/* LOADING */
.ldg{display:none;text-align:center;padding:40px 0}
.ldg.show{display:block}
.spin{width:44px;height:44px;border:3px solid rgba(139,92,246,.15);
  border-top-color:var(--p);border-radius:50%;animation:sp .65s linear infinite;margin:0 auto 12px}
@keyframes sp{to{transform:rotate(360deg)}}
.ldg-t{color:var(--t2);font-size:13px}

/* LIB TOOLBAR */
.lib-bar{display:flex;align-items:center;gap:7px;margin-bottom:10px;margin-top:4px}
.srch-wrap{position:relative;flex:1}
.srch-inp{width:100%;padding:10px 12px 10px 33px;background:var(--c1);
  border:1.5px solid var(--bd);border-radius:12px;color:var(--t);font-size:14px;
  outline:none;-webkit-appearance:none;font-family:inherit;transition:border .2s}
.srch-inp:focus{border-color:var(--p)}
.srch-inp::placeholder{color:var(--t2)}
.srch-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none}
.tool-btn{padding:10px 9px;background:var(--c1);border:1.5px solid var(--bd);
  border-radius:11px;color:var(--t2);font-size:11px;font-weight:700;cursor:pointer;
  white-space:nowrap;display:flex;align-items:center;justify-content:center}
.tool-btn:active{background:var(--c2)}

/* VIEW TABS */
.vtabs{display:flex;gap:5px;margin-bottom:10px;overflow-x:auto;padding-bottom:2px}
.vt{flex-shrink:0;padding:7px 11px;background:var(--c1);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.vt.on{background:rgba(139,92,246,.15);border-color:var(--p);color:var(--p2)}

/* SECTION LABEL */
.slbl{font-size:11px;font-weight:800;color:var(--t2);text-transform:uppercase;
  letter-spacing:1px;margin:12px 0 9px;display:flex;align-items:center;gap:8px}
.slbl::after{content:'';flex:1;height:1px;background:var(--bd)}

/* TRACK CARD */
.tc{background:var(--c1);border:1px solid var(--bd);border-radius:15px;
  padding:11px;display:flex;align-items:center;gap:11px;margin-bottom:9px;
  cursor:pointer;position:relative;overflow:hidden;transition:background .15s}
.tc.playing{border-color:var(--p);background:rgba(139,92,246,.08)}
.tc:active{opacity:.8}
.tc-art{width:50px;height:50px;border-radius:11px;object-fit:cover;flex-shrink:0;background:var(--c3)}
.tc-ph{width:50px;height:50px;border-radius:11px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.tc-info{flex:1;min-width:0}
.tc-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.tc-artist{font-size:12px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}
.tc-meta{display:flex;gap:5px;flex-wrap:wrap}
.tc-dur{font-size:10px;color:var(--t2);background:var(--c3);padding:2px 6px;border-radius:5px}
.tc-fmt{font-size:10px;font-weight:800;padding:2px 6px;border-radius:5px}
.tc-acts{display:flex;gap:5px;flex-shrink:0}
.ta{width:30px;height:30px;border:none;border-radius:8px;cursor:pointer;
  font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.ta:active{transform:scale(.85)}
.ta-fav{background:rgba(239,68,68,.13);color:var(--r)}
.ta-fav.on{background:rgba(239,68,68,.28)}
.ta-more{background:var(--c3);color:var(--t2)}

/* PLAY IND */
.play-ind{display:flex;align-items:flex-end;gap:2px;height:16px;
  position:absolute;right:11px;top:50%;transform:translateY(-50%)}
.pi{width:3px;background:var(--p2);border-radius:2px;animation:pia .65s ease infinite alternate}
.pi:nth-child(1){animation-delay:0s}.pi:nth-child(2){animation-delay:.18s}.pi:nth-child(3){animation-delay:.35s}
@keyframes pia{from{height:3px}to{height:14px}}
.pi.p{animation-play-state:paused;height:4px}

/* GRID */
.grid-v{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.gc{background:var(--c1);border:1px solid var(--bd);border-radius:15px;
  padding:12px;cursor:pointer;transition:all .2s}
.gc:active{opacity:.8}
.gc.playing{border-color:var(--p)}
.gc-art{width:100%;aspect-ratio:1;border-radius:10px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:32px;
  margin-bottom:9px;overflow:hidden}
.gc-art img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.gc-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.gc-artist{font-size:11px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* GROUP */
.grp-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.grp-item{background:var(--c1);border:1px solid var(--bd);border-radius:13px;
  padding:13px 11px;cursor:pointer;transition:all .2s;text-align:center}
.grp-item:active{opacity:.8}
.grp-ico{font-size:26px;margin-bottom:7px;display:block}
.grp-name{font-size:13px;font-weight:700;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.grp-cnt{font-size:11px;color:var(--t2)}

/* PLAYER PAGE */
.pl-pg{display:flex;flex-direction:column;align-items:center;padding-top:4px}
.art-wrap{position:relative;width:230px;height:230px;margin:0 auto 16px}
.art-glow{position:absolute;inset:-16px;
  background:radial-gradient(circle,var(--p3) 0%,transparent 65%);
  opacity:.38;filter:blur(14px);animation:ag 3s ease-in-out infinite;transition:background 1.2s}
@keyframes ag{0%,100%{opacity:.28;transform:scale(.9)}50%{opacity:.5;transform:scale(1.05)}}
.art-frame{position:relative;width:230px;height:230px;border-radius:24px;
  overflow:hidden;box-shadow:0 18px 48px rgba(0,0,0,.6);
  background:linear-gradient(135deg,var(--p4),var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:68px}
.art-frame img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.art-ring{position:absolute;inset:-4px;border-radius:28px;
  border:2px solid rgba(139,92,246,.3);
  animation:ar 10s linear infinite;opacity:0;transition:opacity .5s}
.art-ring.show{opacity:1}
@keyframes ar{to{transform:rotate(360deg)}}

.trk-title{font-size:19px;font-weight:800;text-align:center;margin-bottom:3px;
  padding:0 12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.trk-artist{font-size:13px;color:var(--t2);text-align:center;margin-bottom:2px}
.trk-album{font-size:11px;color:var(--t2);opacity:.6;text-align:center;margin-bottom:12px}

/* SPECTRUM */
.spectrum{display:flex;align-items:flex-end;justify-content:center;
  gap:2px;height:32px;width:100%;padding:0 12px;margin-bottom:12px}
.sp{flex:1;max-width:5px;background:linear-gradient(to top,var(--p3),var(--p2));
  border-radius:3px 3px 1px 1px;min-height:3px;opacity:.5}

/* SEEK */
.seek-wrap{width:100%;padding:0 2px;margin-bottom:5px;touch-action:none;cursor:pointer}
.seek-track{height:5px;background:rgba(255,255,255,.1);border-radius:3px;position:relative}
.seek-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));
  border-radius:3px;width:0%;position:relative}
.seek-thumb{position:absolute;right:-7px;top:-5px;width:15px;height:15px;
  background:#fff;border-radius:50%;box-shadow:0 0 8px rgba(139,92,246,.6);
  opacity:0;transition:opacity .2s;pointer-events:none}
.seek-wrap.drag .seek-thumb{opacity:1}
.seek-times{display:flex;justify-content:space-between;
  font-size:11px;color:var(--t2);margin-top:5px}

/* CONTROLS */
.ctrl-row{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px}
.cb{border:none;background:transparent;color:var(--t);cursor:pointer;
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  transition:all .15s;font-size:19px;width:42px;height:42px}
.cb:active{background:rgba(255,255,255,.07);transform:scale(.9)}
.cb.sm{width:37px;height:37px;font-size:17px;color:var(--t2)}
.cb.pp{width:64px;height:64px;font-size:26px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  box-shadow:0 6px 20px rgba(139,92,246,.45);color:#fff}
.cb.pp:active{transform:scale(.93)}
.cb.on{color:var(--p2)!important}

/* EXTRA ROW */
.extra-row{display:flex;align-items:center;justify-content:space-around;
  width:100%;padding:0 4px;margin-bottom:10px}
.eb{display:flex;flex-direction:column;align-items:center;gap:4px;
  background:none;border:none;color:var(--t2);cursor:pointer;
  padding:6px;border-radius:11px;font-size:17px;transition:all .2s}
.eb span{font-size:10px;font-weight:700}
.eb.on{color:var(--p2)}
.eb:active{transform:scale(.88)}

/* VOLUME */
.vol-row{display:flex;align-items:center;gap:10px;width:100%;padding:0 2px;margin-bottom:10px}
.vol-ico{font-size:14px;color:var(--t2);flex-shrink:0}
.vol-track{flex:1;height:5px;background:rgba(255,255,255,.1);border-radius:3px;
  cursor:pointer;touch-action:none}
.vol-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));
  border-radius:3px;width:80%;pointer-events:none}

/* EQ */
.eq-panel{width:100%;background:var(--c1);border:1px solid var(--bd);
  border-radius:15px;padding:14px;margin-bottom:10px;display:none}
.eq-panel.show{display:block}
.eq-head{font-size:13px;font-weight:700;margin-bottom:10px;
  display:flex;align-items:center;justify-content:space-between}
.eq-presets{display:flex;gap:6px;overflow-x:auto;margin-bottom:10px}
.eq-pr{flex-shrink:0;padding:6px 10px;background:var(--c2);border:1.5px solid var(--bd);
  border-radius:9px;color:var(--t2);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s}
.eq-pr.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.13)}
.eq-bands{display:flex;justify-content:space-around;align-items:flex-end;height:95px}
.eq-band{display:flex;flex-direction:column;align-items:center;gap:5px;width:36px}
.eq-sl{-webkit-appearance:none;appearance:none;writing-mode:vertical-lr;direction:rtl;
  width:4px;height:65px;background:rgba(255,255,255,.1);border-radius:2px;cursor:pointer;outline:none}
.eq-sl::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;
  border-radius:50%;background:var(--p2);box-shadow:0 0 5px rgba(139,92,246,.5)}
.eq-lbl{font-size:10px;color:var(--t2);font-weight:700}

/* SPEED */
.spd-row{display:flex;gap:6px;overflow-x:auto;padding:0 2px;margin-bottom:12px}
.spd-btn{flex-shrink:0;padding:7px 10px;background:var(--c1);border:1.5px solid var(--bd);
  border-radius:9px;color:var(--t2);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.spd-btn.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.13)}

/* PLAYLIST PAGE */
.pl-hdr{display:flex;align-items:center;justify-content:space-between;margin:4px 0 12px}
.pl-card{background:var(--c1);border:1px solid var(--bd);border-radius:14px;
  padding:12px;display:flex;align-items:center;gap:11px;margin-bottom:9px;
  cursor:pointer;transition:all .2s}
.pl-card:active{opacity:.8}
.pl-art{width:48px;height:48px;border-radius:11px;
  background:linear-gradient(135deg,var(--p3),var(--pk));
  display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.pl-info{flex:1;min-width:0}
.pl-name{font-size:14px;font-weight:700;margin-bottom:3px}
.pl-cnt{font-size:12px;color:var(--t2)}
.pl-acts{display:flex;gap:5px}
.pa{width:30px;height:30px;border:none;border-radius:8px;cursor:pointer;
  font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.pa:active{transform:scale(.85)}
.pa-play{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff}
.pa-del{background:rgba(239,68,68,.13);color:var(--r)}
.smart-pl{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(59,130,246,.05));border-color:rgba(139,92,246,.18)}
.add-pl-btn{padding:8px 13px;background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:10px;color:#fff;font-size:13px;font-weight:700;cursor:pointer}

/* SETTINGS */
.set-sec{background:var(--c1);border:1px solid var(--bd);border-radius:14px;margin-bottom:10px;overflow:hidden}
.set-ttl{font-size:11px;font-weight:800;color:var(--t2);text-transform:uppercase;
  letter-spacing:1px;padding:11px 14px 5px}
.set-row{display:flex;align-items:center;gap:10px;padding:11px 14px;
  border-top:1px solid var(--bd);cursor:pointer;transition:background .15s}
.set-row:active{background:var(--c2)}
.set-ico{font-size:16px;width:24px;text-align:center;flex-shrink:0}
.set-lbl{flex:1;font-size:13px;font-weight:600}
.set-val{font-size:12px;color:var(--t2)}
.tog{width:42px;height:24px;background:var(--c3);border-radius:12px;
  position:relative;cursor:pointer;transition:background .25s;flex-shrink:0}
.tog.on{background:var(--p)}
.tog::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;
  background:#fff;border-radius:50%;transition:transform .25s;box-shadow:0 2px 5px rgba(0,0,0,.3)}
.tog.on::after{transform:translateX(18px)}
.theme-colors{display:flex;gap:9px;padding:11px 14px;flex-wrap:wrap}
.thm-c{width:28px;height:28px;border-radius:50%;cursor:pointer;
  transition:all .2s;border:2px solid transparent}
.thm-c.on{border-color:#fff;transform:scale(1.15)}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:10px 12px}
.stat-i{background:var(--c2);border-radius:11px;padding:10px;text-align:center}
.stat-n{font-size:18px;font-weight:800;
  background:linear-gradient(135deg,var(--p),var(--b));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-l{font-size:11px;color:var(--t2);margin-top:3px}
.sleep-btns{display:flex;gap:7px;padding:9px 14px;overflow-x:auto}
.slp-btn{flex-shrink:0;padding:7px 12px;background:var(--c2);border:1.5px solid var(--bd);
  border-radius:9px;color:var(--t2);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.slp-btn.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.13)}

/* QUEUE PANEL */
.q-pan{position:fixed;bottom:0;left:0;right:0;z-index:500;max-width:430px;margin:0 auto;
  background:rgba(13,13,28,.97);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--bd2);border-radius:24px 24px 0 0;
  transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
  max-height:75vh;display:flex;flex-direction:column}
.q-pan.show{transform:translateY(0)}
.qp-hdl{width:36px;height:4px;background:var(--bd2);border-radius:2px;margin:10px auto 0;cursor:pointer;flex-shrink:0}
.qp-hdr{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;flex-shrink:0;border-bottom:1px solid var(--bd)}
.qp-list{overflow-y:auto;flex:1;padding:8px 16px 16px}
.qi{display:flex;align-items:center;gap:10px;padding:9px 9px;border-radius:11px;
  cursor:pointer;transition:all .18s;margin-bottom:5px}
.qi.active{background:rgba(139,92,246,.11);border:1px solid rgba(139,92,246,.2)}
.qi:active{background:var(--c2)}
.qi-num{width:20px;text-align:center;font-size:12px;color:var(--t2);font-weight:700;flex-shrink:0}
.qi-art{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;overflow:hidden}
.qi-art img{width:100%;height:100%;object-fit:cover;border-radius:8px}
.qi-info{flex:1;min-width:0}
.qi-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qi-artist{font-size:11px;color:var(--t2)}
.qi-dur{font-size:11px;color:var(--t2);flex-shrink:0}
.qi-rm{width:22px;height:22px;background:rgba(239,68,68,.11);border:none;border-radius:6px;
  color:var(--r);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* MINI PLAYER */
.mini{position:fixed;bottom:0;left:0;right:0;z-index:300;max-width:430px;margin:0 auto;
  background:rgba(11,11,26,.97);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--bd);transform:translateY(100%);transition:transform .32s cubic-bezier(.4,0,.2,1)}
.mini.show{transform:translateY(0)}
.mp-prog{height:3px;background:rgba(255,255,255,.07);cursor:pointer;overflow:hidden}
.mp-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));width:0%;transition:width .4s linear}
.mp-body{display:flex;align-items:center;gap:11px;padding:9px 14px;
  padding-bottom:max(9px,var(--sb))}
.mp-art{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:18px;
  flex-shrink:0;overflow:hidden;cursor:pointer}
.mp-art img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.mp-info{flex:1;min-width:0;cursor:pointer}
.mp-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mp-artist{font-size:11px;color:var(--t2)}
.mp-bars{display:flex;align-items:flex-end;gap:2px;height:12px;margin-top:3px}
.mpb{width:3px;background:var(--p2);border-radius:2px;animation:mpba .65s ease infinite alternate}
.mpb:nth-child(1){animation-delay:0s}.mpb:nth-child(2){animation-delay:.17s}
.mpb:nth-child(3){animation-delay:.33s}.mpb:nth-child(4){animation-delay:.5s}
@keyframes mpba{from{height:2px}to{height:10px}}
.mp-bars.p .mpb{animation-play-state:paused;height:3px}
.mp-ctrls{display:flex;gap:4px;align-items:center}
.mc{width:33px;height:33px;border:none;background:transparent;color:var(--t);
  font-size:16px;cursor:pointer;border-radius:50%;
  display:flex;align-items:center;justify-content:center;transition:all .15s}
.mc:active{background:rgba(255,255,255,.07)}
.mc.mpp{width:40px;height:40px;background:linear-gradient(135deg,var(--p3),var(--p));
  box-shadow:0 3px 12px rgba(139,92,246,.38)}

/* MODAL */
.modal-ov{position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.7);
  backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center}
.modal-ov.show{display:flex}
.modal{width:100%;max-width:430px;background:var(--c2);border-radius:22px 22px 0 0;
  padding:16px 16px max(16px,var(--sb));animation:mup .3s cubic-bezier(.4,0,.2,1)}
@keyframes mup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-hdl{width:36px;height:4px;background:var(--bd2);border-radius:2px;margin:0 auto 12px}
.modal-ttl{font-size:16px;font-weight:800;margin-bottom:12px}
.modal-inp{width:100%;padding:12px 13px;background:var(--dark);border:1.5px solid var(--bd);
  border-radius:12px;color:var(--t);font-size:16px;outline:none;-webkit-appearance:none;
  font-family:inherit;margin-bottom:10px}
.modal-inp:focus{border-color:var(--p)}
.modal-inp::placeholder{color:var(--t2)}
.modal-ok{width:100%;padding:13px;background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:8px}
.modal-cancel{width:100%;padding:12px;background:var(--c3);border:1px solid var(--bd);
  border-radius:12px;color:var(--t);font-size:14px;font-weight:600;cursor:pointer}

/* CTX */
.ctx{position:fixed;z-index:900;background:var(--c2);border:1px solid var(--bd2);
  border-radius:15px;padding:6px;min-width:190px;box-shadow:0 12px 32px rgba(0,0,0,.5);display:none}
.ctx.show{display:block}
.ctx-row{display:flex;align-items:center;gap:10px;padding:10px 11px;border-radius:9px;
  cursor:pointer;font-size:13px;font-weight:600;transition:background .15s}
.ctx-row:active{background:var(--c3)}
.ctx-ico{font-size:15px;width:20px;text-align:center;flex-shrink:0}
.ctx-row.red{color:var(--r)}

/* TOAST */
.toast{position:fixed;top:max(66px,calc(var(--st) + 66px));left:50%;
  transform:translateX(-50%) translateY(-10px);background:var(--c2);
  color:var(--t);padding:9px 17px;border-radius:22px;font-size:13px;font-weight:600;
  border:1px solid var(--bd2);z-index:1000;opacity:0;transition:all .25s;
  white-space:nowrap;pointer-events:none;backdrop-filter:blur(12px);
  max-width:86vw;text-align:center}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.empty{text-align:center;padding:44px 20px}
.e-ico{font-size:44px;display:block;margin-bottom:10px}
.e-tit{font-size:16px;font-weight:700;margin-bottom:6px}
.e-sub{font-size:13px;color:var(--t2);line-height:1.6}

/* PWA BANNER */
.pwa-b{background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(59,130,246,.07));
  border:1px solid rgba(139,92,246,.2);border-radius:13px;padding:11px 13px;
  margin-bottom:10px;display:flex;align-items:center;gap:10px}
.pwa-txt{flex:1;font-size:12px;color:var(--t2);line-height:1.5}
.pwa-txt b{color:var(--t)}
.pwa-x{width:22px;height:22px;background:var(--c3);border:none;border-radius:6px;
  color:var(--t2);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
</style>
</head>
<body>
<div class="bg"></div>
<div class="toast" id="toast"></div>

<!-- CTX -->
<div class="ctx" id="ctx">
  <div class="ctx-row" onclick="ctxPlay()"><span class="ctx-ico">‚ñ∂Ô∏è</span>≈ûimdi √áal</div>
  <div class="ctx-row" onclick="ctxNext()"><span class="ctx-ico">‚è≠</span>Sƒ±radaki √áal</div>
  <div class="ctx-row" onclick="ctxQueue()"><span class="ctx-ico">üìã</span>Sƒ±raya Ekle</div>
  <div class="ctx-row" onclick="ctxAddPl()"><span class="ctx-ico">‚ûï</span>Playliste Ekle</div>
  <div class="ctx-row" id="ctxFavRow" onclick="ctxFav()">
    <span class="ctx-ico" id="ctxFavIco">‚ù§Ô∏è</span><span id="ctxFavTxt">Favorilere Ekle</span>
  </div>
  <div class="ctx-row red" onclick="ctxDel()"><span class="ctx-ico">üóëÔ∏è</span>Kaldƒ±r</div>
</div>

<!-- MODAL -->
<div class="modal-ov" id="modalOv">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-hdl"></div>
    <div class="modal-ttl" id="modalTtl">Yeni Playlist</div>
    <input class="modal-inp" id="modalInp" type="text" placeholder="Playlist adƒ±...">
    <button class="modal-ok"     onclick="modalOk()">‚úÖ Tamam</button>
    <button class="modal-cancel" onclick="closeModal()">ƒ∞ptal</button>
  </div>
</div>

<!-- QUEUE -->
<div class="q-pan" id="qPan">
  <div class="qp-hdl" onclick="closeQ()"></div>
  <div class="qp-hdr">
    <div style="font-size:15px;font-weight:800">üìã Sƒ±ra</div>
    <div style="display:flex;gap:7px">
      <button onclick="shuffleQ()" style="background:var(--c3);border:none;border-radius:8px;color:var(--t2);padding:7px 10px;font-size:12px;font-weight:700;cursor:pointer">üîÄ</button>
      <button onclick="clearQ()"   style="background:rgba(239,68,68,.11);border:none;border-radius:8px;color:var(--r);padding:7px 10px;font-size:12px;font-weight:700;cursor:pointer">Temizle</button>
    </div>
  </div>
  <div class="qp-list" id="qList"></div>
</div>

<div class="shell">
  <div class="topbar">
    <div class="brand">
      <div class="brand-ico">üéµ</div>
      <div class="brand-txt">M√ºzik<b>Box</b></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div style="width:34px;height:34px;background:var(--c1);border:1px solid var(--bd);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer" onclick="openQ()">üìã</div>
      <div class="badge" id="badge">0</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab on" onclick="goTab('lib',this)"><i>üéµ</i>Kitaplƒ±k</div>
    <div class="tab"    onclick="goTab('player',this)"><i>üéß</i>√áalar</div>
    <div class="tab"    onclick="goTab('pl',this)"><i>üìã</i>Listeler</div>
    <div class="tab"    onclick="goTab('cfg',this)"><i>‚öôÔ∏è</i>Ayarlar</div>
  </div>

  <div class="pages">

    <!-- Kƒ∞TAPLIK -->
    <div class="pg on" id="pg-lib">

      <div class="pwa-b" id="pwaBan">
        <div style="font-size:20px;flex-shrink:0">üì≤</div>
        <div class="pwa-txt"><b>Ana Ekrana Ekle</b> ‚Üí Payla≈ü ‚Üí Ana Ekrana Ekle ‚Üí Arka planda √ßalma aktif!</div>
        <button class="pwa-x" onclick="hidePWA()">‚úï</button>
      </div>

      <div class="r-ban" id="rBan">
        <div style="font-size:22px;flex-shrink:0">üíæ</div>
        <div class="rb-info">
          <div class="rb-title" id="rBanTitle">Kayƒ±tlƒ± m√ºzikler bulundu</div>
          <div class="rb-sub"   id="rBanSub">K√ºt√ºphaneyi geri y√ºkle</div>
        </div>
        <button class="rb-btn" onclick="doRestore()">Y√ºkle</button>
      </div>

      <!-- WELCOME (dosya se√ßilmediƒüinde) -->
      <div id="welcomeArea">
        <div class="welcome">
          <span class="w-ico">üìÅ</span>
          <div class="w-title">M√ºzik Dosyalarƒ±nƒ± Se√ß</div>
          <div class="w-sub">iPhone'daki MP3 dosyalarƒ±nƒ± se√ß,<br>otomatik y√ºklensin ve √ßalsƒ±n!</div>

          <!-- iOS'ta en g√ºvenilir y√∂ntem: label + hidden input -->
          <label class="pick-wrap" style="cursor:pointer">
            <input type="file" id="fileInp" multiple accept="audio/*,.mp3,.m4a,.aac,.wav,.ogg,.flac"
              style="position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;font-size:16px"
              onchange="onFilesSelected(this)">
            <div class="pick-btn">üéµ M√ºzik Dosyasƒ± Se√ß</div>
          </label>

          <div class="how-box">
            <div class="how-ttl">üìñ Nasƒ±l Kullanƒ±lƒ±r?</div>
            <div class="how-row"><div class="how-n">1</div><div class="how-t"><b>M√ºzik Dosyasƒ± Se√ß</b> butonuna bas</div></div>
            <div class="how-row"><div class="how-n">2</div><div class="how-t">iPhone'daki MP3 dosyalarƒ±nƒ± se√ß (√ßoklu se√ßim yapƒ±labilir)</div></div>
            <div class="how-row"><div class="how-n">3</div><div class="how-t">Dosyalar y√ºklenir ve <b>otomatik √ßalmaya ba≈ülar</b></div></div>
            <div class="how-row"><div class="how-n">4</div><div class="how-t">Bir daha se√ßmene gerek yok ‚Äî <b>kalƒ±cƒ± kaydedilir!</b></div></div>
          </div>
        </div>
      </div>

      <!-- Lƒ∞BRARY -->
      <div id="libArea" style="display:none">
        <div class="lib-bar">
          <div class="srch-wrap">
            <span class="srch-ico">üîç</span>
            <input class="srch-inp" id="libQ" type="text" placeholder="Ara..."
              oninput="debFilter(this.value)">
          </div>
          <div class="tool-btn" onclick="cycleSort()">‚áÖ <span id="sortLbl">A-Z</span></div>
          <div class="tool-btn" onclick="cycleView()" style="width:36px">‚äû</div>
        </div>

        <div class="vtabs">
          <div class="vt on" onclick="setVT(this,'all')">üéµ T√ºm√º</div>
          <div class="vt" onclick="setVT(this,'artist')">üë§ Sanat√ßƒ±</div>
          <div class="vt" onclick="setVT(this,'album')">üíø Alb√ºm</div>
          <div class="vt" onclick="setVT(this,'genre')">üé∏ T√ºr</div>
          <div class="vt" onclick="setVT(this,'fav')">‚ù§Ô∏è Favori</div>
          <div class="vt" onclick="setVT(this,'recent')">üïê Son</div>
        </div>

        <div class="ldg" id="scanLdg">
          <div class="spin"></div>
          <div class="ldg-t" id="scanTxt">Y√ºkleniyor...</div>
        </div>

        <div id="trackCont"></div>

        <!-- Dosya ekle butonu -->
        <div style="text-align:center;margin-top:12px">
          <label style="display:inline-block;cursor:pointer">
            <input type="file" id="addFileInp" multiple accept="audio/*,.mp3,.m4a,.aac,.wav,.ogg,.flac"
              style="display:none" onchange="onAddFiles(this)">
            <div style="background:var(--c1);border:1px solid var(--bd);color:var(--t2);
              padding:9px 15px;border-radius:11px;font-size:12px;font-weight:700;display:inline-flex;align-items:center;gap:6px">
              ‚ûï Dosya Ekle
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- √áALAR -->
    <div class="pg" id="pg-player">
      <div class="pl-pg">
        <div class="art-wrap">
          <div class="art-glow" id="artGlow"></div>
          <div class="art-frame" id="artFrame"><span id="artEmoji">üéµ</span><img id="artImg" style="display:none"></div>
          <div class="art-ring" id="artRing"></div>
        </div>
        <div class="trk-title"  id="pTitle">≈ûarkƒ± Se√ßilmedi</div>
        <div class="trk-artist" id="pArtist">‚Äî Kitaplƒ±ktan se√ß ‚Äî</div>
        <div class="trk-album"  id="pAlbum"></div>
        <div class="spectrum"   id="spectrum"></div>
        <div class="seek-wrap"  id="seekWrap">
          <div class="seek-track">
            <div class="seek-fill" id="seekFill"><div class="seek-thumb"></div></div>
          </div>
          <div class="seek-times"><span id="curTime">0:00</span><span id="durTime">0:00</span></div>
        </div>
        <div class="ctrl-row">
          <button class="cb sm" onclick="prevTr()">‚èÆ</button>
          <button class="cb sm" onclick="skip(-10)">‚Ü©</button>
          <button class="cb pp" id="ppBtn" onclick="togPP()">‚ñ∂</button>
          <button class="cb sm" onclick="skip(10)">‚Ü™</button>
          <button class="cb sm" onclick="nextTr()">‚è≠</button>
        </div>
        <div class="extra-row">
          <button class="eb" id="shuffleBtn" onclick="togShuffle()">üîÄ<span>Karƒ±≈ütƒ±r</span></button>
          <button class="eb" id="repeatBtn"  onclick="togRepeat()">üîÅ<span>Tekrar</span></button>
          <button class="eb" id="favBtn"     onclick="togFavCur()">‚ô°<span>Favori</span></button>
          <button class="eb" id="eqBtn"      onclick="togEQ()">üéõ<span>EQ</span></button>
          <button class="eb"                 onclick="goTab('cfg',document.querySelectorAll('.tab')[3])">üò¥<span>Uyku</span></button>
        </div>
        <div class="eq-panel" id="eqPanel">
          <div class="eq-head">
            <span>üéõ Ekolayzer</span>
            <button onclick="applyEQ('Normal',null)" style="background:var(--c3);border:none;border-radius:7px;color:var(--t2);padding:4px 8px;font-size:11px;font-weight:700;cursor:pointer">Sƒ±fƒ±rla</button>
          </div>
          <div class="eq-presets" id="eqPresets"></div>
          <div class="eq-bands"   id="eqBands"></div>
        </div>
        <div class="vol-row">
          <span class="vol-ico">üîà</span>
          <div class="vol-track" id="volTrack"><div class="vol-fill" id="volFill"></div></div>
          <span class="vol-ico">üîä</span>
        </div>
        <div style="text-align:center;margin-bottom:5px">
          <span style="font-size:11px;color:var(--t2);font-weight:700">HIZ: </span>
          <span style="font-size:13px;font-weight:800;color:var(--p2)" id="spdLbl">1x</span>
        </div>
        <div class="spd-row">
          <div class="spd-btn" onclick="setSpd(.5)">0.5x</div>
          <div class="spd-btn" onclick="setSpd(.75)">0.75x</div>
          <div class="spd-btn on" onclick="setSpd(1)">1x</div>
          <div class="spd-btn" onclick="setSpd(1.25)">1.25x</div>
          <div class="spd-btn" onclick="setSpd(1.5)">1.5x</div>
          <div class="spd-btn" onclick="setSpd(2)">2x</div>
        </div>
      </div>
    </div>

    <!-- PLAYLƒ∞STLER -->
    <div class="pg" id="pg-pl">
      <div class="pl-hdr">
        <div style="font-size:17px;font-weight:800">üìã √áalma Listeleri</div>
        <button class="add-pl-btn" onclick="openCreatePl()">+ Yeni</button>
      </div>
      <div class="slbl">‚ú® Akƒ±llƒ± Listeler</div>
      <div id="smartPls"></div>
      <div class="slbl">üìÅ Listelerim</div>
      <div id="manPls"></div>
    </div>

    <!-- AYARLAR -->
    <div class="pg" id="pg-cfg">
      <div class="set-sec">
        <div class="set-ttl">üìä ƒ∞statistikler</div>
        <div class="stat-grid" id="statGrid"></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">üéµ Oynatma</div>
        <div class="set-row" onclick="togCfg('autoplay')"><div class="set-ico">üîÑ</div><div class="set-lbl">Otomatik Oynat</div><div class="tog" id="tog-autoplay"></div></div>
        <div class="set-row" onclick="togCfg('spectrum')"><div class="set-ico">üìä</div><div class="set-lbl">Spektrum G√∂rseli</div><div class="tog" id="tog-spectrum"></div></div>
        <div class="set-row" onclick="togCfg('dynbg')">  <div class="set-ico">üé®</div><div class="set-lbl">Dinamik Renk</div><div class="tog" id="tog-dynbg"></div></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">üò¥ Uyku Zamanlayƒ±cƒ±sƒ±</div>
        <div class="sleep-btns">
          <div class="slp-btn on" onclick="setSleep(0,this)">Kapalƒ±</div>
          <div class="slp-btn" onclick="setSleep(15,this)">15 dk</div>
          <div class="slp-btn" onclick="setSleep(30,this)">30 dk</div>
          <div class="slp-btn" onclick="setSleep(45,this)">45 dk</div>
          <div class="slp-btn" onclick="setSleep(60,this)">60 dk</div>
          <div class="slp-btn" onclick="setSleep(90,this)">90 dk</div>
        </div>
        <div class="set-row"><div class="set-ico">‚è±</div><div class="set-lbl">Kalan</div><div class="set-val" id="sleepDisp">‚Äî</div></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">üé® Tema</div>
        <div class="theme-colors" id="themeColors"></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">üìÅ M√ºzik</div>
        <div class="set-row"><div class="set-ico">üíæ</div><div class="set-lbl">Kayƒ±tlƒ± ≈ûarkƒ±</div><div class="set-val" id="cachedCnt">0</div></div>
        <div class="set-row" onclick="clearAll()"><div class="set-ico">üóëÔ∏è</div><div class="set-lbl">T√ºm Verileri Temizle</div><div style="color:var(--t2);font-size:16px">‚Ä∫</div></div>
      </div>
    </div>

  </div>
</div>

<!-- MINI PLAYER -->
<div class="mini" id="mini">
  <div class="mp-prog" id="mpProg" onclick="miniSeek(event)">
    <div class="mp-fill" id="mpFill"></div>
  </div>
  <div class="mp-body">
    <div class="mp-art" id="mpArt"
      onclick="goTab('player',document.querySelectorAll('.tab')[1])">üéµ</div>
    <div class="mp-info" onclick="goTab('player',document.querySelectorAll('.tab')[1])">
      <div class="mp-title"  id="mpTitle">‚Äî</div>
      <div class="mp-artist" id="mpArtist">‚Äî</div>
      <div class="mp-bars p" id="mpBars">
        <div class="mpb"></div><div class="mpb"></div>
        <div class="mpb"></div><div class="mpb"></div>
      </div>
    </div>
    <div class="mp-ctrls">
      <button class="mc"    onclick="prevTr()">‚èÆ</button>
      <button class="mc mpp" id="mpPP" onclick="togPP()">‚ñ∂</button>
      <button class="mc"    onclick="nextTr()">‚è≠</button>
    </div>
  </div>
</div>

<!-- AUDIO ‚Äî iOS i√ßin kritik attribute'lar -->
<audio id="aud" preload="auto" playsinline webkit-playsinline></audio>

<script>
'use strict';

/* ‚îÄ‚îÄ‚îÄ IndexedDB ‚îÄ‚îÄ‚îÄ */
const DB_NAME = 'mb_v4', DB_VER = 1;
let db = null;

async function openDB() {
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded = e=>{
      const d = e.target.result;
      if(!d.objectStoreNames.contains('blobs')) d.createObjectStore('blobs',{keyPath:'id'});
      if(!d.objectStoreNames.contains('meta'))  d.createObjectStore('meta', {keyPath:'id'});
    };
    r.onsuccess = e=>{ db=e.target.result; res(); };
    r.onerror   = ()=>res(); // hata olsa da devam et
  });
}

function dbPut(store,obj){
  if(!db) return Promise.resolve();
  return new Promise(res=>{
    try{
      const tx=db.transaction(store,'readwrite');
      tx.objectStore(store).put(obj);
      tx.oncomplete=()=>res();
      tx.onerror=()=>res();
    }catch{res();}
  });
}

function dbGet(store,key){
  if(!db) return Promise.resolve(null);
  return new Promise(res=>{
    try{
      const tx=db.transaction(store,'readonly');
      const rq=tx.objectStore(store).get(key);
      rq.onsuccess=e=>res(e.target.result||null);
      rq.onerror=()=>res(null);
    }catch{res(null);}
  });
}

function dbGetAll(store){
  if(!db) return Promise.resolve([]);
  return new Promise(res=>{
    try{
      const tx=db.transaction(store,'readonly');
      const rq=tx.objectStore(store).getAll();
      rq.onsuccess=e=>res(e.target.result||[]);
      rq.onerror=()=>res([]);
    }catch{res([]);}
  });
}

function dbDel(store,key){
  if(!db) return Promise.resolve();
  return new Promise(res=>{
    try{
      const tx=db.transaction(store,'readwrite');
      tx.objectStore(store).delete(key);
      tx.oncomplete=()=>res();
      tx.onerror=()=>res();
    }catch{res();}
  });
}

function dbClear(store){
  if(!db) return Promise.resolve();
  return new Promise(res=>{
    try{
      const tx=db.transaction(store,'readwrite');
      tx.objectStore(store).clear();
      tx.oncomplete=()=>res();
      tx.onerror=()=>res();
    }catch{res();}
  });
}

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
let tracks   = [];
let queue    = [];
let ci       = -1;
let playing  = false;
let shuf     = false;
let rep      = 0;
let vol      = 0.85;
let spd      = 1;
let libView  = 'list';
let libSort  = 'title';
let libVT    = 'all';
let libQ     = '';
let sortIdx  = 0;
let debTimer = null;
let seekDrag = false;
let ctxTr    = null;
let modalMode= '';
let modalX   = null;
let sleepTO  = null;
let sleepIv  = null;
let specRaf  = null;
let specVals = [];

// LocalStorage yardƒ±mcƒ±larƒ±
function lsGet(k){try{return localStorage.getItem(k);}catch{return null;}}
function lsSet(k,v){try{localStorage.setItem(k,v);}catch{}}

let favs   = new Set(JSON.parse(lsGet('mb4_favs')  ||'[]'));
let pls    = JSON.parse(lsGet('mb4_pls')            ||'[]');
let cfg    = JSON.parse(lsGet('mb4_cfg')            ||'{}');
let hist   = JSON.parse(lsGet('mb4_hist')           ||'[]');
let pcnt   = JSON.parse(lsGet('mb4_pcnt')           ||'{}');

cfg = {autoplay:true, spectrum:true, dynbg:true, ...cfg};

// Blob URL map (bellek y√∂netimi)
let blobUrls  = {}; // id ‚Üí audio url
let coverUrls = {}; // id ‚Üí cover url

const aud = document.getElementById('aud');
aud.volume = vol;

/* ‚îÄ‚îÄ‚îÄ iOS ARKA PLAN ‚îÄ‚îÄ‚îÄ */
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    lsSet('mb4_bgPlay', playing?'1':'0');
    lsSet('mb4_bgTime', String(aud.currentTime));
  } else {
    if(playing && aud.paused && aud.src)
      setTimeout(()=>aud.play().catch(()=>{}), 300);
    startSpec();
  }
});
window.addEventListener('pageshow', e=>{
  if(e.persisted && playing && aud.paused && aud.src)
    setTimeout(()=>aud.play().catch(()=>{}), 400);
});
window.addEventListener('focus',()=>{
  if(playing && aud.paused && aud.src)
    setTimeout(()=>aud.play().catch(()=>{}), 300);
});

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
function goTab(id,el){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('pg-'+id).classList.add('on');
  if(el) el.classList.add('on');
  if(id==='pl')  renderPls();
  if(id==='cfg') renderCfg();
}

/* ‚îÄ‚îÄ‚îÄ DOSYA SE√áƒ∞Mƒ∞ (iOS i√ßin en g√ºvenilir y√∂ntem) ‚îÄ‚îÄ‚îÄ */
function onFilesSelected(inp){
  const files = Array.from(inp.files||[]);
  if(!files.length){ showToast('‚ö†Ô∏è Dosya se√ßilmedi'); return; }
  processFiles(files, false);
  // Input'u sƒ±fƒ±rla ‚Äî aynƒ± dosyalar tekrar se√ßilebilsin
  inp.value = '';
}

function onAddFiles(inp){
  const files = Array.from(inp.files||[]);
  if(!files.length) return;
  processFiles(files, true); // true = mevcut listeye ekle
  inp.value = '';
}

async function processFiles(files, append){
  showScanUI(true);

  if(!append){
    // √ñnceki blob URL'leri temizle
    freeBlobs();
    tracks = [];
    await dbClear('blobs');
    await dbClear('meta');
  }

  const total = files.length;
  for(let i=0; i<files.length; i++){
    const file = files[i];
    try{
      setScanTxt(`${i+1}/${total}: ${file.name.substring(0,25)}`);

      const id  = 'tr_'+Date.now().toString(36)+'_'+Math.random().toString(36).substr(2,5);
      const ext = (file.name.split('.').pop()||'mp3').toLowerCase();

      // ID3 parse ‚Äî ilk 128KB
      const hdr  = await readSlice(file, 128*1024);
      const tags = parseID3(hdr);

      // Audio blob URL
      const ab      = await file.arrayBuffer();
      const blob    = new Blob([ab], {type: file.type || 'audio/mpeg'});
      const blobUrl = URL.createObjectURL(blob);
      blobUrls[id]  = blobUrl;

      // Kapak
      let covUrl = null;
      if(tags.coverBlob){
        covUrl = URL.createObjectURL(tags.coverBlob);
        coverUrls[id] = covUrl;
      }

      // S√ºre
      let dur = 0;
      try{ dur = await getDur(blobUrl); }catch{}

      const meta = {
        id, name:file.name,
        format: ext.toUpperCase(),
        title:  tags.title  || cleanName(file.name),
        artist: tags.artist || 'Bilinmeyen Sanat√ßƒ±',
        album:  tags.album  || 'Bilinmeyen Alb√ºm',
        genre:  tags.genre  || '',
        year:   tags.year   || '',
        dur, hasCover:!!tags.coverBlob,
        plays: pcnt[file.name]||0,
      };

      // IndexedDB'ye kaydet (15MB altƒ±)
      if(file.size < 15*1024*1024){
        await dbPut('blobs', {id, data:blob});
      }
      if(tags.coverBlob){
        await dbPut('blobs', {id:id+'_c', data:tags.coverBlob});
      }
      await dbPut('meta', meta);

      tracks.push({...meta, url:blobUrl, cover:covUrl});

    }catch(e){ console.warn(e); }
  }

  showScanUI(false);
  afterLoad();
}

function readSlice(file, bytes){
  return file.slice(0, Math.min(bytes, file.size)).arrayBuffer();
}

function getDur(url){
  return new Promise((res,rej)=>{
    const a = new Audio();
    a.addEventListener('loadedmetadata',()=>{ res(a.duration||0); a.src=''; },{once:true});
    a.addEventListener('error',()=>{ a.src=''; rej(); },{once:true});
    a.preload='metadata'; a.src=url;
  });
}

function freeBlobs(){
  Object.values(blobUrls).forEach(u=>{ try{URL.revokeObjectURL(u);}catch{} });
  Object.values(coverUrls).forEach(u=>{ try{URL.revokeObjectURL(u);}catch{} });
  blobUrls={}; coverUrls={};
}

function cleanName(fn){ return fn.replace(/\.[^/.]+$/,'').replace(/[_\-]+/g,' ').trim(); }

/* ‚îÄ‚îÄ‚îÄ RESTORE ‚îÄ‚îÄ‚îÄ */
async function checkRestore(){
  try{
    const metas = await dbGetAll('meta');
    if(!metas.length) return;
    document.getElementById('rBanTitle').textContent = `${metas.length} ≈üarkƒ± kaydedilmi≈ü`;
    document.getElementById('rBan').classList.add('show');
    document.getElementById('cachedCnt').textContent = metas.length+'';
  }catch{}
}

async function doRestore(){
  document.getElementById('rBan').classList.remove('show');
  showScanUI(true);
  freeBlobs();
  tracks=[];

  const metas = await dbGetAll('meta');
  for(let i=0;i<metas.length;i++){
    const m = metas[i];
    setScanTxt(`${i+1}/${metas.length} y√ºkleniyor...`);
    try{
      const stored = await dbGet('blobs',m.id);
      if(!stored?.data) continue;
      const url = URL.createObjectURL(stored.data);
      blobUrls[m.id] = url;

      let covUrl=null;
      if(m.hasCover){
        const cs = await dbGet('blobs',m.id+'_c');
        if(cs?.data){ covUrl=URL.createObjectURL(cs.data); coverUrls[m.id]=covUrl; }
      }
      tracks.push({...m, url, cover:covUrl});
    }catch{}
  }

  showScanUI(false);
  afterLoad();
  showToast(`‚úÖ ${tracks.length} ≈üarkƒ± y√ºklendi`);
}

/* ‚îÄ‚îÄ‚îÄ ID3 PARSER ‚îÄ‚îÄ‚îÄ */
function parseID3(buf){
  const tags={title:'',artist:'',album:'',genre:'',year:'',coverBlob:null};
  if(!buf||buf.byteLength<10) return tags;
  const dv=new DataView(buf);
  if(String.fromCharCode(dv.getUint8(0),dv.getUint8(1),dv.getUint8(2))!=='ID3') return tags;
  const ver  = dv.getUint8(3);
  const size = ((dv.getUint8(6)&0x7f)<<21)|((dv.getUint8(7)&0x7f)<<14)|
               ((dv.getUint8(8)&0x7f)<<7)|(dv.getUint8(9)&0x7f);
  let off=10, end=Math.min(10+size,buf.byteLength);

  while(off<end-10){
    const fid=String.fromCharCode(dv.getUint8(off),dv.getUint8(off+1),dv.getUint8(off+2),dv.getUint8(off+3));
    if(!/^[A-Z0-9]{4}$/.test(fid)) break;
    const fs = ver>=4
      ? ((dv.getUint8(off+4)&0x7f)<<21)|((dv.getUint8(off+5)&0x7f)<<14)|((dv.getUint8(off+6)&0x7f)<<7)|(dv.getUint8(off+7)&0x7f)
      : (dv.getUint8(off+4)<<24)|(dv.getUint8(off+5)<<16)|(dv.getUint8(off+6)<<8)|dv.getUint8(off+7);
    if(fs<=0||fs>buf.byteLength) break;
    const ds=off+10, de=Math.min(ds+fs,buf.byteLength);
    try{
      if(fid==='TIT2') tags.title  = readTxt(buf,ds,de);
      if(fid==='TPE1') tags.artist = readTxt(buf,ds,de);
      if(fid==='TALB') tags.album  = readTxt(buf,ds,de);
      if(fid==='TCON') tags.genre  = gParse(readTxt(buf,ds,de));
      if(fid==='TDRC'||fid==='TYER') tags.year = readTxt(buf,ds,de).substring(0,4);
      if(fid==='APIC') tags.coverBlob = readCover(buf,ds,de);
    }catch{}
    off=de;
  }
  return tags;
}

function readTxt(buf,s,e){
  const enc=new DataView(buf).getUint8(s);
  const b=new Uint8Array(buf,s+1,Math.max(0,e-s-1));
  try{
    if(enc===0) return new TextDecoder('iso-8859-1').decode(b).replace(/\0/g,'').trim();
    if(enc===1||enc===2) return new TextDecoder('utf-16').decode(b).replace(/\0/g,'').trim();
    return new TextDecoder('utf-8').decode(b).replace(/\0/g,'').trim();
  }catch{ return new TextDecoder('utf-8',{fatal:false}).decode(b).replace(/\0/g,'').trim(); }
}

function readCover(buf,s,e){
  try{
    const dv=new DataView(buf);
    let off=s+1;
    let mime='';
    while(off<e&&dv.getUint8(off)!==0){mime+=String.fromCharCode(dv.getUint8(off++));}
    off++; off++; // null + pic type
    while(off<e&&dv.getUint8(off)!==0)off++;
    off++;
    if(off>=e)return null;
    const mt=mime.toLowerCase().includes('png')?'image/png':'image/jpeg';
    return new Blob([new Uint8Array(buf,off,e-off)],{type:mt});
  }catch{return null;}
}

const GNRS=['Blues','Classic Rock','Country','Dance','Disco','Funk','Grunge','Hip-Hop',
  'Jazz','Metal','New Age','Oldies','Other','Pop','R&B','Rap','Reggae','Rock','Techno',
  'Industrial','Alternative','Ska','Death Metal','Pranks','Soundtrack'];
function gParse(g){if(!g)return'';const m=g.match(/^\((\d+)\)/);if(m)return GNRS[+m[1]]||g;return g;}

/* ‚îÄ‚îÄ‚îÄ AFTER LOAD ‚îÄ‚îÄ‚îÄ */
function afterLoad(){
  if(!tracks.length){
    showScanUI(false);
    showToast('‚ö†Ô∏è Ses dosyasƒ± bulunamadƒ±');
    return;
  }
  queue=[...tracks]; ci=-1;
  document.getElementById('welcomeArea').style.display='none';
  document.getElementById('libArea').style.display='block';
  document.getElementById('cachedCnt').textContent=tracks.length+'';
  updBadge(); renderLib(); renderPls(); renderStats();
  showToast(`‚úÖ ${tracks.length} ≈üarkƒ± y√ºklendi`);
  if(cfg.autoplay){ queue=[...tracks]; ci=0; playIdx(0); }
}

function showScanUI(v){
  document.getElementById('scanLdg').classList.toggle('show',v);
  if(v){
    document.getElementById('welcomeArea').style.display='none';
    document.getElementById('libArea').style.display='block';
    document.getElementById('trackCont').innerHTML='';
  }
}
function setScanTxt(t){ document.getElementById('scanTxt').textContent=t; }

/* ‚îÄ‚îÄ‚îÄ Kƒ∞TAPLIK ‚îÄ‚îÄ‚îÄ */
const SORTS=['title','artist','album','dur','plays'];
const SLBLS={title:'A-Z',artist:'Sanat√ßƒ±',album:'Alb√ºm',dur:'S√ºre',plays:'√áalma'};

function setVT(el,vt){
  document.querySelectorAll('.vt').forEach(v=>v.classList.remove('on'));
  el.classList.add('on'); libVT=vt; renderLib();
}
function debFilter(v){ clearTimeout(debTimer); debTimer=setTimeout(()=>{libQ=v.toLowerCase().trim();renderLib();},220); }
function cycleSort(){ sortIdx=(sortIdx+1)%SORTS.length; libSort=SORTS[sortIdx]; document.getElementById('sortLbl').textContent=SLBLS[libSort]; renderLib(); }
function cycleView(){ libView=libView==='list'?'grid':'list'; renderLib(); }

function getFiltered(){
  let L=[...tracks];
  if(libVT==='fav')    L=L.filter(t=>favs.has(t.id));
  if(libVT==='recent'){
    const seen=new Set();
    L=hist.map(id=>tracks.find(t=>t.id===id)).filter(t=>{if(!t||seen.has(t.id))return false;seen.add(t.id);return true;}).slice(0,60);
  }
  if(libQ) L=L.filter(t=>t.title.toLowerCase().includes(libQ)||t.artist.toLowerCase().includes(libQ)||t.album.toLowerCase().includes(libQ));
  if(libVT!=='recent'){
    L.sort((a,b)=>{
      if(libSort==='artist')  return a.artist.localeCompare(b.artist);
      if(libSort==='album')   return a.album.localeCompare(b.album);
      if(libSort==='dur')     return a.dur-b.dur;
      if(libSort==='plays')   return (b.plays||0)-(a.plays||0);
      return a.title.localeCompare(b.title);
    });
  }
  return L;
}

function renderLib(){
  if(!tracks.length) return;
  const L=getFiltered();
  if(['artist','album','genre'].includes(libVT)){renderGrp(L,libVT);return;}
  const cont=document.getElementById('trackCont');
  if(!L.length){
    cont.innerHTML=`<div class="empty"><span class="e-ico">üîç</span><div class="e-tit">Sonu√ß Yok</div></div>`;
    return;
  }
  if(libView==='grid'){
    cont.innerHTML='<div class="grid-v">'+L.map((t,i)=>gcCard(t,i)).join('')+'</div>';
  } else {
    cont.innerHTML=L.map((t,i)=>tcCard(t,i)).join('');
  }
}

function renderGrp(L,key){
  const G={};
  L.forEach(t=>{ const k=t[key]||'Bilinmeyen'; (G[k]=G[k]||[]).push(t); });
  const keys=Object.keys(G).sort();
  const cont=document.getElementById('trackCont');
  if(!keys.length){cont.innerHTML=`<div class="empty"><span class="e-ico">üì≠</span><div class="e-tit">Bo≈ü</div></div>`;return;}
  cont.innerHTML='<div class="grp-grid">'+keys.map(k=>{
    const cov=G[k].find(t=>t.cover)?.cover;
    const ico=key==='artist'?'üë§':key==='album'?'üíø':'üé∏';
    // data attribute ile injection √∂nlendi
    return `<div class="grp-item" data-key="${safeAttr(key)}" data-val="${safeAttr(k)}" onclick="grpClick(this)">
      <span class="grp-ico">${cov?`<img src="${safeAttr(cov)}" style="width:32px;height:32px;border-radius:7px;object-fit:cover">`:ico}</span>
      <div class="grp-name">${esc(k)}</div>
      <div class="grp-cnt">${G[k].length} ≈üarkƒ±</div>
    </div>`;
  }).join('')+'</div>';
}

function grpClick(el){
  const key=el.dataset.key, val=el.dataset.val;
  const L=tracks.filter(t=>(t[key]||'Bilinmeyen')===val);
  if(!L.length)return;
  queue=[...L]; ci=0; playIdx(0);
  goTab('player',document.querySelectorAll('.tab')[1]);
}

function tcCard(tr,i){
  const cur=queue[ci]?.id===tr.id;
  const fon=favs.has(tr.id);
  const fc=tr.format==='MP3'?'rgba(139,92,246,.13);color:var(--p2)':tr.format==='FLAC'?'rgba(16,185,129,.13);color:var(--g)':tr.format==='WAV'?'rgba(245,158,11,.13);color:var(--o)':'rgba(59,130,246,.13);color:var(--b)';
  // onclick i√ßin g√ºvenli data attribute kullanƒ±mƒ±
  return `<div class="tc${cur?' playing':''}" data-idx="${i}" onclick="playFiltered(${i})">
    ${tr.cover?`<img class="tc-art" src="${safeAttr(tr.cover)}" onerror="this.style.display='none';this.nextSibling.style.display='flex'">`:''}
    <div class="tc-ph" style="${tr.cover?'display:none':''}">üéµ</div>
    <div class="tc-info">
      <div class="tc-title">${esc(tr.title)}</div>
      <div class="tc-artist">${esc(tr.artist)}</div>
      <div class="tc-meta">
        <span class="tc-dur">${fmt(tr.dur)}</span>
        <span class="tc-fmt" style="background:${fc}">${tr.format}</span>
        ${tr.genre?`<span class="tc-fmt" style="background:rgba(255,255,255,.05);color:var(--t2)">${esc(tr.genre)}</span>`:''}
      </div>
    </div>
    <div class="tc-acts" onclick="event.stopPropagation()">
      <button class="ta ta-fav${fon?' on':''}" data-idx="${i}" onclick="favByIdx(${i},this)">${fon?'‚ô•':'‚ô°'}</button>
      <button class="ta ta-more" onclick="openCtx(${i},this)">‚ãØ</button>
    </div>
    ${cur?`<div class="play-ind"><div class="pi${playing?'':' p'}"></div><div class="pi${playing?'':' p'}"></div><div class="pi${playing?'':' p'}"></div></div>`:''}
  </div>`;
}

function gcCard(tr,i){
  const cur=queue[ci]?.id===tr.id;
  return `<div class="gc${cur?' playing':''}" onclick="playFiltered(${i})">
    <div class="gc-art">${tr.cover?`<img src="${safeAttr(tr.cover)}">`:'üéµ'}</div>
    <div class="gc-title">${esc(tr.title)}</div>
    <div class="gc-artist">${esc(tr.artist)}</div>
  </div>`;
}

// Filtered listede index ile √ßal (injection g√ºvenli)
function playFiltered(i){
  const L=getFiltered();
  const tr=L[i];
  if(!tr)return;
  // Queue = t√ºm tracks (filtreye baƒülƒ± deƒüil ‚Äî nextTr/prevTr t√ºm ≈üarkƒ±larda gezsin)
  queue=[...tracks];
  ci=queue.findIndex(t=>t.id===tr.id);
  if(ci<0){queue.push(tr);ci=queue.length-1;}
  playIdx(ci);
  goTab('player',document.querySelectorAll('.tab')[1]);
}

function favByIdx(i,btn){
  const L=getFiltered();
  const tr=L[i];
  if(!tr)return;
  if(favs.has(tr.id)){favs.delete(tr.id);btn.textContent='‚ô°';btn.classList.remove('on');showToast('üíî Kaldƒ±rƒ±ldƒ±');}
  else{favs.add(tr.id);btn.textContent='‚ô•';btn.classList.add('on');showToast('‚ù§Ô∏è Favorilere eklendi');}
  lsSet('mb4_favs',JSON.stringify([...favs]));
  if(queue[ci]?.id===tr.id) refreshFavBtn(tr.id);
}

/* ‚îÄ‚îÄ‚îÄ OYNATMA ‚îÄ‚îÄ‚îÄ */
function playIdx(i){
  if(i<0||i>=queue.length)return;
  ci=i;
  const tr=queue[ci];
  if(!tr?.url){showToast('‚ö†Ô∏è Dosya y√ºklenemedi');return;}

  aud.pause();
  // iOS race condition √∂nlemi
  setTimeout(()=>{
    aud.src=tr.url;
    aud.volume=vol;
    aud.playbackRate=spd;
    aud.load();
    aud.play().then(()=>{
      updPlayerUI(tr);
      updMS(tr);
      logPlay(tr);
      renderLib();
      renderQ();
      startSpec();
    }).catch(e=>{
      console.warn(e);
      showToast('‚ñ∂ Oynatmak i√ßin ekrana dokun');
    });
  },60);
}

function logPlay(tr){
  hist=[tr.id,...hist.filter(id=>id!==tr.id)].slice(0,100);
  lsSet('mb4_hist',JSON.stringify(hist));
  pcnt[tr.name]=(pcnt[tr.name]||0)+1;
  tr.plays=pcnt[tr.name];
  lsSet('mb4_pcnt',JSON.stringify(pcnt));
}

/* ‚îÄ‚îÄ‚îÄ SPECTRUM ‚îÄ‚îÄ‚îÄ */
function buildSpec(){
  const sp=document.getElementById('spectrum');
  sp.innerHTML='';
  for(let i=0;i<36;i++){const b=document.createElement('div');b.className='sp';sp.appendChild(b);}
}

function startSpec(){
  if(specRaf)cancelAnimationFrame(specRaf);
  if(!cfg.spectrum)return;
  const bars=document.querySelectorAll('.sp');
  if(!bars.length)return;
  if(!specVals.length)specVals=Array.from({length:bars.length},()=>Math.random());
  function draw(){
    specRaf=requestAnimationFrame(draw);
    bars.forEach((b,i)=>{
      specVals[i]=Math.max(0,Math.min(1,specVals[i]+(Math.random()-.5)*(playing?.28:.06)));
      b.style.height=(specVals[i]*28+3)+'px';
      b.style.opacity=(.35+specVals[i]*.6).toFixed(2);
    });
  }
  draw();
}

/* ‚îÄ‚îÄ‚îÄ PLAYER UI ‚îÄ‚îÄ‚îÄ */
function updPlayerUI(tr){
  document.getElementById('pTitle').textContent =tr.title;
  document.getElementById('pArtist').textContent=tr.artist;
  document.getElementById('pAlbum').textContent =(tr.album!=='Bilinmeyen Alb√ºm')?tr.album:'';
  const img=document.getElementById('artImg'), emo=document.getElementById('artEmoji');
  if(tr.cover){img.src=tr.cover;img.style.display='block';emo.style.display='none';if(cfg.dynbg)dynBg(tr.cover);}
  else{img.style.display='none';emo.style.display='block';resetDynBg();}
  document.getElementById('mpTitle').textContent =tr.title;
  document.getElementById('mpArtist').textContent=tr.artist;
  const ma=document.getElementById('mpArt');
  ma.innerHTML=tr.cover?`<img src="${safeAttr(tr.cover)}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">`:'üéµ';
  document.getElementById('mini').classList.add('show');
  refreshFavBtn(tr.id);
}

function refreshFavBtn(id){
  const on=favs.has(id);
  document.getElementById('favBtn').innerHTML=`${on?'‚ô•':'‚ô°'}<span>Favori</span>`;
}

function dynBg(url){
  try{
    const img=new Image();img.crossOrigin='anonymous';
    img.onload=()=>{
      const c=document.createElement('canvas');c.width=c.height=6;
      const ctx=c.getContext('2d');ctx.drawImage(img,0,0,6,6);
      const d=ctx.getImageData(0,0,6,6).data;
      let r=0,g=0,b=0,n=0;
      for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];n++;}
      r=Math.round(r/n);g=Math.round(g/n);b=Math.round(b/n);
      document.documentElement.style.setProperty('--p3',`rgb(${r},${g},${b})`);
      document.getElementById('artGlow').style.background=`radial-gradient(circle,rgb(${r},${g},${b}) 0%,transparent 65%)`;
    };
    img.src=url;
  }catch{}
}
function resetDynBg(){
  document.documentElement.style.setProperty('--p3','#6d28d9');
  document.getElementById('artGlow').style.background='radial-gradient(circle,var(--p3) 0%,transparent 65%)';
}

function updPS(v){
  playing=v;
  document.getElementById('ppBtn').textContent=v?'‚è∏':'‚ñ∂';
  document.getElementById('mpPP').textContent=v?'‚è∏':'‚ñ∂';
  document.getElementById('artRing').classList.toggle('show',v);
  document.getElementById('mpBars').classList.toggle('p',!v);
}

/* ‚îÄ‚îÄ‚îÄ AUDIO EVENTS ‚îÄ‚îÄ‚îÄ */
aud.addEventListener('play',  ()=>updPS(true));
aud.addEventListener('pause', ()=>updPS(false));
aud.addEventListener('ended', ()=>{ if(rep===2){aud.currentTime=0;aud.play();return;} nextTr(); });
aud.addEventListener('stalled',()=>{ if(playing)setTimeout(()=>aud.play().catch(()=>{}),800); });
aud.addEventListener('timeupdate',()=>{
  if(!aud.duration||!isFinite(aud.duration)||seekDrag)return;
  const p=aud.currentTime/aud.duration*100;
  document.getElementById('seekFill').style.width=p+'%';
  document.getElementById('mpFill').style.width=p+'%';
  document.getElementById('curTime').textContent=fmt(aud.currentTime);
  document.getElementById('durTime').textContent=fmt(aud.duration);
});
aud.addEventListener('loadedmetadata',()=>{
  if(aud.duration&&isFinite(aud.duration))
    document.getElementById('durTime').textContent=fmt(aud.duration);
});

/* ‚îÄ‚îÄ‚îÄ KONTROLLER ‚îÄ‚îÄ‚îÄ */
function togPP(){
  if(!aud.src&&queue.length){playIdx(Math.max(ci,0));return;}
  if(!aud.src)return;
  playing?aud.pause():aud.play().catch(()=>{});
}
function nextTr(){if(!queue.length)return;playIdx(shuf?Math.floor(Math.random()*queue.length):(ci+1)%queue.length);}
function prevTr(){if(!queue.length)return;if(aud.currentTime>4){aud.currentTime=0;return;}playIdx((ci-1+queue.length)%queue.length);}
function skip(s){if(!aud.duration)return;aud.currentTime=Math.max(0,Math.min(aud.duration,aud.currentTime+s));}
function togShuffle(){shuf=!shuf;document.getElementById('shuffleBtn').classList.toggle('on',shuf);showToast(shuf?'üîÄ Karƒ±≈ütƒ±r a√ßƒ±k':'üîÄ Kapalƒ±');}
function togRepeat(){
  rep=(rep+1)%3;
  const ico=['üîÅ','üîÅ','üîÇ'][rep],lbl=['Tekrar','T√ºm√º','Biri'][rep];
  document.getElementById('repeatBtn').innerHTML=`${ico}<span>${lbl}</span>`;
  document.getElementById('repeatBtn').classList.toggle('on',rep>0);
  showToast(['üîÅ Kapalƒ±','üîÅ T√ºm√ºn√º tekrar','üîÇ Birini tekrar'][rep]);
}
function setSpd(s){spd=s;aud.playbackRate=s;document.getElementById('spdLbl').textContent=s+'x';document.querySelectorAll('.spd-btn').forEach(b=>b.classList.toggle('on',parseFloat(b.textContent)===s));}

/* ‚îÄ‚îÄ‚îÄ SEEK ‚îÄ‚îÄ‚îÄ */
const sw=document.getElementById('seekWrap');
function seekX(e){
  const r=sw.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
  const p=Math.max(0,Math.min(1,x/r.width));
  if(aud.duration&&isFinite(aud.duration))aud.currentTime=p*aud.duration;
}
sw.addEventListener('touchstart',e=>{seekDrag=true;sw.classList.add('drag');seekX(e);},{passive:true});
sw.addEventListener('touchmove', e=>{if(seekDrag)seekX(e);},{passive:true});
sw.addEventListener('touchend',  ()=>{seekDrag=false;sw.classList.remove('drag');});
sw.addEventListener('click',seekX);

function miniSeek(e){
  const r=document.getElementById('mpProg').getBoundingClientRect();
  const p=Math.max(0,Math.min(1,(e.clientX-r.left)/r.width));
  if(aud.duration&&isFinite(aud.duration))aud.currentTime=p*aud.duration;
}

/* ‚îÄ‚îÄ‚îÄ VOLUME ‚îÄ‚îÄ‚îÄ */
const vt=document.getElementById('volTrack');
function setVolX(x){
  const r=vt.getBoundingClientRect();
  vol=Math.max(0,Math.min(1,(x-r.left)/r.width));
  aud.volume=vol;
  document.getElementById('volFill').style.width=(vol*100)+'%';
}
vt.addEventListener('click',e=>setVolX(e.clientX));
vt.addEventListener('touchmove',e=>{e.preventDefault();setVolX(e.touches[0].clientX);},{passive:false});

/* ‚îÄ‚îÄ‚îÄ MEDIA SESSION ‚îÄ‚îÄ‚îÄ */
function updMS(tr){
  if(!('mediaSession'in navigator))return;
  navigator.mediaSession.metadata=new MediaMetadata({
    title:tr.title,artist:tr.artist,album:tr.album,
    artwork:tr.cover?[{src:tr.cover,sizes:'300x300',type:'image/jpeg'}]:[]
  });
  navigator.mediaSession.setActionHandler('play',()=>aud.play().catch(()=>{}));
  navigator.mediaSession.setActionHandler('pause',()=>aud.pause());
  navigator.mediaSession.setActionHandler('nexttrack',()=>nextTr());
  navigator.mediaSession.setActionHandler('previoustrack',()=>prevTr());
  navigator.mediaSession.setActionHandler('seekforward',()=>skip(10));
  navigator.mediaSession.setActionHandler('seekbackward',()=>skip(-10));
  try{navigator.mediaSession.setActionHandler('seekto',e=>{if(e.seekTime&&isFinite(e.seekTime))aud.currentTime=e.seekTime;});}catch{}
}

/* ‚îÄ‚îÄ‚îÄ FAVORƒ∞ ‚îÄ‚îÄ‚îÄ */
function togFavCur(){
  if(ci<0||!queue[ci])return;
  const id=queue[ci].id;
  if(favs.has(id)){favs.delete(id);document.getElementById('favBtn').innerHTML='‚ô°<span>Favori</span>';showToast('üíî Favoriden √ßƒ±karƒ±ldƒ±');}
  else{favs.add(id);document.getElementById('favBtn').innerHTML='‚ô•<span>Favori</span>';showToast('‚ù§Ô∏è Favorilere eklendi');}
  lsSet('mb4_favs',JSON.stringify([...favs]));
}

/* ‚îÄ‚îÄ‚îÄ CTX MENU ‚îÄ‚îÄ‚îÄ */
function openCtx(i,btn){
  const L=getFiltered();
  ctxTr=L[i];
  if(!ctxTr)return;
  const menu=document.getElementById('ctx');
  menu.classList.add('show');
  const r=btn.getBoundingClientRect();
  const top=r.bottom+6+220>window.innerHeight?r.top-220-6:r.bottom+6;
  menu.style.top=Math.max(10,top)+'px';
  menu.style.right='18px';menu.style.left='auto';
  const fon=favs.has(ctxTr.id);
  document.getElementById('ctxFavIco').textContent=fon?'üíî':'‚ù§Ô∏è';
  document.getElementById('ctxFavTxt').textContent=fon?'Favoriden √áƒ±kar':'Favorilere Ekle';
  setTimeout(()=>document.addEventListener('click',ctxOut,{once:true,capture:true}),0);
}
function ctxOut(e){if(!document.getElementById('ctx').contains(e.target))document.getElementById('ctx').classList.remove('show');}
function closeCtx(){document.getElementById('ctx').classList.remove('show');}

function ctxPlay(){
  if(!ctxTr)return;closeCtx();
  queue=[...tracks];ci=queue.findIndex(t=>t.id===ctxTr.id);
  if(ci<0){queue.push(ctxTr);ci=queue.length-1;}
  playIdx(ci);goTab('player',document.querySelectorAll('.tab')[1]);
}
function ctxNext(){
  if(!ctxTr)return;
  queue.splice(Math.max(ci+1,0),0,{...ctxTr});
  showToast('‚è≠ Sƒ±radaki eklendi');renderQ();closeCtx();
}
function ctxQueue(){
  if(!ctxTr)return;
  queue.push({...ctxTr});showToast('üìã Sƒ±raya eklendi');renderQ();closeCtx();
}
function ctxFav(){
  if(!ctxTr)return;
  const id=ctxTr.id,fon=favs.has(id);
  if(fon){favs.delete(id);showToast('üíî Kaldƒ±rƒ±ldƒ±');}
  else{favs.add(id);showToast('‚ù§Ô∏è Eklendi');}
  lsSet('mb4_favs',JSON.stringify([...favs]));
  if(queue[ci]?.id===id)refreshFavBtn(id);
  renderLib();closeCtx();
}
function ctxAddPl(){if(!ctxTr)return;closeCtx();openAddToPl(ctxTr);}
function ctxDel(){
  if(!ctxTr)return;
  tracks=tracks.filter(t=>t.id!==ctxTr.id);
  if(blobUrls[ctxTr.id]){URL.revokeObjectURL(blobUrls[ctxTr.id]);delete blobUrls[ctxTr.id];}
  if(coverUrls[ctxTr.id]){URL.revokeObjectURL(coverUrls[ctxTr.id]);delete coverUrls[ctxTr.id];}
  dbDel('blobs',ctxTr.id);dbDel('blobs',ctxTr.id+'_c');dbDel('meta',ctxTr.id);
  updBadge();renderLib();closeCtx();showToast('üóëÔ∏è Kaldƒ±rƒ±ldƒ±');
}

/* ‚îÄ‚îÄ‚îÄ QUEUE ‚îÄ‚îÄ‚îÄ */
function openQ(){renderQ();document.getElementById('qPan').classList.add('show');}
function closeQ(){document.getElementById('qPan').classList.remove('show');}
function renderQ(){
  const el=document.getElementById('qList');
  if(!queue.length){el.innerHTML=`<div class="empty"><span class="e-ico">üì≠</span><div class="e-tit">Sƒ±ra Bo≈ü</div></div>`;return;}
  el.innerHTML=queue.map((tr,i)=>`
    <div class="qi${i===ci?' active':''}" onclick="playIdx(${i})">
      <div class="qi-num">${i===ci?'‚ñ∂':(i+1)}</div>
      <div class="qi-art">${tr.cover?`<img src="${safeAttr(tr.cover)}">`:'üéµ'}</div>
      <div class="qi-info"><div class="qi-title">${esc(tr.title)}</div><div class="qi-artist">${esc(tr.artist)}</div></div>
      <div class="qi-dur">${fmt(tr.dur)}</div>
      <button class="qi-rm" onclick="event.stopPropagation();rmQ(${i})">‚úï</button>
    </div>`).join('');
}
function rmQ(i){if(i===ci){showToast('‚ö†Ô∏è √áalan ≈üarkƒ± kaldƒ±rƒ±lamaz');return;}queue.splice(i,1);if(i<ci)ci--;renderQ();}
function shuffleQ(){
  if(!queue.length)return;
  const cur=queue[ci];queue.splice(ci,1);
  for(let i=queue.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[queue[i],queue[j]]=[queue[j],queue[i]];}
  queue.unshift(cur);ci=0;renderQ();showToast('üîÄ Karƒ±≈ütƒ±rƒ±ldƒ±');
}
function clearQ(){if(!confirm('Sƒ±rayƒ± temizle?'))return;queue=[];ci=-1;aud.pause();updPS(false);document.getElementById('mini').classList.remove('show');renderQ();closeQ();}

/* ‚îÄ‚îÄ‚îÄ PLAYLƒ∞STLER ‚îÄ‚îÄ‚îÄ */
function renderPls(){
  const sm=[{n:'En √áok √áalƒ±nan',i:'üî•',k:'plays'},{n:'Son √áalƒ±nan',i:'üïê',k:'recent'},{n:'Favoriler',i:'‚ù§Ô∏è',k:'fav'},{n:'T√ºm√º',i:'üéµ',k:'all'}];
  document.getElementById('smartPls').innerHTML=sm.map(s=>`
    <div class="pl-card smart-pl" onclick="playSmPl('${s.k}')">
      <div class="pl-art">${s.i}</div>
      <div class="pl-info"><div class="pl-name">${s.n}</div><div class="pl-cnt">${smCnt(s.k)} ≈üarkƒ±</div></div>
      <div class="pl-acts"><button class="pa pa-play" onclick="event.stopPropagation();playSmPl('${s.k}')">‚ñ∂</button></div>
    </div>`).join('');
  const md=document.getElementById('manPls');
  if(!pls.length){md.innerHTML=`<div class="empty"><span class="e-ico">üìã</span><div class="e-tit">Liste Yok</div><div class="e-sub">+ Yeni ile olu≈ütur</div></div>`;return;}
  md.innerHTML=pls.map((pl,i)=>`
    <div class="pl-card" onclick="playPl(${i})">
      <div class="pl-art">${pl.ico||'üìã'}</div>
      <div class="pl-info"><div class="pl-name">${esc(pl.name)}</div><div class="pl-cnt">${pl.tracks.length} ≈üarkƒ±</div></div>
      <div class="pl-acts">
        <button class="pa pa-play" onclick="event.stopPropagation();playPl(${i})">‚ñ∂</button>
        <button class="pa pa-del"  onclick="event.stopPropagation();delPl(${i})">üóë</button>
      </div>
    </div>`).join('');
}

function smCnt(k){if(k==='all')return tracks.length;if(k==='fav')return favs.size;if(k==='plays')return Math.min(tracks.length,25);return Math.min(hist.length,25);}
function playSmPl(k){
  let L=[...tracks];
  if(k==='fav')L=L.filter(t=>favs.has(t.id));
  if(k==='plays')L=L.sort((a,b)=>(b.plays||0)-(a.plays||0)).slice(0,25);
  if(k==='recent'){const s=new Set();L=hist.map(id=>tracks.find(t=>t.id===id)).filter(t=>{if(!t||s.has(t.id))return false;s.add(t.id);return true;}).slice(0,25);}
  if(!L.length){showToast('‚ö†Ô∏è Bo≈ü');return;}
  queue=[...L];ci=0;playIdx(0);goTab('player',document.querySelectorAll('.tab')[1]);
}
function playPl(i){
  const pl=pls[i];
  const L=pl.tracks.map(id=>tracks.find(t=>t.id===id)).filter(Boolean);
  if(!L.length){showToast('‚ö†Ô∏è Bo≈ü');return;}
  queue=[...L];ci=0;playIdx(0);goTab('player',document.querySelectorAll('.tab')[1]);
}
function delPl(i){if(!confirm('Sil?'))return;pls.splice(i,1);savePls();renderPls();}
function openCreatePl(){modalMode='create';modalX=null;document.getElementById('modalTtl').textContent='‚ú® Yeni Playlist';document.getElementById('modalInp').value='';document.getElementById('modalOv').classList.add('show');setTimeout(()=>document.getElementById('modalInp').focus(),320);}
function openAddToPl(tr){modalMode='add';modalX=tr;document.getElementById('modalTtl').textContent='‚ûï Playliste Ekle';document.getElementById('modalInp').value='';document.getElementById('modalOv').classList.add('show');setTimeout(()=>document.getElementById('modalInp').focus(),320);}
document.getElementById('modalOv').addEventListener('click',e=>{if(e.target===document.getElementById('modalOv'))closeModal();});
function closeModal(){document.getElementById('modalOv').classList.remove('show');}
function modalOk(){
  const name=document.getElementById('modalInp').value.trim();
  if(!name){showToast('‚ö†Ô∏è ƒ∞sim gir');return;}
  if(modalMode==='create'){pls.push({name,ico:'üìã',tracks:[]});savePls();renderPls();showToast('‚úÖ Olu≈üturuldu');}
  else if(modalMode==='add'&&modalX){
    let pl=pls.find(p=>p.name.toLowerCase()===name.toLowerCase());
    if(!pl){pl={name,ico:'üìã',tracks:[]};pls.push(pl);}
    if(!pl.tracks.includes(modalX.id)){pl.tracks.push(modalX.id);savePls();showToast(`‚úÖ "${esc(pl.name)}"e eklendi`);}
    else showToast('‚ö†Ô∏è Zaten listede');
  }
  closeModal();
}
function savePls(){lsSet('mb4_pls',JSON.stringify(pls));}

/* ‚îÄ‚îÄ‚îÄ EQ ‚îÄ‚îÄ‚îÄ */
const EQP={Normal:[0,0,0,0,0],Pop:[2,-1,0,2,3],Rock:[4,2,-1,2,4],Jazz:[2,2,0,-1,-2],Klasik:[3,1,0,1,2],Bass:[6,4,0,-1,-2],Vocal:[-2,0,3,3,1],Elektronik:[4,2,0,2,4]};
const EQL=['Bass','Low-Mid','Mid','Hi-Mid','Treble'];

function buildEQ(){
  document.getElementById('eqPresets').innerHTML=Object.keys(EQP).map(n=>`<div class="eq-pr${n==='Normal'?' on':''}" onclick="applyEQ('${n}',this)">${n}</div>`).join('');
  document.getElementById('eqBands').innerHTML=['60','250','1k','4k','16k'].map((_,i)=>`<div class="eq-band"><input class="eq-sl" type="range" min="-12" max="12" value="0" step="0.5"><div class="eq-lbl">${EQL[i]}</div></div>`).join('');
}

function applyEQ(name,el){
  document.querySelectorAll('.eq-pr').forEach(p=>p.classList.remove('on'));
  (el||document.querySelector('.eq-pr'))?.classList.add('on');
  const vals=EQP[name]||[0,0,0,0,0];
  document.querySelectorAll('.eq-sl').forEach((s,i)=>{if(vals[i]!==undefined)s.value=vals[i];});
}

function togEQ(){const p=document.getElementById('eqPanel');p.classList.toggle('show');document.getElementById('eqBtn').classList.toggle('on',p.classList.contains('show'));}

/* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
function renderCfg(){
  ['autoplay','spectrum','dynbg'].forEach(k=>{
    const el=document.getElementById('tog-'+k);
    if(el)el.classList.toggle('on',!!cfg[k]);
  });
  const themes=[{n:'Mor',c:'#8b5cf6',c2:'#6d28d9'},{n:'Mavi',c:'#3b82f6',c2:'#1d4ed8'},{n:'Ye≈üil',c:'#10b981',c2:'#065f46'},{n:'Pembe',c:'#ec4899',c2:'#9d174d'},{n:'Turuncu',c:'#f59e0b',c2:'#b45309'},{n:'Kƒ±rmƒ±zƒ±',c:'#ef4444',c2:'#991b1b'}];
  const cur=cfg.theme||'#8b5cf6';
  document.getElementById('themeColors').innerHTML=themes.map(t=>`<div class="thm-c${t.c===cur?' on':''}" style="background:linear-gradient(135deg,${t.c},${t.c2})" onclick="setTheme('${t.c}','${t.c2}','${t.n}',this)" title="${t.n}"></div>`).join('');
  renderStats();
}
function togCfg(k){cfg[k]=!cfg[k];const el=document.getElementById('tog-'+k);if(el)el.classList.toggle('on',cfg[k]);lsSet('mb4_cfg',JSON.stringify(cfg));showToast(cfg[k]?`‚úÖ ${k} a√ßƒ±k`:`‚ùå ${k} kapalƒ±`);}
function setTheme(c,c2,n,el){document.querySelectorAll('.thm-c').forEach(t=>t.classList.remove('on'));el.classList.add('on');document.documentElement.style.setProperty('--p',c);document.documentElement.style.setProperty('--p2',c);document.documentElement.style.setProperty('--p3',c2);cfg.theme=c;cfg.theme2=c2;lsSet('mb4_cfg',JSON.stringify(cfg));showToast('üé® '+n);}
function renderStats(){
  const tm=Math.round(tracks.reduce((a,t)=>a+(t.dur||0),0)/60);
  const ar=new Set(tracks.map(t=>t.artist)).size;
  const al=new Set(tracks.map(t=>t.album)).size;
  const tp=Object.values(pcnt).reduce((a,b)=>a+b,0);
  document.getElementById('statGrid').innerHTML=`
    <div class="stat-i"><div class="stat-n">${tracks.length}</div><div class="stat-l">≈ûarkƒ±</div></div>
    <div class="stat-i"><div class="stat-n">${tm}</div><div class="stat-l">Dakika</div></div>
    <div class="stat-i"><div class="stat-n">${ar}</div><div class="stat-l">Sanat√ßƒ±</div></div>
    <div class="stat-i"><div class="stat-n">${al}</div><div class="stat-l">Alb√ºm</div></div>
    <div class="stat-i"><div class="stat-n">${favs.size}</div><div class="stat-l">Favori</div></div>
    <div class="stat-i"><div class="stat-n">${tp}</div><div class="stat-l">Oynatma</div></div>`;
}

/* ‚îÄ‚îÄ‚îÄ SLEEP ‚îÄ‚îÄ‚îÄ */
function setSleep(min,el){
  if(sleepTO)clearTimeout(sleepTO);if(sleepIv)clearInterval(sleepIv);sleepTO=null;sleepIv=null;
  document.querySelectorAll('.slp-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  if(!min){document.getElementById('sleepDisp').textContent='‚Äî';showToast('üò¥ Kapalƒ±');return;}
  const end=Date.now()+min*60000;
  sleepTO=setTimeout(()=>{aud.pause();updPS(false);showToast('üò¥ Uyku devreye girdi');},min*60000);
  sleepIv=setInterval(()=>{const r=end-Date.now();if(r<=0){clearInterval(sleepIv);document.getElementById('sleepDisp').textContent='‚Äî';return;}document.getElementById('sleepDisp').textContent=`${Math.floor(r/60000)}:${Math.floor((r%60000)/1000).toString().padStart(2,'0')}`;},1000);
  showToast(`üò¥ ${min} dk sonra kapanƒ±r`);
}

/* ‚îÄ‚îÄ‚îÄ PWA ‚îÄ‚îÄ‚îÄ */
function hidePWA(){document.getElementById('pwaBan').style.display='none';lsSet('mb4_pwa','1');}

/* ‚îÄ‚îÄ‚îÄ GENEL ‚îÄ‚îÄ‚îÄ */
function updBadge(){document.getElementById('badge').textContent=tracks.length;}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2700);
}

function fmt(s){if(!s||isNaN(s)||!isFinite(s))return'0:00';return`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;}

// XSS g√ºvenliƒüi
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function safeAttr(s){if(!s)return'';return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

function clearAll(){
  if(!confirm('T√ºm veriler ve kayƒ±tlƒ± m√ºzikler silinsin mi?'))return;
  freeBlobs();dbClear('blobs');dbClear('meta');localStorage.clear();
  tracks=[];queue=[];ci=-1;favs=new Set();pls=[];hist=[];pcnt={};
  aud.pause();aud.src='';updPS(false);updBadge();
  document.getElementById('mini').classList.remove('show');
  document.getElementById('libArea').style.display='none';
  document.getElementById('welcomeArea').style.display='block';
  showToast('üóëÔ∏è Temizlendi');
}

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
async function init(){
  await openDB();
  if(cfg.theme){
    document.documentElement.style.setProperty('--p',cfg.theme);
    document.documentElement.style.setProperty('--p2',cfg.theme);
    document.documentElement.style.setProperty('--p3',cfg.theme2||cfg.theme);
  }
  buildSpec();startSpec();
  buildEQ();
  document.getElementById('volFill').style.width=(vol*100)+'%';
  const isPWA=window.navigator.standalone||window.matchMedia('(display-mode:standalone)').matches;
  if(isPWA||lsGet('mb4_pwa'))document.getElementById('pwaBan').style.display='none';
  await checkRestore();
}

init();
</script>
</body>
</html>
