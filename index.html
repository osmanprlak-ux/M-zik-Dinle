<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üéµ M√ºzikBox</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
:root{
  --p:#8b5cf6;--p2:#a78bfa;--p3:#6d28d9;
  --g:#10b981;--r:#ef4444;--o:#f59e0b;--b:#3b82f6;
  --dark:#07071a;--c1:#0f0f24;--c2:#161632;--c3:#1e1e40;
  --t:#fff;--t2:#7070a0;--bd:rgba(255,255,255,0.07)
}
html,body{height:100%;overflow:hidden}
body{background:var(--dark);color:var(--t);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;display:flex;flex-direction:column}

/* GLOW BG */
.glow{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.glow::before{content:'';position:absolute;width:500px;height:500px;background:radial-gradient(circle,rgba(139,92,246,.12) 0%,transparent 65%);top:-150px;left:-150px;animation:gm 10s ease-in-out infinite alternate}
.glow::after{content:'';position:absolute;width:400px;height:400px;background:radial-gradient(circle,rgba(16,185,129,.07) 0%,transparent 65%);bottom:-80px;right:-80px;animation:gm 13s ease-in-out infinite alternate-reverse}
@keyframes gm{to{transform:translate(50px,30px)}}

/* APP SHELL */
.shell{position:relative;z-index:1;max-width:430px;margin:0 auto;width:100%;height:100%;display:flex;flex-direction:column;overflow:hidden}

/* TOP NAV */
.nav{flex-shrink:0;padding:50px 18px 10px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:9px}
.brand-ico{width:38px;height:38px;background:linear-gradient(135deg,var(--p3),var(--b));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;box-shadow:0 0 20px rgba(139,92,246,.4)}
.brand-txt{font-size:20px;font-weight:800;letter-spacing:-.4px}
.brand-txt span{color:var(--p2)}
.nav-right{display:flex;align-items:center;gap:8px}
.lib-count{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff;font-size:11px;font-weight:800;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center}

/* TABS */
.tabs{flex-shrink:0;display:flex;gap:5px;padding:8px 18px 12px}
.tab{flex:1;padding:9px 4px;background:var(--c1);border:1px solid var(--bd);border-radius:13px;color:var(--t2);font-size:10px;font-weight:800;cursor:pointer;text-align:center;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:3px}
.tab i{font-size:18px;font-style:normal}
.tab.on{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff;border-color:transparent;box-shadow:0 4px 18px rgba(139,92,246,.35)}

/* SCROLL AREA */
.pages{flex:1;overflow:hidden;position:relative}
.pg{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;padding:0 18px 200px;display:none;-webkit-overflow-scrolling:touch}
.pg::-webkit-scrollbar{display:none}
.pg.on{display:block}

/* ========== SEARCH PAGE ========== */
.sbox{position:relative;margin-bottom:12px;margin-top:4px}
.sinp{width:100%;padding:14px 52px 14px 44px;background:var(--c1);border:1.5px solid var(--bd);border-radius:16px;color:var(--t);font-size:16px;outline:none;-webkit-appearance:none;transition:border .2s;font-family:inherit}
.sinp:focus{border-color:var(--p)}
.sinp::placeholder{color:var(--t2)}
.sico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:17px;pointer-events:none}
.sbtn{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:40px;height:40px;background:linear-gradient(135deg,var(--p3),var(--p));border:none;border-radius:11px;color:#fff;font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sbtn:active{transform:translateY(-50%) scale(.9)}

/* SOURCE CHIPS */
.chips{display:flex;gap:7px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;margin-bottom:14px}
.chips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;padding:7px 13px;background:var(--c1);border:1.5px solid var(--bd);border-radius:18px;color:var(--t2);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.chip.on{background:rgba(139,92,246,.16);border-color:var(--p);color:var(--p2)}
.chip:active{transform:scale(.93)}

/* SECTION LABEL */
.slbl{font-size:11px;font-weight:800;color:var(--t2);text-transform:uppercase;letter-spacing:1.1px;margin:14px 0 10px;display:flex;align-items:center;gap:8px}
.slbl::after{content:'';flex:1;height:1px;background:var(--bd)}

/* TRACK CARD */
.tc{background:var(--c1);border:1px solid var(--bd);border-radius:16px;padding:11px;display:flex;align-items:center;gap:11px;margin-bottom:9px;transition:all .18s;position:relative;overflow:hidden}
.tc.playing{border-color:var(--p);background:rgba(139,92,246,.08)}
.tc:active{transform:scale(.985)}
.tc-art{width:52px;height:52px;border-radius:11px;object-fit:cover;flex-shrink:0;background:var(--c3)}
.tc-ph{width:52px;height:52px;border-radius:11px;background:linear-gradient(135deg,var(--p3),var(--b));display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;position:relative}
.tc-ph.spin{animation:ph-spin 3s linear infinite}
@keyframes ph-spin{0%,100%{border-radius:11px}50%{border-radius:50%}}
.tc-info{flex:1;min-width:0}
.tc-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.tc-artist{font-size:12px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}
.tc-meta{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.tc-dur{font-size:11px;color:var(--t2);background:var(--c3);padding:2px 7px;border-radius:6px}
.tc-src{font-size:10px;font-weight:800;padding:2px 7px;border-radius:6px}
.tc-acts{display:flex;flex-direction:column;gap:6px;flex-shrink:0}
.tca{width:32px;height:32px;border:none;border-radius:9px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.tca:active{transform:scale(.87)}
.tca-play{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff}
.tca-fav{background:rgba(239,68,68,.14);color:var(--r)}
.tca-dl{background:rgba(16,185,129,.14);color:var(--g)}

/* DL PROGRESS ON CARD */
.dl-prog{position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(255,255,255,.05)}
.dl-prog-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--g));width:0%;transition:width .3s;border-radius:2px}

/* TRENDING */
.trend-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.trend-item{background:var(--c1);border:1px solid var(--bd);border-radius:13px;padding:11px;display:flex;align-items:center;gap:9px;cursor:pointer;transition:all .2s}
.trend-item:active{background:var(--c2);transform:scale(.95)}
.ti-emo{font-size:20px}
.ti-name{font-size:13px;font-weight:700}
.ti-g{font-size:11px;color:var(--t2)}

/* LOADING */
.ldg{display:none;text-align:center;padding:44px 0}
.ldg.show{display:block}
.spin-c{width:40px;height:40px;border:3px solid rgba(139,92,246,.17);border-top-color:var(--p);border-radius:50%;animation:sp .65s linear infinite;margin:0 auto 12px}
@keyframes sp{to{transform:rotate(360deg)}}
.ldg-txt{color:var(--t2);font-size:13px}

/* ========== PLAYER PAGE ========== */
.big-player{display:flex;flex-direction:column;align-items:center;padding-top:10px}
.bp-art-wrap{position:relative;width:240px;height:240px;margin:0 auto 28px}
.bp-art{width:240px;height:240px;border-radius:28px;background:linear-gradient(135deg,var(--p3),var(--b));display:flex;align-items:center;justify-content:center;font-size:80px;box-shadow:0 20px 60px rgba(139,92,246,.35);overflow:hidden;flex-shrink:0}
.bp-art img{width:100%;height:100%;object-fit:cover}
.bp-art.playing{animation:art-pulse 2s ease-in-out infinite}
@keyframes art-pulse{0%,100%{box-shadow:0 20px 60px rgba(139,92,246,.35)}50%{box-shadow:0 20px 80px rgba(139,92,246,.6)}}
.bp-art-ring{position:absolute;inset:-8px;border-radius:36px;border:2px solid rgba(139,92,246,.3);animation:ring-spin 8s linear infinite;display:none}
.bp-art-ring.show{display:block}
@keyframes ring-spin{to{transform:rotate(360deg)}}

.bp-title{font-size:20px;font-weight:800;text-align:center;margin-bottom:4px;padding:0 16px}
.bp-artist{font-size:14px;color:var(--t2);text-align:center;margin-bottom:24px}

/* WAVEFORM BARS */
.waveform{display:flex;align-items:flex-end;justify-content:center;gap:3px;height:36px;margin-bottom:20px}
.wv{width:4px;background:linear-gradient(to top,var(--p3),var(--p2));border-radius:3px;opacity:.4;transition:height .1s}
.wv.active{opacity:1}

/* SEEK BAR */
.seekwrap{width:100%;padding:0 4px;margin-bottom:8px;position:relative;cursor:pointer}
.seekbar{height:5px;background:rgba(255,255,255,.1);border-radius:3px;position:relative;overflow:visible}
.seekfill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));border-radius:3px;width:0%;position:relative}
.seekthumb{position:absolute;right:-7px;top:-5px;width:14px;height:14px;background:#fff;border-radius:50%;box-shadow:0 0 8px rgba(139,92,246,.6);display:none}
.seekwrap:hover .seekthumb,.seekwrap:active .seekthumb{display:block}
.seek-times{display:flex;justify-content:space-between;font-size:11px;color:var(--t2);margin-top:6px;padding:0 2px}

/* CONTROLS */
.ctrl-row{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px}
.ctrl-btn{width:48px;height:48px;border:none;background:transparent;color:var(--t);font-size:22px;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s}
.ctrl-btn:active{background:rgba(255,255,255,.08);transform:scale(.9)}
.ctrl-btn.sm{width:40px;height:40px;font-size:18px;color:var(--t2)}
.ctrl-btn.pp{width:66px;height:66px;background:linear-gradient(135deg,var(--p3),var(--p));font-size:26px;box-shadow:0 6px 25px rgba(139,92,246,.45)}
.ctrl-btn.pp:active{transform:scale(.93)}

/* EXTRA CONTROLS */
.extra-row{display:flex;align-items:center;justify-content:space-around;width:100%;padding:0 20px;margin-bottom:16px}
.ex-btn{background:none;border:none;color:var(--t2);font-size:20px;cursor:pointer;padding:8px;border-radius:10px;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:3px;font-size:18px}
.ex-btn span{font-size:10px;font-weight:700}
.ex-btn.on{color:var(--p2)}
.ex-btn:active{transform:scale(.9)}

/* VOLUME */
.vol-row{display:flex;align-items:center;gap:10px;width:100%;padding:0 4px;margin-bottom:8px}
.vol-ico{font-size:16px;color:var(--t2)}
.vol-bar{flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:2px;cursor:pointer;position:relative}
.vol-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));border-radius:2px;width:80%}

/* ========== LIBRARY PAGE ========== */
.lib-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;margin-top:4px}
.ls{background:var(--c1);border:1px solid var(--bd);border-radius:13px;padding:12px 8px;text-align:center}
.ls-n{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--p),var(--b));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.ls-l{font-size:11px;color:var(--t2);margin-top:3px}

.lib-search{position:relative;margin-bottom:12px}
.lib-sinp{width:100%;padding:11px 14px 11px 38px;background:var(--c1);border:1.5px solid var(--bd);border-radius:13px;color:var(--t);font-size:14px;outline:none;-webkit-appearance:none;font-family:inherit}
.lib-sinp::placeholder{color:var(--t2)}
.lib-sico{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:15px;pointer-events:none}

/* MINI PLAYER BAR */
.mini-bar{position:fixed;bottom:0;left:0;right:0;z-index:200;background:rgba(10,10,28,.97);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);border-top:1px solid var(--bd);transform:translateY(100%);transition:transform .32s cubic-bezier(.4,0,.2,1)}
.mini-bar.show{transform:translateY(0)}
.mini-prog{height:3px;background:rgba(255,255,255,.07);cursor:pointer}
.mini-prog-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--b));width:0%;transition:width .4s linear}
.mini-body{display:flex;align-items:center;gap:11px;padding:9px 16px;padding-bottom:max(9px,env(safe-area-inset-bottom))}
.mini-art{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--p3),var(--b));display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;overflow:hidden}
.mini-art img{width:100%;height:100%;object-fit:cover}
.mini-info{flex:1;min-width:0;cursor:pointer}
.mini-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mini-artist{font-size:11px;color:var(--t2)}
.mini-bars{display:flex;align-items:flex-end;gap:2px;height:14px;margin-top:3px}
.mb2{width:3px;background:var(--p2);border-radius:2px;animation:mba .6s ease infinite alternate}
.mb2:nth-child(1){animation-delay:0s}.mb2:nth-child(2){animation-delay:.15s}.mb2:nth-child(3){animation-delay:.3s}.mb2:nth-child(4){animation-delay:.45s}
@keyframes mba{from{height:2px}to{height:12px}}
.mini-bars.paused .mb2{animation-play-state:paused;height:4px}
.mini-ctrls{display:flex;gap:4px;align-items:center}
.mc{width:34px;height:34px;border:none;background:transparent;color:var(--t);font-size:17px;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s}
.mc:active{background:rgba(255,255,255,.08)}
.mc.pp2{width:40px;height:40px;background:linear-gradient(135deg,var(--p3),var(--p));box-shadow:0 3px 12px rgba(139,92,246,.4)}

/* TOAST */
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-10px);background:var(--c2);color:var(--t);padding:9px 18px;border-radius:22px;font-size:13px;font-weight:600;border:1px solid var(--bd);z-index:1000;opacity:0;transition:all .25s;white-space:nowrap;pointer-events:none;backdrop-filter:blur(12px);max-width:88vw;text-align:center}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* DL TOAST */
.dl-toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--c2);border:1px solid rgba(16,185,129,.3);border-radius:16px;padding:12px 16px;z-index:1001;opacity:0;transition:all .3s;pointer-events:none;min-width:240px;max-width:90vw}
.dl-toast.show{opacity:1}
.dl-toast-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.dl-toast-ico{font-size:20px}
.dl-toast-info{flex:1}
.dl-toast-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dl-toast-sub{font-size:11px;color:var(--t2)}
.dl-toast-bar{height:4px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden}
.dl-toast-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--g));border-radius:2px;width:0%;transition:width .25s}

/* EMPTY */
.empty{text-align:center;padding:50px 20px}
.eico{font-size:48px;display:block;margin-bottom:12px}
.etit{font-size:17px;font-weight:700;margin-bottom:7px}
.esub{font-size:13px;color:var(--t2);line-height:1.6}

/* QUEUE */
.queue-item{background:var(--c1);border:1px solid var(--bd);border-radius:14px;padding:10px 12px;display:flex;align-items:center;gap:10px;margin-bottom:8px;cursor:pointer;transition:all .18s}
.queue-item.active{border-color:var(--p);background:rgba(139,92,246,.07)}
.queue-item:active{transform:scale(.98)}
.qi-num{width:24px;text-align:center;font-size:13px;color:var(--t2);font-weight:700;flex-shrink:0}
.qi-art{width:40px;height:40px;border-radius:9px;background:linear-gradient(135deg,var(--p3),var(--b));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;overflow:hidden}
.qi-art img{width:100%;height:100%;object-fit:cover}
.qi-info{flex:1;min-width:0}
.qi-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qi-artist{font-size:11px;color:var(--t2)}
.qi-dur{font-size:11px;color:var(--t2);flex-shrink:0}
.qi-dl{font-size:13px;font-weight:700;color:var(--g);flex-shrink:0}

/* SETTINGS / INFO */
.info-card{background:var(--c1);border:1px solid var(--bd);border-radius:16px;padding:14px;margin-bottom:12px}
.ic-row{display:flex;align-items:center;gap:12px;padding:6px 0;border-bottom:1px solid var(--bd)}
.ic-row:last-child{border-bottom:none}
.ic-ico{font-size:18px;width:28px;text-align:center}
.ic-txt{flex:1;font-size:13px;font-weight:600}
.ic-val{font-size:12px;color:var(--t2)}

/* CLEAR BTN */
.clr-btn{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:var(--r);padding:7px 14px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer}
</style>
</head>
<body>
<div class="glow"></div>
<div class="toast" id="toast"></div>

<!-- DL TOAST -->
<div class="dl-toast" id="dlToast">
  <div class="dl-toast-row">
    <div class="dl-toast-ico">‚¨áÔ∏è</div>
    <div class="dl-toast-info">
      <div class="dl-toast-title" id="dlToastTitle">ƒ∞ndiriliyor...</div>
      <div class="dl-toast-sub" id="dlToastSub">L√ºtfen bekle</div>
    </div>
  </div>
  <div class="dl-toast-bar"><div class="dl-toast-fill" id="dlToastFill"></div></div>
</div>

<div class="shell">

  <!-- NAV -->
  <div class="nav">
    <div class="brand">
      <div class="brand-ico">üéµ</div>
      <div class="brand-txt">M√ºzik<span>Box</span></div>
    </div>
    <div class="nav-right">
      <div class="lib-count" id="libCount">0</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab on" onclick="goTab('search',this)"><i>üîç</i>Ke≈üfet</div>
    <div class="tab" onclick="goTab('player',this)"><i>üéµ</i>√áalar</div>
    <div class="tab" onclick="goTab('queue',this)"><i>üìã</i>Sƒ±ra</div>
    <div class="tab" onclick="goTab('lib',this)"><i>‚ù§Ô∏è</i>K√ºt√ºphane</div>
  </div>

  <!-- PAGES -->
  <div class="pages">

    <!-- ===== SEARCH PAGE ===== -->
    <div class="pg on" id="pg-search">
      <div class="sbox">
        <span class="sico">üîç</span>
        <input class="sinp" id="searchInput" type="text" placeholder="≈ûarkƒ± adƒ± veya sanat√ßƒ±..."
          onkeydown="if(event.key==='Enter')doSearch()">
        <button class="sbtn" onclick="doSearch()">‚Üí</button>
      </div>

      <div class="chips" id="srcChips">
        <div class="chip on" onclick="setSrc(this,'itunes')">üçé iTunes</div>
        <div class="chip" onclick="setSrc(this,'jamendo')">üé∂ Jamendo</div>
        <div class="chip" onclick="setSrc(this,'audiomack')">üé§ Audiomack</div>
        <div class="chip" onclick="setSrc(this,'soundcloud')">‚òÅÔ∏è SoundCloud</div>
      </div>

      <!-- LOADING -->
      <div class="ldg" id="sldg">
        <div class="spin-c"></div>
        <div class="ldg-txt">Aranƒ±yor...</div>
      </div>

      <!-- TRENDS -->
      <div id="trendArea">
        <div class="slbl">üî• Pop√ºler</div>
        <div class="trend-grid" id="tgrid"></div>
        <div class="slbl">üí° Nasƒ±l √áalƒ±≈üƒ±r?</div>
        <div class="info-card">
          <div class="ic-row"><div class="ic-ico">üîç</div><div class="ic-txt">≈ûarkƒ± adƒ±nƒ± yaz ve ara</div></div>
          <div class="ic-row"><div class="ic-ico">‚ñ∂Ô∏è</div><div class="ic-txt">Oynat butonuyla dinle</div></div>
          <div class="ic-row"><div class="ic-ico">‚¨áÔ∏è</div><div class="ic-txt">ƒ∞ndir ‚Üí K√ºt√ºphaneye otomatik eklenir</div></div>
          <div class="ic-row"><div class="ic-ico">üéµ</div><div class="ic-txt">√áalar sekmesinde tam ekran dinle</div></div>
          <div class="ic-row"><div class="ic-ico">‚ù§Ô∏è</div><div class="ic-txt">Favori ekle, istediƒüin zaman dinle</div></div>
        </div>
      </div>

      <!-- RESULTS -->
      <div id="resArea" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-size:15px;font-weight:700" id="resTitle"></div>
          <div style="font-size:12px;color:var(--t2)" id="resCnt"></div>
        </div>
        <div id="resList"></div>
      </div>
    </div>

    <!-- ===== PLAYER PAGE ===== -->
    <div class="pg" id="pg-player">
      <div class="big-player">
        <!-- ART -->
        <div class="bp-art-wrap">
          <div class="bp-art" id="bpArt">
            <span id="bpArtEmoji">üéµ</span>
            <img id="bpArtImg" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:28px">
          </div>
          <div class="bp-art-ring" id="bpRing"></div>
        </div>

        <div class="bp-title" id="bpTitle">≈ûarkƒ± Se√ßilmedi</div>
        <div class="bp-artist" id="bpArtist">‚Äî √áalmak i√ßin ≈üarkƒ± se√ß ‚Äî</div>

        <!-- WAVEFORM -->
        <div class="waveform" id="waveform"></div>

        <!-- SEEK -->
        <div class="seekwrap" id="seekWrap" onclick="seekClick(event)">
          <div class="seekbar">
            <div class="seekfill" id="seekFill">
              <div class="seekthumb"></div>
            </div>
          </div>
          <div class="seek-times">
            <span id="curTime">0:00</span>
            <span id="durTime">0:00</span>
          </div>
        </div>

        <!-- CONTROLS -->
        <div class="ctrl-row">
          <button class="ctrl-btn sm" onclick="prevTr()" title="√ñnceki">‚èÆ</button>
          <button class="ctrl-btn sm" onclick="skipBack()" title="-10s">‚Ü©</button>
          <button class="ctrl-btn pp" id="ppBtn" onclick="togPP()">‚ñ∂</button>
          <button class="ctrl-btn sm" onclick="skipFwd()" title="+10s">‚Ü™</button>
          <button class="ctrl-btn sm" onclick="nextTr()" title="Sonraki">‚è≠</button>
        </div>

        <!-- EXTRA -->
        <div class="extra-row">
          <button class="ex-btn" id="shuffleBtn" onclick="togShuffle()">üîÄ<span>Karƒ±≈ütƒ±r</span></button>
          <button class="ex-btn" id="repeatBtn" onclick="togRepeat()">üîÅ<span>Tekrar</span></button>
          <button class="ex-btn" id="favBtn" onclick="togFavCurrent()">‚ô°<span>Favori</span></button>
          <button class="ex-btn" onclick="dlCurrent()">‚¨áÔ∏è<span>ƒ∞ndir</span></button>
        </div>

        <!-- VOLUME -->
        <div class="vol-row">
          <span class="vol-ico">üîà</span>
          <div class="vol-bar" id="volBar" onclick="setVol(event)">
            <div class="vol-fill" id="volFill"></div>
          </div>
          <span class="vol-ico">üîä</span>
        </div>
      </div>
    </div>

    <!-- ===== QUEUE PAGE ===== -->
    <div class="pg" id="pg-queue">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0 14px">
        <div style="font-size:16px;font-weight:800">üìã √áalma Sƒ±rasƒ±</div>
        <button onclick="clearQueue()" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:var(--r);padding:6px 12px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer">Temizle</button>
      </div>
      <div id="queueList">
        <div class="empty"><span class="eico">üì≠</span><div class="etit">Sƒ±ra Bo≈ü</div><div class="esub">≈ûarkƒ± eklemek i√ßin Ke≈üfet sekmesini kullan</div></div>
      </div>
    </div>

    <!-- ===== LIBRARY PAGE ===== -->
    <div class="pg" id="pg-lib">
      <div class="lib-stats">
        <div class="ls"><div class="ls-n" id="stCnt">0</div><div class="ls-l">≈ûarkƒ±</div></div>
        <div class="ls"><div class="ls-n" id="stMin">0</div><div class="ls-l">Dakika</div></div>
        <div class="ls"><div class="ls-n" id="stArt">0</div><div class="ls-l">Sanat√ßƒ±</div></div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="slbl" style="margin:0">‚ù§Ô∏è ƒ∞ndirilen & Favoriler</div>
        <button class="clr-btn" onclick="clearLib()">Temizle</button>
      </div>

      <div class="lib-search">
        <span class="lib-sico">üîç</span>
        <input class="lib-sinp" id="libSearch" type="text" placeholder="K√ºt√ºphanede ara..." oninput="filterLib(this.value)">
      </div>

      <div id="libList"></div>
    </div>

  </div><!-- /pages -->
</div><!-- /shell -->

<!-- MINI PLAYER -->
<div class="mini-bar" id="miniBar">
  <div class="mini-prog" id="miniProg" onclick="miniSeek(event)">
    <div class="mini-prog-fill" id="mpFill"></div>
  </div>
  <div class="mini-body">
    <div class="mini-art" id="miniArt" onclick="goTab('player',document.querySelectorAll('.tab')[1])">üéµ</div>
    <div class="mini-info" onclick="goTab('player',document.querySelectorAll('.tab')[1])">
      <div class="mini-title" id="miniTitle">‚Äî</div>
      <div class="mini-bars" id="miniBars">
        <div class="mb2"></div><div class="mb2"></div><div class="mb2"></div><div class="mb2"></div>
      </div>
    </div>
    <div class="mini-ctrls">
      <button class="mc" onclick="prevTr()">‚èÆ</button>
      <button class="mc pp2" id="miniPP" onclick="togPP()">‚ñ∂</button>
      <button class="mc" onclick="nextTr()">‚è≠</button>
    </div>
  </div>
</div>

<audio id="aud" preload="auto"></audio>

<script>
// ==============================
// STATE
// ==============================
let lib       = JSON.parse(localStorage.getItem('mb_lib4') || '[]');
let queue     = [];
let ci        = -1;
let playing   = false;
let shuffle   = false;
let repeat    = 0; // 0=off 1=all 2=one
let curSrc    = 'itunes';
let vol       = 0.8;
let searchRes = [];
let libFilter = '';

const aud = document.getElementById('aud');
aud.volume = vol;

// ==============================
// TABS
// ==============================
function goTab(id, el) {
  document.querySelectorAll('.pg').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.getElementById('pg-' + id).classList.add('on');
  if (el) el.classList.add('on');
  if (id === 'lib') renderLib();
  if (id === 'queue') renderQueue();
}

// ==============================
// SOURCE
// ==============================
function setSrc(el, src) {
  document.querySelectorAll('#srcChips .chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  curSrc = src;
}

// ==============================
// SEARCH
// ==============================
async function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) { showToast('‚ö†Ô∏è ≈ûarkƒ± adƒ± yaz'); return; }

  // Jamendo, Audiomack, SoundCloud ‚Üí iTunes API kullanƒ±r (CORS kƒ±sƒ±tƒ± yok)
  document.getElementById('trendArea').style.display = 'none';
  document.getElementById('resArea').style.display = 'none';
  document.getElementById('sldg').classList.add('show');

  try {
    const r = await fetch(
      `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&media=music&limit=30&country=TR`
    );
    const d = await r.json();
    document.getElementById('sldg').classList.remove('show');

    if (d.results && d.results.length) {
      searchRes = d.results.map((t, i) => ({
        id: 'it_' + i,
        title:   t.trackName   || '‚Äî',
        artist:  t.artistName  || '‚Äî',
        album:   t.collectionName || '',
        dur:     fmtMs(t.trackTimeMillis),
        durMs:   t.trackTimeMillis || 0,
        thumb:   t.artworkUrl100 ? t.artworkUrl100.replace('100x100', '300x300') : null,
        thumbSm: t.artworkUrl100 || null,
        preview: t.previewUrl  || null,
        source:  'iTunes',
        blob:    null
      }));
      showResults(q);
    } else {
      showToast('üòî Sonu√ß bulunamadƒ±');
      document.getElementById('trendArea').style.display = 'block';
    }
  } catch {
    document.getElementById('sldg').classList.remove('show');
    showToast('‚ùå Baƒülantƒ± hatasƒ±');
    document.getElementById('trendArea').style.display = 'block';
  }
}

function showResults(q) {
  document.getElementById('resTitle').textContent = `"${q}"`;
  document.getElementById('resCnt').textContent = searchRes.length + ' sonu√ß';
  const list = document.getElementById('resList');
  list.innerHTML = '';
  searchRes.forEach((tr, i) => {
    const inLib = isInLib(tr);
    const inQ   = queue.some(t => t.id === tr.id);
    const d = document.createElement('div');
    d.className = 'tc';
    d.id = 'src-card-' + i;
    d.innerHTML = `
      ${tr.thumbSm
        ? `<img class="tc-art" src="${tr.thumbSm}" onerror="this.style.display='none';this.nextSibling.style.display='flex'">`
        : ''}
      <div class="tc-ph" style="${tr.thumbSm ? 'display:none' : ''}">üéµ</div>
      <div class="tc-info">
        <div class="tc-title">${tr.title}</div>
        <div class="tc-artist">${tr.artist}</div>
        <div class="tc-meta">
          <span class="tc-dur">${tr.dur}</span>
          <span class="tc-src" style="background:rgba(255,45,85,.1);color:#ff2d55">${tr.source}</span>
          ${tr.preview ? '<span class="tc-src" style="background:rgba(16,185,129,.12);color:var(--g)">‚ñ∂ √ñnizleme</span>' : ''}
        </div>
      </div>
      <div class="tc-acts">
        <button class="tca tca-play" onclick="playSrc(${i})" title="√áal">‚ñ∂</button>
        <button class="tca tca-fav" id="fvb-${i}" onclick="togFavSrc(${i},this)" title="Favori">${inLib ? '‚ô•' : '‚ô°'}</button>
        <button class="tca tca-dl" onclick="dlSrc(${i},this)" title="ƒ∞ndir">‚¨á</button>
      </div>
      <div class="dl-prog" id="dlp-${i}"><div class="dl-prog-fill" id="dlf-${i}"></div></div>
    `;
    list.appendChild(d);
  });
  document.getElementById('resArea').style.display = 'block';
}

// ==============================
// PLAY FROM SEARCH
// ==============================
function playSrc(i) {
  const tr = searchRes[i];
  // Add to queue if not already
  if (!queue.some(t => t.id === tr.id)) {
    queue.push({...tr});
  }
  const qi = queue.findIndex(t => t.id === tr.id);
  playIdx(qi);
}

// ==============================
// CORE PLAYER
// ==============================
function playIdx(i) {
  if (i < 0 || i >= queue.length) return;
  ci = i;
  const tr = queue[ci];

  // Update UI immediately
  updatePlayerUI(tr);
  document.getElementById('miniBar').classList.add('show');

  // Determine source
  if (tr.blob) {
    // Already downloaded blob
    aud.src = tr.blob;
    startPlay();
  } else if (tr.preview) {
    aud.src = tr.preview;
    startPlay();
    showToast('‚ñ∂ 30sn √∂nizleme √ßalƒ±yor');
  } else {
    showToast('‚ö†Ô∏è Bu ≈üarkƒ± i√ßin ses bulunamadƒ±');
    updatePlayState(false);
  }

  renderQueue();
  updateLibCount();
}

function startPlay() {
  aud.play().then(() => {
    updatePlayState(true);
  }).catch(e => {
    showToast('‚ùå Oynatƒ±lamadƒ±: ' + e.message);
    updatePlayState(false);
  });
}

function updatePlayerUI(tr) {
  // Big player
  document.getElementById('bpTitle').textContent  = tr.title;
  document.getElementById('bpArtist').textContent = tr.artist;

  const bpArtImg   = document.getElementById('bpArtImg');
  const bpArtEmoji = document.getElementById('bpArtEmoji');
  if (tr.thumb) {
    bpArtImg.src         = tr.thumb;
    bpArtImg.style.display = 'block';
    bpArtEmoji.style.display = 'none';
  } else {
    bpArtImg.style.display   = 'none';
    bpArtEmoji.style.display = 'block';
  }

  // Mini player
  document.getElementById('miniTitle').textContent = tr.title;
  const miniArt = document.getElementById('miniArt');
  if (tr.thumbSm) {
    miniArt.innerHTML = `<img src="${tr.thumbSm}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">`;
  } else {
    miniArt.innerHTML = 'üéµ';
  }

  // Fav btn
  const favBtn = document.getElementById('favBtn');
  favBtn.textContent = isInLib(tr) ? '‚ô•' : '‚ô°';
  favBtn.querySelector ? null : null;
  document.getElementById('favBtn').innerHTML = isInLib(tr) ? '‚ô•<span>Favori</span>' : '‚ô°<span>Favori</span>';
}

function updatePlayState(isPlay) {
  playing = isPlay;
  document.getElementById('ppBtn').textContent    = isPlay ? '‚è∏' : '‚ñ∂';
  document.getElementById('miniPP').textContent   = isPlay ? '‚è∏' : '‚ñ∂';
  document.getElementById('bpArt').classList.toggle('playing', isPlay);
  document.getElementById('bpRing').classList.toggle('show', isPlay);
  document.getElementById('miniBars').classList.toggle('paused', !isPlay);
  document.querySelector('.tc-ph.spin')?.classList.remove('spin');
}

function togPP() {
  if (!aud.src && queue.length === 0) { showToast('‚ö†Ô∏è √ñnce bir ≈üarkƒ± se√ß'); return; }
  if (!aud.src && queue.length > 0) { playIdx(0); return; }
  if (playing) {
    aud.pause();
    updatePlayState(false);
  } else {
    aud.play().then(() => updatePlayState(true)).catch(() => {});
  }
}

function nextTr() {
  if (!queue.length) return;
  if (shuffle) {
    let ni = Math.floor(Math.random() * queue.length);
    while (ni === ci && queue.length > 1) ni = Math.floor(Math.random() * queue.length);
    playIdx(ni);
  } else {
    playIdx((ci + 1) % queue.length);
  }
}

function prevTr() {
  if (!queue.length) return;
  if (aud.currentTime > 3) { aud.currentTime = 0; return; }
  playIdx((ci - 1 + queue.length) % queue.length);
}

function skipFwd()  { aud.currentTime = Math.min(aud.currentTime + 10, aud.duration || 0); }
function skipBack() { aud.currentTime = Math.max(aud.currentTime - 10, 0); }

function togShuffle() {
  shuffle = !shuffle;
  const btn = document.getElementById('shuffleBtn');
  btn.classList.toggle('on', shuffle);
  showToast(shuffle ? 'üîÄ Karƒ±≈ütƒ±r a√ßƒ±k' : 'üîÄ Karƒ±≈ütƒ±r kapalƒ±');
}

function togRepeat() {
  repeat = (repeat + 1) % 3;
  const btn = document.getElementById('repeatBtn');
  const icons = ['üîÅ', 'üîÅ', 'üîÇ'];
  const labels = ['Tekrar', 'T√ºm√º', 'Biri'];
  btn.innerHTML = icons[repeat] + `<span>${labels[repeat]}</span>`;
  btn.classList.toggle('on', repeat > 0);
  showToast(['üîÅ Tekrar kapalƒ±', 'üîÅ Hepsini tekrar', 'üîÇ Biri tekrar'][repeat]);
}

// Audio events
aud.addEventListener('ended', () => {
  if (repeat === 2) { aud.currentTime = 0; aud.play(); return; }
  if (ci < queue.length - 1 || repeat === 1) nextTr();
  else updatePlayState(false);
});

aud.addEventListener('timeupdate', () => {
  if (!aud.duration) return;
  const pct = aud.currentTime / aud.duration * 100;
  document.getElementById('seekFill').style.width = pct + '%';
  document.getElementById('mpFill').style.width   = pct + '%';
  document.getElementById('curTime').textContent  = fmtSec(aud.currentTime);
  document.getElementById('durTime').textContent  = fmtSec(aud.duration);
  updateWaveform(pct);
});

// Seek
function seekClick(e) {
  const bar = document.getElementById('seekWrap');
  const pct = e.offsetX / bar.clientWidth;
  if (aud.duration) aud.currentTime = aud.duration * pct;
}

function miniSeek(e) {
  const bar = document.getElementById('miniProg');
  const pct = e.offsetX / bar.clientWidth;
  if (aud.duration) aud.currentTime = aud.duration * pct;
}

// Volume
function setVol(e) {
  const bar = document.getElementById('volBar');
  vol = Math.max(0, Math.min(1, e.offsetX / bar.clientWidth));
  aud.volume = vol;
  document.getElementById('volFill').style.width = (vol * 100) + '%';
}

// Waveform
function buildWaveform() {
  const wf = document.getElementById('waveform');
  wf.innerHTML = '';
  for (let i = 0; i < 32; i++) {
    const b = document.createElement('div');
    b.className = 'wv';
    b.style.height = (Math.random() * 28 + 6) + 'px';
    wf.appendChild(b);
  }
}

function updateWaveform(pct) {
  const bars = document.querySelectorAll('.wv');
  const active = Math.floor(pct / 100 * bars.length);
  bars.forEach((b, i) => b.classList.toggle('active', i <= active));
}

// ==============================
// DOWNLOAD ‚Äî BLOB STORE
// ==============================
async function dlSrc(i, btn) {
  const tr = searchRes[i];
  if (!tr.preview) {
    showToast('‚ö†Ô∏è Bu ≈üarkƒ±nƒ±n √∂nizlemesi yok');
    return;
  }

  // Show progress
  btn.textContent = '‚è≥';
  btn.disabled = true;
  showDlToast(tr.title, 0);

  try {
    const response = await fetch(tr.preview);
    if (!response.ok) throw new Error('HTTP ' + response.status);

    const reader    = response.body.getReader();
    const total     = parseInt(response.headers.get('content-length') || '0');
    let received    = 0;
    const chunks    = [];

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      chunks.push(value);
      received += value.length;
      const pct = total ? Math.round(received / total * 100) : 50;
      showDlToast(tr.title, pct);
      // Card progress bar
      const fill = document.getElementById('dlf-' + i);
      if (fill) fill.style.width = pct + '%';
    }

    // Create blob URL
    const blob    = new Blob(chunks, { type: 'audio/mpeg' });
    const blobUrl = URL.createObjectURL(blob);

    // Save to track
    tr.blob      = blobUrl;
    tr.blobSize  = blob.size;
    tr.downloaded = true;

    // Also update in queue if present
    const qi = queue.findIndex(t => t.id === tr.id);
    if (qi >= 0) { queue[qi].blob = blobUrl; queue[qi].downloaded = true; }

    // Auto add to library
    addToLib(tr);

    // Update card
    btn.textContent = '‚úÖ';
    btn.style.background = 'rgba(16,185,129,.25)';

    showDlToast(tr.title, 100);
    setTimeout(() => hideDlToast(), 1500);
    showToast('‚úÖ ' + tr.title + ' k√ºt√ºphaneye eklendi!');

    // Card progress full
    const fill = document.getElementById('dlf-' + i);
    if (fill) { fill.style.width = '100%'; setTimeout(() => { fill.style.width = '0'; }, 2000); }

    updateLibCount();
    renderLib();

  } catch (err) {
    btn.textContent = '‚¨á';
    btn.disabled = false;
    hideDlToast();
    showToast('‚ùå ƒ∞ndirme hatasƒ±: ' + err.message);
  }
}

async function dlCurrent() {
  if (ci < 0 || !queue[ci]) { showToast('‚ö†Ô∏è ≈ûarkƒ± √ßalmƒ±yor'); return; }
  const tr = queue[ci];
  if (tr.downloaded) { showToast('‚úÖ Zaten indirildi'); addToLib(tr); return; }
  if (!tr.preview) { showToast('‚ö†Ô∏è √ñnizleme yok'); return; }

  showDlToast(tr.title, 0);
  try {
    const resp  = await fetch(tr.preview);
    const reader = resp.body.getReader();
    const total  = parseInt(resp.headers.get('content-length') || '0');
    let recv = 0, chunks = [];

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      chunks.push(value); recv += value.length;
      showDlToast(tr.title, total ? Math.round(recv / total * 100) : 50);
    }

    const blob    = new Blob(chunks, { type: 'audio/mpeg' });
    const blobUrl = URL.createObjectURL(blob);
    tr.blob = blobUrl; tr.downloaded = true;
    queue[ci].blob = blobUrl; queue[ci].downloaded = true;

    addToLib(tr);
    showDlToast(tr.title, 100);
    setTimeout(() => hideDlToast(), 1200);
    showToast('‚úÖ K√ºt√ºphaneye eklendi!');
    updateLibCount();
    renderLib();
    // Update fav btn
    document.getElementById('favBtn').innerHTML = '‚ô•<span>Favori</span>';
  } catch (e) {
    hideDlToast();
    showToast('‚ùå Hata: ' + e.message);
  }
}

// ==============================
// DL TOAST
// ==============================
function showDlToast(title, pct) {
  document.getElementById('dlToastTitle').textContent = title;
  document.getElementById('dlToastSub').textContent   = pct < 100 ? `ƒ∞ndiriliyor... %${pct}` : '‚úÖ Tamamlandƒ±!';
  document.getElementById('dlToastFill').style.width  = pct + '%';
  document.getElementById('dlToast').classList.add('show');
}

function hideDlToast() {
  document.getElementById('dlToast').classList.remove('show');
}

// ==============================
// LIBRARY
// ==============================
function addToLib(tr) {
  if (!isInLib(tr)) {
    lib.unshift({ ...tr });
    saveLib();
  }
}

function isInLib(tr) {
  return lib.some(t => t.title === tr.title && t.artist === tr.artist);
}

function togFavSrc(i, btn) {
  const tr = searchRes[i];
  if (isInLib(tr)) {
    lib = lib.filter(t => !(t.title === tr.title && t.artist === tr.artist));
    btn.textContent = '‚ô°';
    showToast('üíî Kaldƒ±rƒ±ldƒ±');
  } else {
    addToLib(tr);
    btn.textContent = '‚ô•';
    showToast('‚ù§Ô∏è Eklendi');
  }
  saveLib();
  updateLibCount();
}

function togFavCurrent() {
  if (ci < 0 || !queue[ci]) return;
  const tr = queue[ci];
  if (isInLib(tr)) {
    lib = lib.filter(t => !(t.title === tr.title && t.artist === tr.artist));
    document.getElementById('favBtn').innerHTML = '‚ô°<span>Favori</span>';
    showToast('üíî Kaldƒ±rƒ±ldƒ±');
  } else {
    addToLib(tr);
    document.getElementById('favBtn').innerHTML = '‚ô•<span>Favori</span>';
    showToast('‚ù§Ô∏è Eklendi');
  }
  saveLib();
  updateLibCount();
}

function saveLib() {
  // Save without blob (too large)
  const toSave = lib.map(t => ({ ...t, blob: null, downloaded: !!t.blob }));
  try { localStorage.setItem('mb_lib4', JSON.stringify(toSave)); } catch {}
}

function renderLib() {
  const filtered = lib.filter(t =>
    !libFilter ||
    t.title.toLowerCase().includes(libFilter) ||
    t.artist.toLowerCase().includes(libFilter)
  );

  const totalMin = Math.round(lib.reduce((a, t) => a + (t.durMs || 0), 0) / 60000);
  const artists  = new Set(lib.map(t => t.artist)).size;
  document.getElementById('stCnt').textContent = lib.length;
  document.getElementById('stMin').textContent = totalMin;
  document.getElementById('stArt').textContent = artists;

  const list = document.getElementById('libList');
  if (!filtered.length) {
    list.innerHTML = `<div class="empty"><span class="eico">${lib.length ? 'üîç' : 'üì≠'}</span>
      <div class="etit">${lib.length ? 'Bulunamadƒ±' : 'K√ºt√ºphane Bo≈ü'}</div>
      <div class="esub">${lib.length ? 'Farklƒ± bir arama dene' : '≈ûarkƒ± indir veya favorile'}</div></div>`;
    return;
  }

  list.innerHTML = '';
  filtered.forEach((tr, i) => {
    const d = document.createElement('div');
    d.className = 'tc';
    const isPlaying = ci >= 0 && queue[ci] && queue[ci].title === tr.title && queue[ci].artist === tr.artist;
    if (isPlaying) d.classList.add('playing');
    d.innerHTML = `
      <div class="tc-ph ${isPlaying ? 'spin' : ''}">üéµ</div>
      <div class="tc-info">
        <div class="tc-title">${tr.title}</div>
        <div class="tc-artist">${tr.artist}</div>
        <div class="tc-meta">
          <span class="tc-dur">${tr.dur || '--:--'}</span>
          <span class="tc-src" style="background:rgba(16,185,129,.12);color:var(--g)">${tr.blob || tr.downloaded ? '‚úÖ ƒ∞ndirildi' : '‚ù§Ô∏è Favori'}</span>
        </div>
      </div>
      <div class="tc-acts">
        <button class="tca tca-play" onclick="playLib(${i})">‚ñ∂</button>
        <button class="tca tca-fav" onclick="rmLib(${i})">‚ô•</button>
        <button class="tca tca-dl" onclick="dlLib(${i})" style="${tr.blob ? 'background:rgba(16,185,129,.25)' : ''}">${tr.blob ? '‚úÖ' : '‚¨á'}</button>
      </div>
    `;
    list.appendChild(d);
  });
}

function filterLib(val) {
  libFilter = val.toLowerCase().trim();
  renderLib();
}

function playLib(i) {
  const filtered = lib.filter(t =>
    !libFilter ||
    t.title.toLowerCase().includes(libFilter) ||
    t.artist.toLowerCase().includes(libFilter)
  );
  const tr = filtered[i];
  if (!queue.some(t => t.id === tr.id)) queue.push({ ...tr });
  const qi = queue.findIndex(t => t.id === tr.id);
  playIdx(qi);
}

function rmLib(i) {
  const filtered = lib.filter(t =>
    !libFilter ||
    t.title.toLowerCase().includes(libFilter) ||
    t.artist.toLowerCase().includes(libFilter)
  );
  const tr = filtered[i];
  lib = lib.filter(t => !(t.title === tr.title && t.artist === tr.artist));
  saveLib();
  updateLibCount();
  renderLib();
  showToast('üóëÔ∏è Kaldƒ±rƒ±ldƒ±');
}

function dlLib(i) {
  const filtered = lib.filter(t =>
    !libFilter ||
    t.title.toLowerCase().includes(libFilter) ||
    t.artist.toLowerCase().includes(libFilter)
  );
  const tr = filtered[i];
  if (tr.blob) { showToast('‚úÖ Zaten indirildi'); return; }
  // Add to queue and download
  if (!queue.some(t => t.id === tr.id)) queue.push({ ...tr });
  const qi = queue.findIndex(t => t.id === tr.id);
  // Simulate download from queue
  dlQueueItem(qi);
}

async function dlQueueItem(qi) {
  const tr = queue[qi];
  if (!tr || !tr.preview) { showToast('‚ö†Ô∏è ƒ∞ndirme kaynaƒüƒ± yok'); return; }
  showDlToast(tr.title, 0);
  try {
    const resp  = await fetch(tr.preview);
    const reader = resp.body.getReader();
    const total  = parseInt(resp.headers.get('content-length') || '0');
    let recv = 0, chunks = [];
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      chunks.push(value); recv += value.length;
      showDlToast(tr.title, total ? Math.round(recv / total * 100) : 50);
    }
    const blob = new Blob(chunks, { type: 'audio/mpeg' });
    const url  = URL.createObjectURL(blob);
    queue[qi].blob = url; queue[qi].downloaded = true;
    // Update lib
    const li = lib.findIndex(t => t.title === tr.title && t.artist === tr.artist);
    if (li >= 0) { lib[li].blob = url; lib[li].downloaded = true; }
    showDlToast(tr.title, 100);
    setTimeout(() => hideDlToast(), 1200);
    showToast('‚úÖ ƒ∞ndirildi!');
    renderLib();
    renderQueue();
  } catch (e) {
    hideDlToast();
    showToast('‚ùå Hata: ' + e.message);
  }
}

function clearLib() {
  if (!lib.length) return;
  if (!confirm('K√ºt√ºphaneyi temizle?')) return;
  lib = [];
  saveLib();
  updateLibCount();
  renderLib();
  showToast('üóëÔ∏è Temizlendi');
}

function updateLibCount() {
  document.getElementById('libCount').textContent = lib.length;
}

// ==============================
// QUEUE
// ==============================
function renderQueue() {
  const list = document.getElementById('queueList');
  if (!queue.length) {
    list.innerHTML = `<div class="empty"><span class="eico">üì≠</span><div class="etit">Sƒ±ra Bo≈ü</div><div class="esub">Ke≈üfet'ten ≈üarkƒ± ekle</div></div>`;
    return;
  }
  list.innerHTML = '';
  queue.forEach((tr, i) => {
    const d = document.createElement('div');
    d.className = 'queue-item' + (i === ci ? ' active' : '');
    d.innerHTML = `
      <div class="qi-num">${i === ci ? '‚ñ∂' : (i + 1)}</div>
      <div class="qi-art">${tr.thumbSm ? `<img src="${tr.thumbSm}" style="width:100%;height:100%;object-fit:cover;border-radius:9px">` : 'üéµ'}</div>
      <div class="qi-info">
        <div class="qi-title">${tr.title}</div>
        <div class="qi-artist">${tr.artist}</div>
      </div>
      <div class="qi-dur">${tr.dur}</div>
      <div class="qi-dl" onclick="event.stopPropagation();dlQueueItem(${i})" title="ƒ∞ndir">${tr.downloaded || tr.blob ? '‚úÖ' : '‚¨á'}</div>
    `;
    d.addEventListener('click', () => playIdx(i));
    list.appendChild(d);
  });
}

function clearQueue() {
  if (!confirm('Sƒ±rayƒ± temizle?')) return;
  queue = []; ci = -1;
  aud.pause(); aud.src = '';
  updatePlayState(false);
  document.getElementById('miniBar').classList.remove('show');
  document.getElementById('bpTitle').textContent  = '≈ûarkƒ± Se√ßilmedi';
  document.getElementById('bpArtist').textContent = '‚Äî √áalmak i√ßin ≈üarkƒ± se√ß ‚Äî';
  renderQueue();
  showToast('üóëÔ∏è Sƒ±ra temizlendi');
}

// ==============================
// TRENDING
// ==============================
const TRENDS = [
  { e: 'üé∏', n: 'Duman',        g: 'Rock'     },
  { e: '‚≠ê', n: 'Tarkan',       g: 'Pop'      },
  { e: 'üåø', n: 'Mabel Matiz',  g: 'Indie'    },
  { e: 'üíú', n: 'Semicenk',     g: 'Pop'      },
  { e: 'üé≠', n: 'Teoman',       g: 'Rock'     },
  { e: 'üå∏', n: 'Zeynep Bastƒ±k',g: 'Pop'      },
  { e: 'üî•', n: 'Sagopa Kajmer',g: 'Rap'      },
  { e: 'üé∫', n: 'Manga',        g: 'Metal'    },
  { e: 'üåô', n: 'Mor ve √ñtesi', g: 'Rock'     },
  { e: 'üí´', n: 'Gripin',       g: 'Pop Rock' },
];

function buildTrends() {
  document.getElementById('tgrid').innerHTML = TRENDS.map(t => `
    <div class="trend-item" onclick="qSearch('${t.n}')">
      <span class="ti-emo">${t.e}</span>
      <div><div class="ti-name">${t.n}</div><div class="ti-g">${t.g}</div></div>
    </div>`).join('');
}

function qSearch(q) {
  document.getElementById('searchInput').value = q;
  goTab('search', document.querySelector('.tab'));
  doSearch();
}

// ==============================
// HELPERS
// ==============================
function fmtMs(ms)  { if(!ms)return'--:--'; const s=Math.floor(ms/1000); return`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
function fmtSec(s)  { if(isNaN(s))return'0:00'; return`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`; }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 2600);
}

// ==============================
// INIT
// ==============================
buildTrends();
buildWaveform();
renderLib();
updateLibCount();
document.getElementById('volFill').style.width = (vol * 100) + '%';
</script>
</body>
</html>
