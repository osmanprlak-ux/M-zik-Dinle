<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="M√ºzikBox">
<meta name="theme-color" content="#07071a">
<title>üéµ M√ºzikBox Pro</title>
<style>
/* ============================================================
   RESET & ROOT
============================================================ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
:root{
  --p:#8b5cf6;--p2:#a78bfa;--p3:#6d28d9;--p4:#4c1d95;
  --g:#10b981;--r:#ef4444;--o:#f59e0b;--b:#3b82f6;--pk:#ec4899;
  --dark:#07071a;--c1:#0f0f24;--c2:#161632;--c3:#1e1e40;--c4:#252550;
  --t:#fff;--t2:#7070a0;--t3:#5050808;
  --bd:rgba(255,255,255,0.07);--bd2:rgba(255,255,255,0.12);
  --blur:blur(24px);
  --dyn1:#8b5cf6;--dyn2:#6d28d9; /* dynamic from album art */
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;overflow:hidden;background:var(--dark)}
body{color:var(--t);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',sans-serif;-webkit-font-smoothing:antialiased}

/* ============================================================
   SCROLLBAR HIDE
============================================================ */
::-webkit-scrollbar{display:none}
*{scrollbar-width:none}

/* ============================================================
   DYNAMIC BG
============================================================ */
.dyn-bg{
  position:fixed;inset:0;z-index:0;
  background:radial-gradient(ellipse at 20% 20%,var(--dyn1) 0%,transparent 50%),
             radial-gradient(ellipse at 80% 80%,var(--dyn2) 0%,transparent 50%),
             var(--dark);
  opacity:.35;
  transition:background 1.2s ease;
  pointer-events:none;
}
.dyn-bg2{
  position:fixed;inset:0;z-index:0;
  background:var(--dark);
  pointer-events:none;
}

/* ============================================================
   APP SHELL
============================================================ */
.shell{
  position:relative;z-index:1;
  max-width:430px;margin:0 auto;
  height:100%;display:flex;flex-direction:column;
  overflow:hidden;
}

/* ============================================================
   TOP BAR
============================================================ */
.topbar{
  flex-shrink:0;
  padding:calc(var(--safe-top) + 12px) 18px 0;
  display:flex;align-items:center;justify-content:space-between;
  height:calc(var(--safe-top) + 56px);
}
.brand{display:flex;align-items:center;gap:9px}
.brand-ico{
  width:36px;height:36px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:18px;box-shadow:0 0 18px rgba(139,92,246,.45);
}
.brand-txt{font-size:19px;font-weight:800;letter-spacing:-.4px}
.brand-txt b{color:var(--p2)}
.topbar-right{display:flex;align-items:center;gap:10px}
.icon-btn{
  width:34px;height:34px;background:var(--c1);border:1px solid var(--bd);
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:16px;cursor:pointer;transition:all .2s;
}
.icon-btn:active{transform:scale(.9);background:var(--c2)}
.lib-badge{
  background:linear-gradient(135deg,var(--p3),var(--p));
  color:#fff;font-size:10px;font-weight:800;
  min-width:20px;height:20px;padding:0 5px;
  border-radius:10px;display:flex;align-items:center;justify-content:center;
}

/* ============================================================
   TABS
============================================================ */
.tabs{
  flex-shrink:0;display:flex;gap:5px;
  padding:10px 18px 8px;
}
.tab{
  flex:1;padding:9px 2px;
  background:var(--c1);border:1px solid var(--bd);border-radius:13px;
  color:var(--t2);font-size:10px;font-weight:800;
  cursor:pointer;text-align:center;transition:all .22s;
  display:flex;flex-direction:column;align-items:center;gap:3px;
}
.tab i{font-size:17px;font-style:normal}
.tab.on{
  background:linear-gradient(135deg,var(--p3),var(--p));
  color:#fff;border-color:transparent;
  box-shadow:0 4px 16px rgba(139,92,246,.38);
}

/* ============================================================
   PAGES
============================================================ */
.pages{flex:1;overflow:hidden;position:relative}
.pg{
  position:absolute;inset:0;
  overflow-y:auto;overflow-x:hidden;
  padding:8px 18px 180px;
  display:none;
  -webkit-overflow-scrolling:touch;
}
.pg.on{display:block}

/* ============================================================
   SECTION LABEL
============================================================ */
.slbl{
  font-size:11px;font-weight:800;color:var(--t2);
  text-transform:uppercase;letter-spacing:1.1px;
  margin:14px 0 10px;
  display:flex;align-items:center;gap:8px;
}
.slbl::after{content:'';flex:1;height:1px;background:var(--bd)}

/* ============================================================
   WELCOME / FOLDER SELECT
============================================================ */
.welcome{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:40px 20px;text-align:center;
}
.welcome-ico{font-size:72px;margin-bottom:20px;animation:pulse-ico 2s ease-in-out infinite}
@keyframes pulse-ico{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.welcome-title{font-size:24px;font-weight:800;margin-bottom:10px}
.welcome-sub{font-size:14px;color:var(--t2);line-height:1.7;margin-bottom:28px}
.folder-btn{
  width:100%;max-width:300px;
  padding:16px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:18px;color:#fff;
  font-size:16px;font-weight:700;cursor:pointer;
  transition:all .2s;
  box-shadow:0 8px 28px rgba(139,92,246,.42);
  display:flex;align-items:center;justify-content:center;gap:10px;
  margin-bottom:14px;
}
.folder-btn:active{transform:scale(.96)}
.folder-btn2{
  width:100%;max-width:300px;
  padding:14px;
  background:var(--c1);border:1.5px solid var(--bd2);
  border-radius:18px;color:var(--t);
  font-size:15px;font-weight:600;cursor:pointer;
  transition:all .2s;display:flex;align-items:center;justify-content:center;gap:10px;
}
.folder-btn2:active{transform:scale(.96);background:var(--c2)}
.how-steps{
  background:var(--c1);border:1px solid var(--bd);
  border-radius:18px;padding:16px;margin-top:20px;
  text-align:left;width:100%;max-width:340px;
}
.hs-title{font-size:13px;font-weight:700;margin-bottom:12px;color:var(--p2)}
.hs-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:10px}
.hs-n{
  width:22px;height:22px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  border-radius:7px;display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:800;flex-shrink:0;
}
.hs-t{font-size:12px;color:var(--t2);line-height:1.55;padding-top:3px}
.hs-t b{color:var(--t)}

/* ============================================================
   LIBRARY ‚Äî TRACK LIST
============================================================ */
.lib-toolbar{
  display:flex;align-items:center;gap:8px;
  margin-bottom:12px;margin-top:4px;
}
.lib-search-wrap{position:relative;flex:1}
.lib-sinp{
  width:100%;padding:10px 14px 10px 36px;
  background:var(--c1);border:1.5px solid var(--bd);
  border-radius:12px;color:var(--t);font-size:14px;
  outline:none;-webkit-appearance:none;font-family:inherit;
  transition:border .2s;
}
.lib-sinp:focus{border-color:var(--p)}
.lib-sinp::placeholder{color:var(--t2)}
.lib-sico{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none}
.sort-btn{
  padding:10px 12px;background:var(--c1);border:1.5px solid var(--bd);
  border-radius:12px;color:var(--t2);font-size:12px;font-weight:700;
  cursor:pointer;white-space:nowrap;transition:all .2s;
}
.sort-btn:active{background:var(--c2)}

/* VIEW TABS */
.view-tabs{display:flex;gap:5px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px}
.vt{
  flex-shrink:0;padding:7px 14px;
  background:var(--c1);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:12px;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.vt.on{background:rgba(139,92,246,.16);border-color:var(--p);color:var(--p2)}

/* TRACK CARD */
.tc{
  background:var(--c1);border:1px solid var(--bd);border-radius:16px;
  padding:11px;display:flex;align-items:center;gap:11px;
  margin-bottom:9px;transition:all .18s;cursor:pointer;
  position:relative;overflow:hidden;
}
.tc::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,var(--p3),var(--p));
  opacity:0;transition:opacity .2s;border-radius:16px;
}
.tc.playing{border-color:var(--p);background:rgba(139,92,246,.08)}
.tc.playing::before{opacity:.04}
.tc:active{transform:scale(.985)}
.tc-art{
  width:50px;height:50px;border-radius:11px;
  object-fit:cover;flex-shrink:0;background:var(--c3);
}
.tc-ph{
  width:50px;height:50px;border-radius:11px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;
  font-size:22px;flex-shrink:0;flex-shrink:0;
}
.tc-info{flex:1;min-width:0}
.tc-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.tc-artist{font-size:12px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}
.tc-meta{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.tc-dur{font-size:10px;color:var(--t2);background:var(--c3);padding:2px 6px;border-radius:5px}
.tc-fmt{font-size:10px;font-weight:800;padding:2px 6px;border-radius:5px}
.tc-acts{display:flex;gap:5px;flex-shrink:0}
.ta{
  width:30px;height:30px;border:none;border-radius:8px;
  cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.ta:active{transform:scale(.87)}
.ta-menu{background:var(--c3);color:var(--t2)}
.ta-fav{background:rgba(239,68,68,.14);color:var(--r)}
.ta-fav.on{background:rgba(239,68,68,.28);color:var(--r)}

/* PLAYING INDICATOR */
.play-ind{
  display:flex;align-items:flex-end;gap:2px;height:16px;
  position:absolute;right:12px;top:50%;transform:translateY(-50%);
}
.pi-bar{width:3px;background:var(--p2);border-radius:2px;animation:pi .6s ease infinite alternate}
.pi-bar:nth-child(1){animation-delay:0s}.pi-bar:nth-child(2){animation-delay:.15s}.pi-bar:nth-child(3){animation-delay:.3s}
@keyframes pi{from{height:3px}to{height:14px}}
.pi-bar.paused{animation-play-state:paused;height:4px}

/* GRID VIEW */
.grid-view{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.gc{
  background:var(--c1);border:1px solid var(--bd);border-radius:16px;
  padding:12px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;
}
.gc:active{transform:scale(.95)}
.gc.playing{border-color:var(--p)}
.gc-art{
  width:100%;aspect-ratio:1;border-radius:10px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;
  font-size:36px;margin-bottom:10px;overflow:hidden;
}
.gc-art img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.gc-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.gc-artist{font-size:11px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ARTIST / ALBUM SECTION */
.section-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.sg-item{
  background:var(--c1);border:1px solid var(--bd);border-radius:14px;
  padding:14px 12px;cursor:pointer;transition:all .2s;text-align:center;
}
.sg-item:active{transform:scale(.95);background:var(--c2)}
.sg-ico{font-size:32px;margin-bottom:8px;display:block}
.sg-name{font-size:13px;font-weight:700;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sg-cnt{font-size:11px;color:var(--t2)}

/* ============================================================
   PLAYER PAGE
============================================================ */
.player-page{
  display:flex;flex-direction:column;align-items:center;
  padding-top:8px;
}

/* ART */
.art-container{
  position:relative;width:260px;height:260px;
  margin:0 auto 24px;
}
.art-glow{
  position:absolute;inset:-20px;
  background:radial-gradient(circle,var(--dyn1) 0%,transparent 65%);
  opacity:.45;filter:blur(20px);
  animation:glow-pulse 3s ease-in-out infinite;
  transition:background 1s;
}
@keyframes glow-pulse{0%,100%{opacity:.3;transform:scale(.9)}50%{opacity:.55;transform:scale(1.05)}}
.art-frame{
  position:relative;width:260px;height:260px;border-radius:28px;
  overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.6);
  background:linear-gradient(135deg,var(--p4),var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:80px;
}
.art-frame img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.art-frame.spin{animation:art-rot 20s linear infinite}
@keyframes art-rot{to{border-radius:50%}}
.art-ring{
  position:absolute;inset:-6px;border-radius:34px;
  border:2px solid rgba(139,92,246,.3);
  animation:ring-rot 10s linear infinite;opacity:0;transition:opacity .5s;
}
.art-ring.show{opacity:1}
@keyframes ring-rot{to{transform:rotate(360deg)}}

/* TRACK INFO */
.track-title{
  font-size:21px;font-weight:800;text-align:center;
  margin-bottom:4px;padding:0 20px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  max-width:100%;
}
.track-artist{font-size:14px;color:var(--t2);text-align:center;margin-bottom:4px}
.track-album{font-size:12px;color:var(--t2);opacity:.7;text-align:center;margin-bottom:20px}

/* SPECTRUM */
.spectrum{
  display:flex;align-items:flex-end;justify-content:center;
  gap:2px;height:40px;width:100%;padding:0 20px;margin-bottom:18px;
  overflow:hidden;
}
.sp-bar{
  flex:1;max-width:6px;
  background:linear-gradient(to top,var(--p3),var(--p2));
  border-radius:3px 3px 1px 1px;
  min-height:3px;transition:height .08s ease;opacity:.7;
}

/* SEEK */
.seek-wrap{width:100%;padding:0 4px;margin-bottom:6px;cursor:pointer;touch-action:none}
.seek-track{
  height:5px;background:rgba(255,255,255,.1);
  border-radius:3px;position:relative;overflow:visible;
}
.seek-fill{
  height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));
  border-radius:3px;width:0%;position:relative;transition:none;
}
.seek-thumb{
  position:absolute;right:-8px;top:-5.5px;
  width:16px;height:16px;background:#fff;border-radius:50%;
  box-shadow:0 0 10px rgba(139,92,246,.7);
  opacity:0;transition:opacity .2s;
}
.seek-wrap:hover .seek-thumb,.seek-wrap.dragging .seek-thumb{opacity:1}
.seek-times{
  display:flex;justify-content:space-between;
  font-size:11px;color:var(--t2);margin-top:6px;padding:0 2px;
}

/* CONTROLS */
.ctrl-row{
  display:flex;align-items:center;justify-content:center;
  gap:12px;margin-bottom:16px;
}
.cb{
  border:none;background:transparent;color:var(--t);
  cursor:pointer;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;font-size:20px;
  width:44px;height:44px;
}
.cb:active{background:rgba(255,255,255,.08);transform:scale(.9)}
.cb.sm{width:38px;height:38px;font-size:18px;color:var(--t2)}
.cb.pp{
  width:68px;height:68px;font-size:28px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  box-shadow:0 6px 24px rgba(139,92,246,.48);
  color:#fff;
}
.cb.pp:active{transform:scale(.93)}
.cb.on{color:var(--p2)!important}

/* EXTRA ROW */
.extra-row{
  display:flex;align-items:center;justify-content:space-around;
  width:100%;padding:0 10px;margin-bottom:14px;
}
.eb{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  background:none;border:none;color:var(--t2);cursor:pointer;
  transition:all .2s;padding:6px;border-radius:12px;font-size:20px;
}
.eb span{font-size:10px;font-weight:700}
.eb.on{color:var(--p2)}
.eb:active{transform:scale(.9);background:rgba(255,255,255,.06)}

/* VOLUME */
.vol-row{
  display:flex;align-items:center;gap:10px;
  width:100%;padding:0 4px;margin-bottom:14px;
}
.vol-ico{font-size:15px;color:var(--t2);flex-shrink:0}
.vol-track{
  flex:1;height:4px;background:rgba(255,255,255,.1);
  border-radius:2px;cursor:pointer;position:relative;
}
.vol-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));border-radius:2px;width:80%}

/* EQ PANEL */
.eq-panel{
  width:100%;background:var(--c1);border:1px solid var(--bd);
  border-radius:18px;padding:16px;margin-bottom:14px;
  display:none;
}
.eq-panel.show{display:block}
.eq-title{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}
.eq-presets{display:flex;gap:6px;overflow-x:auto;margin-bottom:14px;padding-bottom:2px}
.eq-preset{
  flex-shrink:0;padding:6px 12px;
  background:var(--c2);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:12px;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.eq-preset.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.14)}
.eq-bands{display:flex;justify-content:space-around;align-items:flex-end;height:100px}
.eq-band{display:flex;flex-direction:column;align-items:center;gap:6px;width:40px}
.eq-slider{
  -webkit-appearance:none;appearance:none;
  writing-mode:vertical-lr;direction:rtl;
  width:4px;height:70px;
  background:rgba(255,255,255,.1);border-radius:2px;
  cursor:pointer;outline:none;
}
.eq-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:14px;height:14px;
  border-radius:50%;background:var(--p2);
  box-shadow:0 0 6px rgba(139,92,246,.5);
}
.eq-label{font-size:10px;color:var(--t2);font-weight:700}

/* ============================================================
   PLAYLIST PAGE
============================================================ */
.pl-header{
  display:flex;align-items:center;justify-content:space-between;
  margin:4px 0 14px;
}
.pl-title{font-size:18px;font-weight:800}
.add-pl-btn{
  padding:8px 14px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:11px;color:#fff;font-size:13px;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.add-pl-btn:active{transform:scale(.95)}
.pl-card{
  background:var(--c1);border:1px solid var(--bd);border-radius:16px;
  padding:14px;display:flex;align-items:center;gap:12px;
  margin-bottom:10px;cursor:pointer;transition:all .2s;
}
.pl-card:active{background:var(--c2);transform:scale(.98)}
.pl-art{
  width:52px;height:52px;border-radius:12px;
  background:linear-gradient(135deg,var(--p3),var(--pk));
  display:flex;align-items:center;justify-content:center;
  font-size:24px;flex-shrink:0;
}
.pl-info{flex:1;min-width:0}
.pl-name{font-size:15px;font-weight:700;margin-bottom:3px}
.pl-cnt{font-size:12px;color:var(--t2)}
.pl-acts{display:flex;gap:6px}
.pa{width:30px;height:30px;border:none;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.pa:active{transform:scale(.87)}
.pa-play{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff}
.pa-del{background:rgba(239,68,68,.14);color:var(--r)}

/* SMART PLAYLIST */
.smart-pl{
  background:linear-gradient(135deg,rgba(139,92,246,.12),rgba(59,130,246,.08));
  border:1px solid rgba(139,92,246,.25);
}

/* ============================================================
   SETTINGS PAGE
============================================================ */
.settings-section{
  background:var(--c1);border:1px solid var(--bd);
  border-radius:18px;margin-bottom:14px;overflow:hidden;
}
.ss-title{
  font-size:12px;font-weight:800;color:var(--t2);text-transform:uppercase;
  letter-spacing:1px;padding:14px 16px 8px;
}
.ss-row{
  display:flex;align-items:center;gap:12px;
  padding:13px 16px;border-top:1px solid var(--bd);cursor:pointer;
  transition:background .18s;
}
.ss-row:active{background:var(--c2)}
.ss-ico{font-size:18px;width:28px;text-align:center;flex-shrink:0}
.ss-label{flex:1;font-size:14px;font-weight:600}
.ss-val{font-size:12px;color:var(--t2)}
.ss-arr{color:var(--t2);font-size:16px}
.toggle{
  width:44px;height:26px;background:var(--c3);border-radius:13px;
  position:relative;cursor:pointer;transition:background .25s;flex-shrink:0;
}
.toggle.on{background:var(--p)}
.toggle::after{
  content:'';position:absolute;top:3px;left:3px;
  width:20px;height:20px;background:#fff;border-radius:50%;
  transition:transform .25s;box-shadow:0 2px 6px rgba(0,0,0,.3);
}
.toggle.on::after{transform:translateX(18px)}

/* THEME COLORS */
.theme-colors{display:flex;gap:10px;padding:12px 16px;flex-wrap:wrap}
.theme-c{
  width:32px;height:32px;border-radius:50%;cursor:pointer;
  transition:all .2s;border:2px solid transparent;
}
.theme-c.on{border-color:#fff;transform:scale(1.15)}
.theme-c:active{transform:scale(.9)}

/* SLEEP TIMER */
.sleep-btns{display:flex;gap:8px;padding:12px 16px;overflow-x:auto}
.sleep-btn{
  flex-shrink:0;padding:8px 14px;
  background:var(--c2);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:13px;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.sleep-btn.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.14)}

/* SPEED */
.speed-btns{display:flex;gap:6px;padding:12px 16px;overflow-x:auto}
.speed-btn{
  flex-shrink:0;padding:8px 12px;
  background:var(--c2);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:12px;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.speed-btn.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.14)}

/* STATS */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px 16px}
.stat-item{background:var(--c2);border-radius:12px;padding:12px;text-align:center}
.stat-n{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--p),var(--b));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-l{font-size:11px;color:var(--t2);margin-top:3px}

/* ============================================================
   QUEUE PANEL (slide up)
============================================================ */
.queue-panel{
  position:fixed;bottom:0;left:0;right:0;z-index:500;
  max-width:430px;margin:0 auto;
  background:rgba(14,14,30,.97);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-top:1px solid var(--bd2);
  border-radius:24px 24px 0 0;
  transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
  max-height:75vh;display:flex;flex-direction:column;
}
.queue-panel.show{transform:translateY(0)}
.qp-handle{
  width:40px;height:4px;background:var(--bd2);
  border-radius:2px;margin:10px auto 0;flex-shrink:0;cursor:pointer;
}
.qp-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px;flex-shrink:0;border-bottom:1px solid var(--bd);
}
.qp-title{font-size:16px;font-weight:800}
.qp-list{overflow-y:auto;flex:1;padding:10px 18px 20px}
.qi{
  display:flex;align-items:center;gap:10px;
  padding:9px 10px;border-radius:12px;cursor:pointer;transition:all .18s;
  margin-bottom:6px;
}
.qi.active{background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.25)}
.qi:active{background:var(--c2)}
.qi-num{width:22px;text-align:center;font-size:12px;color:var(--t2);font-weight:700;flex-shrink:0}
.qi-art{
  width:38px;height:38px;border-radius:9px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;overflow:hidden;
}
.qi-art img{width:100%;height:100%;object-fit:cover;border-radius:9px}
.qi-info{flex:1;min-width:0}
.qi-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qi-artist{font-size:11px;color:var(--t2)}
.qi-dur{font-size:11px;color:var(--t2);flex-shrink:0}
.qi-rm{
  width:26px;height:26px;background:rgba(239,68,68,.12);border:none;
  border-radius:7px;color:var(--r);font-size:13px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.qi-rm:active{transform:scale(.87)}

/* ============================================================
   MINI PLAYER
============================================================ */
.mini-player{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  max-width:430px;margin:0 auto;
  background:rgba(12,12,28,.97);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-top:1px solid var(--bd);
  transform:translateY(100%);transition:transform .32s cubic-bezier(.4,0,.2,1);
}
.mini-player.show{transform:translateY(0)}
.mp-prog{height:3px;background:rgba(255,255,255,.07);cursor:pointer;overflow:hidden}
.mp-prog-fill{
  height:100%;
  background:linear-gradient(90deg,var(--p3),var(--p2));
  width:0%;transition:width .4s linear;
}
.mp-body{
  display:flex;align-items:center;gap:12px;
  padding:10px 16px;
  padding-bottom:max(10px,var(--safe-bot));
}
.mp-art{
  width:42px;height:42px;border-radius:10px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;overflow:hidden;cursor:pointer;
}
.mp-art img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.mp-info{flex:1;min-width:0;cursor:pointer}
.mp-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mp-artist{font-size:11px;color:var(--t2)}
.mp-bars{display:flex;align-items:flex-end;gap:2px;height:12px;margin-top:3px}
.mpb{width:3px;background:var(--p2);border-radius:2px;animation:mpba .6s ease infinite alternate}
.mpb:nth-child(1){animation-delay:0s}.mpb:nth-child(2){animation-delay:.15s}.mpb:nth-child(3){animation-delay:.3s}.mpb:nth-child(4){animation-delay:.45s}
@keyframes mpba{from{height:2px}to{height:10px}}
.mp-bars.paused .mpb{animation-play-state:paused;height:3px}
.mp-ctrls{display:flex;gap:4px;align-items:center}
.mc{
  width:34px;height:34px;border:none;background:transparent;
  color:var(--t);font-size:17px;cursor:pointer;border-radius:50%;
  display:flex;align-items:center;justify-content:center;transition:all .15s;
}
.mc:active{background:rgba(255,255,255,.08)}
.mc.pp{
  width:40px;height:40px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  box-shadow:0 3px 12px rgba(139,92,246,.4);
}

/* ============================================================
   MODALS
============================================================ */
.modal-overlay{
  position:fixed;inset:0;z-index:800;
  background:rgba(0,0,0,.7);backdrop-filter:blur(8px);
  display:none;align-items:flex-end;justify-content:center;
}
.modal-overlay.show{display:flex}
.modal{
  width:100%;max-width:430px;
  background:var(--c2);border-radius:24px 24px 0 0;
  padding:20px 20px max(20px,var(--safe-bot));
  animation:modal-up .3s cubic-bezier(.4,0,.2,1);
}
@keyframes modal-up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--bd2);border-radius:2px;margin:0 auto 16px}
.modal-title{font-size:17px;font-weight:800;margin-bottom:16px}
.modal-input{
  width:100%;padding:13px 14px;
  background:var(--dark);border:1.5px solid var(--bd);
  border-radius:13px;color:var(--t);font-size:15px;
  outline:none;-webkit-appearance:none;font-family:inherit;
  margin-bottom:14px;
}
.modal-input::placeholder{color:var(--t2)}
.modal-input:focus{border-color:var(--p)}
.modal-btn{
  width:100%;padding:14px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:14px;color:#fff;
  font-size:15px;font-weight:700;cursor:pointer;
  margin-bottom:10px;transition:all .2s;
}
.modal-btn:active{transform:scale(.97)}
.modal-btn2{
  width:100%;padding:13px;
  background:var(--c3);border:1px solid var(--bd);
  border-radius:14px;color:var(--t);
  font-size:15px;font-weight:600;cursor:pointer;
}
.modal-btn2:active{background:var(--c4)}

/* CONTEXT MENU */
.ctx-menu{
  position:fixed;z-index:900;
  background:var(--c2);border:1px solid var(--bd2);
  border-radius:18px;padding:8px;min-width:200px;
  box-shadow:0 16px 40px rgba(0,0,0,.5);
  display:none;
}
.ctx-menu.show{display:block}
.ctx-item{
  display:flex;align-items:center;gap:10px;
  padding:11px 12px;border-radius:11px;cursor:pointer;
  font-size:14px;font-weight:600;transition:background .15s;
}
.ctx-item:active{background:var(--c3)}
.ctx-item .ci-ico{font-size:16px;width:22px;text-align:center}
.ctx-item.red{color:var(--r)}

/* ============================================================
   TOAST
============================================================ */
.toast{
  position:fixed;top:max(70px,calc(var(--safe-top) + 70px));
  left:50%;transform:translateX(-50%) translateY(-10px);
  background:var(--c2);color:var(--t);
  padding:10px 18px;border-radius:22px;
  font-size:13px;font-weight:600;
  border:1px solid var(--bd2);z-index:1000;
  opacity:0;transition:all .25s;
  white-space:nowrap;pointer-events:none;
  backdrop-filter:blur(12px);max-width:88vw;text-align:center;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* LOADING */
.ldg{display:none;text-align:center;padding:48px 0}
.ldg.show{display:block}
.spin-c{
  width:44px;height:44px;border:3px solid rgba(139,92,246,.15);
  border-top-color:var(--p);border-radius:50%;
  animation:sp .65s linear infinite;margin:0 auto 12px;
}
@keyframes sp{to{transform:rotate(360deg)}}

/* EMPTY */
.empty{text-align:center;padding:52px 20px}
.eico{font-size:52px;display:block;margin-bottom:14px}
.etit{font-size:18px;font-weight:700;margin-bottom:8px}
.esub{font-size:13px;color:var(--t2);line-height:1.65}

/* PWA PROMPT */
.pwa-prompt{
  background:linear-gradient(135deg,rgba(139,92,246,.12),rgba(59,130,246,.08));
  border:1px solid rgba(139,92,246,.25);border-radius:16px;
  padding:14px 16px;margin-bottom:14px;
  display:flex;align-items:center;gap:12px;
}
.pwa-ico{font-size:24px;flex-shrink:0}
.pwa-txt{flex:1;font-size:12px;color:var(--t2);line-height:1.55}
.pwa-txt b{color:var(--t)}
.pwa-close{
  width:24px;height:24px;background:var(--c3);border:none;
  border-radius:6px;color:var(--t2);font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
</style>
</head>
<body>

<!-- DYNAMIC BG -->
<div class="dyn-bg2"></div>
<div class="dyn-bg" id="dynBg"></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- CONTEXT MENU -->
<div class="ctx-menu" id="ctxMenu">
  <div class="ctx-item" onclick="ctxPlay()"><span class="ci-ico">‚ñ∂Ô∏è</span>≈ûimdi √áal</div>
  <div class="ctx-item" onclick="ctxPlayNext()"><span class="ci-ico">‚è≠</span>Sƒ±radaki √áal</div>
  <div class="ctx-item" onclick="ctxAddQueue()"><span class="ci-ico">üìã</span>Sƒ±raya Ekle</div>
  <div class="ctx-item" onclick="ctxAddPlaylist()"><span class="ci-ico">‚ûï</span>Playliste Ekle</div>
  <div class="ctx-item" onclick="ctxTogFav()"><span class="ci-ico" id="ctxFavIco">‚ù§Ô∏è</span><span id="ctxFavTxt">Favorilere Ekle</span></div>
  <div class="ctx-item red" onclick="ctxRemove()"><span class="ci-ico">üóëÔ∏è</span>Listeden Kaldƒ±r</div>
</div>

<!-- MODAL OVERLAY -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">Yeni Playlist</div>
    <input class="modal-input" id="modalInput" type="text" placeholder="Playlist adƒ±...">
    <button class="modal-btn" onclick="modalConfirm()">‚úÖ Olu≈ütur</button>
    <button class="modal-btn2" onclick="closeModal()">ƒ∞ptal</button>
  </div>
</div>

<!-- QUEUE PANEL -->
<div class="queue-panel" id="queuePanel">
  <div class="qp-handle" onclick="closeQueue()"></div>
  <div class="qp-header">
    <div class="qp-title">üìã √áalma Sƒ±rasƒ±</div>
    <div style="display:flex;gap:8px">
      <button onclick="shuffleQueue()" style="background:var(--c3);border:none;border-radius:9px;color:var(--t2);padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">üîÄ Karƒ±≈ütƒ±r</button>
      <button onclick="clearQueue()" style="background:rgba(239,68,68,.12);border:none;border-radius:9px;color:var(--r);padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">Temizle</button>
    </div>
  </div>
  <div class="qp-list" id="qpList"></div>
</div>

<div class="shell">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-ico">üéµ</div>
      <div class="brand-txt">M√ºzik<b>Box</b> <span style="font-size:12px;color:var(--p2);font-weight:700">Pro</span></div>
    </div>
    <div class="topbar-right">
      <div class="icon-btn" onclick="showQueue()">üìã</div>
      <div class="lib-badge" id="libBadge">0</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab on"  onclick="goTab('lib',this)"><i>üéµ</i>Kitaplƒ±k</div>
    <div class="tab"     onclick="goTab('player',this)"><i>üéß</i>√áalar</div>
    <div class="tab"     onclick="goTab('playlist',this)"><i>üìã</i>Listeler</div>
    <div class="tab"     onclick="goTab('settings',this)"><i>‚öôÔ∏è</i>Ayarlar</div>
  </div>

  <!-- PAGES -->
  <div class="pages">

    <!-- ========== Kƒ∞TAPLIK ========== -->
    <div class="pg on" id="pg-lib">

      <!-- PWA PROMPT -->
      <div class="pwa-prompt" id="pwaPrompt">
        <div class="pwa-ico">üì≤</div>
        <div class="pwa-txt"><b>Ana Ekrana Ekle!</b><br>Payla≈ü ‚Üí Ana Ekrana Ekle ‚Üí Tam uygulama deneyimi</div>
        <button class="pwa-close" onclick="document.getElementById('pwaPrompt').style.display='none'">‚úï</button>
      </div>

      <!-- FOLDER AREA -->
      <div id="folderArea">
        <div class="welcome">
          <div class="welcome-ico">üìÅ</div>
          <div class="welcome-title">M√ºzik Klas√∂r√ºn√º Se√ß</div>
          <div class="welcome-sub">iPhone'daki MP3 klas√∂r√ºn√º se√ß,<br>≈üarkƒ±larƒ±n otomatik y√ºklensin!</div>
          <button class="folder-btn" onclick="selectFolder()">üìÅ Klas√∂r Se√ß</button>
          <button class="folder-btn2" onclick="selectFiles()">üéµ Dosya Se√ß</button>
          <div class="how-steps">
            <div class="hs-title">üìñ Nasƒ±l Kullanƒ±lƒ±r?</div>
            <div class="hs-row"><div class="hs-n">1</div><div class="hs-t"><b>Dosyalar</b> uygulamasƒ±nda "M√ºziklerim" klas√∂r√º olu≈ütur</div></div>
            <div class="hs-row"><div class="hs-n">2</div><div class="hs-t">ƒ∞nternetten MP3 indirip bu klas√∂re ta≈üƒ±</div></div>
            <div class="hs-row"><div class="hs-n">3</div><div class="hs-t">Yukarƒ±daki <b>Klas√∂r Se√ß</b> butonuyla o klas√∂r√º se√ß</div></div>
            <div class="hs-row"><div class="hs-n">4</div><div class="hs-t">≈ûarkƒ±lar otomatik y√ºklenir, <b>√ßalmaya ba≈üla!</b></div></div>
          </div>
        </div>
      </div>

      <!-- LIBRARY AREA (after folder selected) -->
      <div id="libraryArea" style="display:none">
        <div class="lib-toolbar">
          <div class="lib-search-wrap">
            <span class="lib-sico">üîç</span>
            <input class="lib-sinp" id="libSearch" type="text" placeholder="≈ûarkƒ±, sanat√ßƒ±, alb√ºm..." oninput="filterLib(this.value)">
          </div>
          <div class="sort-btn" onclick="cycleSortLib()">‚áÖ <span id="sortLbl">A-Z</span></div>
          <div class="icon-btn" onclick="cycleView()">‚äû</div>
        </div>

        <div class="view-tabs">
          <div class="vt on" onclick="setViewTab(this,'all')">üéµ T√ºm√º</div>
          <div class="vt" onclick="setViewTab(this,'artist')">üë§ Sanat√ßƒ±</div>
          <div class="vt" onclick="setViewTab(this,'album')">üíø Alb√ºm</div>
          <div class="vt" onclick="setViewTab(this,'genre')">üé∏ T√ºr</div>
          <div class="vt" onclick="setViewTab(this,'fav')">‚ù§Ô∏è Favoriler</div>
          <div class="vt" onclick="setViewTab(this,'recent')">üïê Son √áalƒ±nan</div>
        </div>

        <!-- Loading -->
        <div class="ldg" id="scanLdg"><div class="spin-c"></div><div style="color:var(--t2);font-size:13px" id="scanTxt">Taranƒ±yor...</div></div>

        <!-- Track list / grid -->
        <div id="trackContainer"></div>

        <div style="text-align:center;margin-top:16px">
          <button onclick="selectFolder()" style="background:var(--c1);border:1px solid var(--bd);color:var(--t2);padding:10px 18px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer">üìÅ Klas√∂r√º Deƒüi≈ütir</button>
        </div>
      </div>
    </div>

    <!-- ========== PLAYER ========== -->
    <div class="pg" id="pg-player">
      <div class="player-page">

        <!-- ART -->
        <div class="art-container">
          <div class="art-glow" id="artGlow"></div>
          <div class="art-frame" id="artFrame">
            <span id="artEmoji">üéµ</span>
            <img id="artImg" style="display:none">
          </div>
          <div class="art-ring" id="artRing"></div>
        </div>

        <div class="track-title" id="playerTitle">≈ûarkƒ± Se√ßilmedi</div>
        <div class="track-artist" id="playerArtist">‚Äî Kitaplƒ±ktan ≈üarkƒ± se√ß ‚Äî</div>
        <div class="track-album" id="playerAlbum"></div>

        <!-- SPECTRUM -->
        <div class="spectrum" id="spectrum"></div>

        <!-- SEEK -->
        <div class="seek-wrap" id="seekWrap">
          <div class="seek-track">
            <div class="seek-fill" id="seekFill">
              <div class="seek-thumb"></div>
            </div>
          </div>
          <div class="seek-times">
            <span id="curTime">0:00</span>
            <span id="durTime">0:00</span>
          </div>
        </div>

        <!-- MAIN CONTROLS -->
        <div class="ctrl-row">
          <button class="cb sm" onclick="prevTr()" title="√ñnceki">‚èÆ</button>
          <button class="cb sm" onclick="skipBack()" title="-10sn">‚Ü©</button>
          <button class="cb pp" id="ppBtn" onclick="togPP()">‚ñ∂</button>
          <button class="cb sm" onclick="skipFwd()" title="+10sn">‚Ü™</button>
          <button class="cb sm" onclick="nextTr()" title="Sonraki">‚è≠</button>
        </div>

        <!-- EXTRA -->
        <div class="extra-row">
          <button class="eb" id="shuffleBtn" onclick="togShuffle()">üîÄ<span>Karƒ±≈ütƒ±r</span></button>
          <button class="eb" id="repeatBtn" onclick="togRepeat()">üîÅ<span>Tekrar</span></button>
          <button class="eb" id="favBtn" onclick="togFavCurrent()">‚ô°<span>Favori</span></button>
          <button class="eb" id="eqBtn" onclick="togEQ()">üéõ<span>EQ</span></button>
          <button class="eb" id="sleepBtn" onclick="openSleepTimer()">üò¥<span>Zamanlayƒ±cƒ±</span></button>
        </div>

        <!-- EQ PANEL -->
        <div class="eq-panel" id="eqPanel">
          <div class="eq-title">
            <span>üéõ Ekolayzer</span>
            <button onclick="resetEQ()" style="background:var(--c3);border:none;border-radius:8px;color:var(--t2);padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer">Sƒ±fƒ±rla</button>
          </div>
          <div class="eq-presets" id="eqPresets"></div>
          <div class="eq-bands" id="eqBands"></div>
        </div>

        <!-- VOLUME -->
        <div class="vol-row">
          <span class="vol-ico">üîà</span>
          <div class="vol-track" id="volTrack" onclick="setVol(event)">
            <div class="vol-fill" id="volFill"></div>
          </div>
          <span class="vol-ico">üîä</span>
        </div>

        <!-- SPEED -->
        <div style="text-align:center;margin-bottom:8px">
          <span style="font-size:11px;color:var(--t2);font-weight:700">HIZI: </span>
          <span style="font-size:13px;font-weight:800;color:var(--p2)" id="speedLbl">1.0x</span>
        </div>
        <div class="speed-btns" style="padding:0;margin-bottom:16px">
          <div class="speed-btn" onclick="setSpeed(.5)">0.5x</div>
          <div class="speed-btn" onclick="setSpeed(.75)">0.75x</div>
          <div class="speed-btn on" onclick="setSpeed(1)">1x</div>
          <div class="speed-btn" onclick="setSpeed(1.25)">1.25x</div>
          <div class="speed-btn" onclick="setSpeed(1.5)">1.5x</div>
          <div class="speed-btn" onclick="setSpeed(2)">2x</div>
        </div>

      </div>
    </div>

    <!-- ========== PLAYLIST ========== -->
    <div class="pg" id="pg-playlist">
      <div class="pl-header">
        <div class="pl-title">üìã √áalma Listeleri</div>
        <button class="add-pl-btn" onclick="openCreatePlaylist()">+ Yeni</button>
      </div>

      <!-- Smart playlists -->
      <div class="slbl">‚ú® Akƒ±llƒ± Listeler</div>
      <div id="smartPlaylists"></div>

      <!-- Manual playlists -->
      <div class="slbl">üìÅ Listelerim</div>
      <div id="manualPlaylists"></div>
    </div>

    <!-- ========== SETTINGS ========== -->
    <div class="pg" id="pg-settings">

      <!-- STATS -->
      <div class="settings-section">
        <div class="ss-title">üìä ƒ∞statistikler</div>
        <div class="stat-grid" id="statsGrid"></div>
      </div>

      <!-- FOLDER -->
      <div class="settings-section">
        <div class="ss-title">üìÅ Klas√∂r</div>
        <div class="ss-row" onclick="selectFolder()">
          <div class="ss-ico">üìÇ</div>
          <div class="ss-label">Klas√∂r√º Deƒüi≈ütir</div>
          <div class="ss-arr">‚Ä∫</div>
        </div>
        <div class="ss-row" onclick="selectFiles()">
          <div class="ss-ico">üéµ</div>
          <div class="ss-label">Dosya Ekle</div>
          <div class="ss-arr">‚Ä∫</div>
        </div>
        <div class="ss-row">
          <div class="ss-ico">üíæ</div>
          <div class="ss-label">Klas√∂r Adƒ±</div>
          <div class="ss-val" id="folderNameDisplay">‚Äî</div>
        </div>
      </div>

      <!-- PLAYBACK -->
      <div class="settings-section">
        <div class="ss-title">üéµ Oynatma</div>
        <div class="ss-row" onclick="togSetting('crossfade')">
          <div class="ss-ico">üîÄ</div>
          <div class="ss-label">Crossfade</div>
          <div class="toggle" id="tog-crossfade"></div>
        </div>
        <div class="ss-row" onclick="togSetting('normalize')">
          <div class="ss-ico">üìä</div>
          <div class="ss-label">Ses Normalize</div>
          <div class="toggle" id="tog-normalize"></div>
        </div>
        <div class="ss-row" onclick="togSetting('gapless')">
          <div class="ss-ico">‚ñ∂‚ñ∂</div>
          <div class="ss-label">Gapless Oynatma</div>
          <div class="toggle" id="tog-gapless"></div>
        </div>
        <div class="ss-row" onclick="togSetting('autoplay')">
          <div class="ss-ico">üîÑ</div>
          <div class="ss-label">Otomatik Oynat</div>
          <div class="toggle" id="tog-autoplay"></div>
        </div>
      </div>

      <!-- SLEEP TIMER -->
      <div class="settings-section">
        <div class="ss-title">üò¥ Uyku Zamanlayƒ±cƒ±sƒ±</div>
        <div class="sleep-btns" id="sleepBtns">
          <div class="sleep-btn" onclick="setSleep(0)">Kapalƒ±</div>
          <div class="sleep-btn" onclick="setSleep(15)">15 dk</div>
          <div class="sleep-btn" onclick="setSleep(30)">30 dk</div>
          <div class="sleep-btn" onclick="setSleep(45)">45 dk</div>
          <div class="sleep-btn" onclick="setSleep(60)">60 dk</div>
          <div class="sleep-btn" onclick="setSleep(90)">90 dk</div>
        </div>
        <div class="ss-row">
          <div class="ss-ico">‚è±</div>
          <div class="ss-label">Kalan S√ºre</div>
          <div class="ss-val" id="sleepDisplay">‚Äî</div>
        </div>
      </div>

      <!-- THEME -->
      <div class="settings-section">
        <div class="ss-title">üé® Tema Rengi</div>
        <div class="theme-colors" id="themeColors"></div>
      </div>

      <!-- DISPLAY -->
      <div class="settings-section">
        <div class="ss-title">üëÅ G√∂r√ºn√ºm</div>
        <div class="ss-row" onclick="togSetting('spectrum')">
          <div class="ss-ico">üìä</div>
          <div class="ss-label">Spektrum G√∂rsel</div>
          <div class="toggle" id="tog-spectrum"></div>
        </div>
        <div class="ss-row" onclick="togSetting('dynbg')">
          <div class="ss-ico">üé®</div>
          <div class="ss-label">Dinamik Arka Plan</div>
          <div class="toggle" id="tog-dynbg"></div>
        </div>
      </div>

      <!-- ABOUT -->
      <div class="settings-section">
        <div class="ss-title">‚ÑπÔ∏è Hakkƒ±nda</div>
        <div class="ss-row"><div class="ss-ico">üéµ</div><div class="ss-label">M√ºzikBox Pro</div><div class="ss-val">v1.0</div></div>
        <div class="ss-row" onclick="clearCache()"><div class="ss-ico">üóëÔ∏è</div><div class="ss-label">√ñnbelleƒüi Temizle</div><div class="ss-arr">‚Ä∫</div></div>
      </div>

    </div>
  </div><!-- /pages -->
</div><!-- /shell -->

<!-- MINI PLAYER -->
<div class="mini-player" id="miniPlayer">
  <div class="mp-prog" id="mpProg" onclick="miniSeek(event)">
    <div class="mp-prog-fill" id="mpFill"></div>
  </div>
  <div class="mp-body">
    <div class="mp-art" id="mpArt" onclick="goTab('player',document.querySelectorAll('.tab')[1])">üéµ</div>
    <div class="mp-info" onclick="goTab('player',document.querySelectorAll('.tab')[1])">
      <div class="mp-title" id="mpTitle">‚Äî</div>
      <div class="mp-bars" id="mpBars">
        <div class="mpb"></div><div class="mpb"></div><div class="mpb"></div><div class="mpb"></div>
      </div>
    </div>
    <div class="mp-ctrls">
      <button class="mc" onclick="prevTr()">‚èÆ</button>
      <button class="mc pp" id="mpPP" onclick="togPP()">‚ñ∂</button>
      <button class="mc" onclick="nextTr()">‚è≠</button>
    </div>
  </div>
</div>

<!-- AUDIO -->
<audio id="aud" preload="auto"></audio>

<script>
'use strict';

/* ============================================================
   STATE
============================================================ */
let tracks      = [];       // all loaded tracks
let queue       = [];       // playback queue
let ci          = -1;       // current index in queue
let playing     = false;
let shuffle     = false;
let repeat      = 0;        // 0=off 1=all 2=one
let vol         = 0.85;
let speed       = 1;
let libView     = 'list';   // list | grid
let libSort     = 'title';  // title | artist | album | duration | plays
let libViewTab  = 'all';
let libFilter   = '';
let favorites   = new Set(JSON.parse(localStorage.getItem('mb_favs') || '[]'));
let playlists   = JSON.parse(localStorage.getItem('mb_pls')  || '[]');
let settings    = JSON.parse(localStorage.getItem('mb_sets') || '{}');
let playHistory = JSON.parse(localStorage.getItem('mb_hist') || '[]');
let playCounts  = JSON.parse(localStorage.getItem('mb_counts') || '{}');
let sleepTimer  = null;
let sleepEnd    = 0;
let ctxTrack    = null;
let ctxEl       = null;
let folderName  = localStorage.getItem('mb_folder') || '';
let audioCtx    = null;
let analyser    = null;
let source      = null;
let eqFilters   = [];
let animFrame   = null;
let seekDragging= false;
let crossfadeTimer = null;

// Default settings
const DEF_SETS = {
  crossfade:false, normalize:false, gapless:false,
  autoplay:true, spectrum:true, dynbg:true
};
settings = { ...DEF_SETS, ...settings };

const aud = document.getElementById('aud');
aud.volume = vol;

/* ============================================================
   TABS
============================================================ */
function goTab(id, el) {
  document.querySelectorAll('.pg').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.getElementById('pg-' + id).classList.add('on');
  if (el) el.classList.add('on');
  if (id === 'playlist') renderPlaylists();
  if (id === 'settings') renderSettings();
  if (id === 'lib')      renderLib();
}

/* ============================================================
   FILE SYSTEM
============================================================ */
async function selectFolder() {
  try {
    if ('showDirectoryPicker' in window) {
      const dh = await window.showDirectoryPicker({ mode: 'read' });
      folderName = dh.name;
      localStorage.setItem('mb_folder', folderName);
      document.getElementById('folderNameDisplay').textContent = folderName;
      await scanDirectory(dh);
    } else {
      // Fallback: file input
      selectFiles();
    }
  } catch (e) {
    if (e.name !== 'AbortError') showToast('‚ùå ' + e.message);
  }
}

async function scanDirectory(dirHandle, path = '') {
  showScanLoading(true);
  tracks = [];
  let count = 0;
  await scanDir(dirHandle, path, count);
  showScanLoading(false);
  afterLoad();
}

async function scanDir(dirHandle, path, count) {
  for await (const [name, handle] of dirHandle.entries()) {
    if (handle.kind === 'file') {
      const ext = name.split('.').pop().toLowerCase();
      if (['mp3', 'm4a', 'aac', 'wav', 'ogg', 'flac', 'opus', 'weba'].includes(ext)) {
        try {
          const file = await handle.getFile();
          const track = await buildTrack(file, path);
          tracks.push(track);
          count++;
          document.getElementById('scanTxt').textContent = `${count} ≈üarkƒ± bulundu...`;
        } catch {}
      }
    } else if (handle.kind === 'directory') {
      await scanDir(handle, path ? path + '/' + name : name, count);
    }
  }
}

function selectFiles() {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.multiple = true;
  inp.accept = 'audio/*,.mp3,.m4a,.aac,.wav,.ogg,.flac,.opus';
  inp.onchange = async (e) => {
    const files = Array.from(e.target.files);
    showScanLoading(true);
    tracks = [];
    for (let i = 0; i < files.length; i++) {
      document.getElementById('scanTxt').textContent = `${i + 1}/${files.length} y√ºkleniyor...`;
      const track = await buildTrack(files[i], '');
      tracks.push(track);
    }
    showScanLoading(false);
    afterLoad();
  };
  inp.click();
}

/* ============================================================
   BUILD TRACK (ID3 parsing)
============================================================ */
async function buildTrack(file, path) {
  const url = URL.createObjectURL(file);
  const track = {
    id:      Math.random().toString(36).substr(2, 9),
    file:    file,
    url:     url,
    name:    file.name,
    path:    path,
    size:    file.size,
    format:  file.name.split('.').pop().toUpperCase(),
    title:   cleanName(file.name),
    artist:  'Bilinmeyen Sanat√ßƒ±',
    album:   'Bilinmeyen Alb√ºm',
    genre:   '',
    year:    '',
    track:   0,
    duration:0,
    cover:   null,
    plays:   playCounts[file.name] || 0,
  };

  // Parse ID3 tags
  try {
    const tags = await parseID3(file);
    if (tags.title)  track.title  = tags.title;
    if (tags.artist) track.artist = tags.artist;
    if (tags.album)  track.album  = tags.album;
    if (tags.genre)  track.genre  = tags.genre;
    if (tags.year)   track.year   = tags.year;
    if (tags.track)  track.track  = parseInt(tags.track) || 0;
    if (tags.cover)  track.cover  = tags.cover;
  } catch {}

  // Get duration
  try {
    const dur = await getAudioDuration(url);
    track.duration = dur;
  } catch {}

  return track;
}

function cleanName(filename) {
  return filename.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ').trim();
}

function getAudioDuration(url) {
  return new Promise((res, rej) => {
    const a = new Audio();
    a.addEventListener('loadedmetadata', () => res(a.duration));
    a.addEventListener('error', rej);
    a.src = url;
  });
}

/* ============================================================
   ID3 TAG PARSER (built-in, no library)
============================================================ */
async function parseID3(file) {
  const buf = await file.arrayBuffer();
  const view = new DataView(buf);
  const tags = {};

  // ID3v2
  if (buf.byteLength > 10) {
    const id3Header = String.fromCharCode(view.getUint8(0), view.getUint8(1), view.getUint8(2));
    if (id3Header === 'ID3') {
      const ver = view.getUint8(3);
      let size  = ((view.getUint8(6) & 0x7f) << 21) |
                  ((view.getUint8(7) & 0x7f) << 14) |
                  ((view.getUint8(8) & 0x7f) << 7)  |
                   (view.getUint8(9) & 0x7f);
      let offset = 10;
      const end  = Math.min(offset + size, buf.byteLength);

      while (offset < end - 10) {
        const fid = String.fromCharCode(
          view.getUint8(offset),view.getUint8(offset+1),
          view.getUint8(offset+2),view.getUint8(offset+3)
        );
        if (!/^[A-Z0-9]{4}$/.test(fid)) break;
        const fsize = ver >= 4
          ? ((view.getUint8(offset+4) & 0x7f) << 21)|((view.getUint8(offset+5) & 0x7f) << 14)|((view.getUint8(offset+6) & 0x7f) << 7)|(view.getUint8(offset+7) & 0x7f)
          : (view.getUint8(offset+4) << 24)|(view.getUint8(offset+5) << 16)|(view.getUint8(offset+6) << 8)|view.getUint8(offset+7);
        if (fsize <= 0 || fsize > 10000000) break;
        const dataStart = offset + 10;
        const dataEnd   = Math.min(dataStart + fsize, buf.byteLength);

        try {
          if (fid === 'TIT2' || fid === 'TT2') tags.title  = readTextFrame(buf, dataStart, dataEnd);
          if (fid === 'TPE1' || fid === 'TP1') tags.artist = readTextFrame(buf, dataStart, dataEnd);
          if (fid === 'TALB' || fid === 'TAL') tags.album  = readTextFrame(buf, dataStart, dataEnd);
          if (fid === 'TCON' || fid === 'TCO') tags.genre  = parseGenre(readTextFrame(buf, dataStart, dataEnd));
          if (fid === 'TDRC' || fid === 'TYER'|| fid === 'TYE') tags.year   = readTextFrame(buf, dataStart, dataEnd).substring(0,4);
          if (fid === 'TRCK' || fid === 'TRK') tags.track  = readTextFrame(buf, dataStart, dataEnd).split('/')[0];
          if (fid === 'APIC' || fid === 'PIC') tags.cover  = readCoverFrame(buf, dataStart, dataEnd, fid);
        } catch {}

        offset = dataEnd;
      }
    }
  }
  return tags;
}

function readTextFrame(buf, start, end) {
  const enc = new DataView(buf).getUint8(start);
  const bytes = new Uint8Array(buf, start + 1, end - start - 1);
  try {
    if (enc === 0) return new TextDecoder('iso-8859-1').decode(bytes).replace(/\0/g, '').trim();
    if (enc === 1 || enc === 2) return new TextDecoder('utf-16').decode(bytes).replace(/\0/g, '').trim();
    return new TextDecoder('utf-8').decode(bytes).replace(/\0/g, '').trim();
  } catch {
    return new TextDecoder('utf-8', { fatal: false }).decode(bytes).replace(/\0/g, '').trim();
  }
}

function readCoverFrame(buf, start, end, fid) {
  try {
    const dv    = new DataView(buf);
    const enc   = dv.getUint8(start);
    let offset  = start + 1;
    // mime type (null terminated)
    let mime = '';
    while (offset < end && dv.getUint8(offset) !== 0) { mime += String.fromCharCode(dv.getUint8(offset)); offset++; }
    offset++; // null
    const picType = dv.getUint8(offset); offset++;
    // description (null terminated)
    while (offset < end && dv.getUint8(offset) !== 0) offset++;
    offset++;
    if (enc === 1 || enc === 2) { while (offset < end && (dv.getUint8(offset) !== 0 || dv.getUint8(offset + 1) !== 0)) offset++; offset += 2; }
    const imgBytes = new Uint8Array(buf, offset, end - offset);
    const mimeType = mime.includes('png') ? 'image/png' : 'image/jpeg';
    const blob = new Blob([imgBytes], { type: mimeType });
    return URL.createObjectURL(blob);
  } catch { return null; }
}

const ID3_GENRES = ['Blues','Classic Rock','Country','Dance','Disco','Funk','Grunge','Hip-Hop','Jazz','Metal','New Age','Oldies','Other','Pop','R&B','Rap','Reggae','Rock','Techno','Industrial','Alternative','Ska','Death Metal','Pranks','Soundtrack','Euro-Techno','Ambient','Trip-Hop','Vocal','Jazz+Funk','Fusion','Trance','Classical','Instrumental','Acid','House','Game','Sound Clip','Gospel','Noise','Alternative Rock','Bass','Soul','Punk','Space','Meditative','Instrumental Pop','Instrumental Rock','Ethnic','Gothic','Darkwave','Techno-Industrial','Electronic','Pop-Folk','Eurodance','Dream','Southern Rock','Comedy','Cult','Gangsta','Top 40','Christian Rap','Pop/Funk','Jungle','Native US','Cabaret','New Wave','Psychadelic','Rave','Showtunes','Trailer','Lo-Fi','Tribal','Acid Punk','Acid Jazz','Polka','Retro','Musical','Rock & Roll','Hard Rock'];

function parseGenre(g) {
  if (!g) return '';
  const m = g.match(/^\((\d+)\)/);
  if (m) { const idx = parseInt(m[1]); return ID3_GENRES[idx] || g; }
  return g;
}

/* ============================================================
   AFTER LOAD
============================================================ */
function afterLoad() {
  if (!tracks.length) { showToast('‚ö†Ô∏è Desteklenen ses dosyasƒ± bulunamadƒ±'); return; }
  queue = [...tracks];
  document.getElementById('folderArea').style.display  = 'none';
  document.getElementById('libraryArea').style.display = 'block';
  updateBadge();
  renderLib();
  renderPlaylists();
  renderStats();
  showToast(`‚úÖ ${tracks.length} ≈üarkƒ± y√ºklendi`);
  if (settings.autoplay && ci === -1) { ci = 0; playIdx(0); }
}

function showScanLoading(show) {
  document.getElementById('scanLdg').classList.toggle('show', show);
  if (show) {
    document.getElementById('folderArea').style.display  = 'none';
    document.getElementById('libraryArea').style.display = 'block';
    document.getElementById('trackContainer').innerHTML  = '';
  }
}

/* ============================================================
   LIBRARY RENDER
============================================================ */
function setViewTab(el, tab) {
  document.querySelectorAll('.vt').forEach(v => v.classList.remove('on'));
  el.classList.add('on');
  libViewTab = tab;
  renderLib();
}

function filterLib(val) { libFilter = val.toLowerCase().trim(); renderLib(); }

const SORT_CYCLE = ['title','artist','album','duration','plays'];
const SORT_LABEL = { title:'A-Z', artist:'Sanat√ßƒ±', album:'Alb√ºm', duration:'S√ºre', plays:'√áalma' };
let sortIdx = 0;

function cycleSortLib() {
  sortIdx = (sortIdx + 1) % SORT_CYCLE.length;
  libSort = SORT_CYCLE[sortIdx];
  document.getElementById('sortLbl').textContent = SORT_LABEL[libSort];
  renderLib();
}

function cycleView() {
  libView = libView === 'list' ? 'grid' : 'list';
  renderLib();
}

function getFilteredTracks() {
  let list = [...tracks];
  // View tab filter
  if (libViewTab === 'fav')    list = list.filter(t => favorites.has(t.id));
  if (libViewTab === 'recent') list = playHistory.map(id => tracks.find(t => t.id === id)).filter(Boolean).slice(0, 50);
  // Text filter
  if (libFilter) {
    list = list.filter(t =>
      t.title.toLowerCase().includes(libFilter)  ||
      t.artist.toLowerCase().includes(libFilter) ||
      t.album.toLowerCase().includes(libFilter)
    );
  }
  // Sort
  list.sort((a, b) => {
    if (libSort === 'title')    return a.title.localeCompare(b.title);
    if (libSort === 'artist')   return a.artist.localeCompare(b.artist);
    if (libSort === 'album')    return a.album.localeCompare(b.album);
    if (libSort === 'duration') return a.duration - b.duration;
    if (libSort === 'plays')    return (b.plays || 0) - (a.plays || 0);
    return 0;
  });
  return list;
}

function renderLib() {
  if (!tracks.length) return;
  const list = getFilteredTracks();

  // Artist / Album / Genre grouping
  if (libViewTab === 'artist') { renderGrouped(list, 'artist'); return; }
  if (libViewTab === 'album')  { renderGrouped(list, 'album');  return; }
  if (libViewTab === 'genre')  { renderGrouped(list, 'genre');  return; }

  const cont = document.getElementById('trackContainer');

  if (!list.length) {
    cont.innerHTML = `<div class="empty"><span class="eico">üîç</span><div class="etit">Sonu√ß Yok</div><div class="esub">Farklƒ± bir arama dene</div></div>`;
    return;
  }

  if (libView === 'grid') {
    let html = '<div class="grid-view">';
    list.forEach((tr, i) => {
      const isCur = queue[ci] && queue[ci].id === tr.id;
      html += `<div class="gc${isCur ? ' playing' : ''}" onclick="playTrack('${tr.id}')">
        <div class="gc-art">${tr.cover ? `<img src="${tr.cover}">` : 'üéµ'}</div>
        <div class="gc-title">${esc(tr.title)}</div>
        <div class="gc-artist">${esc(tr.artist)}</div>
      </div>`;
    });
    html += '</div>';
    cont.innerHTML = html;
  } else {
    let html = '';
    list.forEach((tr) => {
      const isCur = queue[ci] && queue[ci].id === tr.id;
      html += buildTrackCard(tr, isCur);
    });
    cont.innerHTML = html || '<div class="empty"><span class="eico">üì≠</span><div class="etit">Bo≈ü</div></div>';
  }
}

function renderGrouped(list, key) {
  const groups = {};
  list.forEach(t => {
    const k = t[key] || 'Bilinmeyen';
    if (!groups[k]) groups[k] = [];
    groups[k].push(t);
  });
  const keys = Object.keys(groups).sort();
  const cont = document.getElementById('trackContainer');

  if (!keys.length) { cont.innerHTML = `<div class="empty"><span class="eico">üì≠</span><div class="etit">Bo≈ü</div></div>`; return; }

  let html = '<div class="section-grid">';
  keys.forEach(k => {
    const items = groups[k];
    const cover = items.find(t => t.cover)?.cover;
    html += `<div class="sg-item" onclick="playGroup('${key}','${esc(k)}')">
      <span class="sg-ico">${cover ? `<img src="${cover}" style="width:40px;height:40px;border-radius:8px;object-fit:cover">` : (key === 'artist' ? 'üë§' : key === 'album' ? 'üíø' : 'üé∏')}</span>
      <div class="sg-name">${esc(k)}</div>
      <div class="sg-cnt">${items.length} ≈üarkƒ±</div>
    </div>`;
  });
  html += '</div>';
  cont.innerHTML = html;
}

function buildTrackCard(tr, isCur) {
  const fmtColor = tr.format === 'MP3' ? 'rgba(139,92,246,.15);color:var(--p2)' :
                   tr.format === 'FLAC'? 'rgba(16,185,129,.15);color:var(--g)' :
                   tr.format === 'WAV' ? 'rgba(245,158,11,.15);color:var(--o)' :
                   'rgba(59,130,246,.15);color:var(--b)';
  const favOn = favorites.has(tr.id);
  return `<div class="tc${isCur ? ' playing' : ''}" onclick="playTrack('${tr.id}')">
    ${tr.cover
      ? `<img class="tc-art" src="${tr.cover}" onerror="this.style.display='none';this.nextSibling.style.display='flex'">`
      : ''}
    <div class="tc-ph" style="${tr.cover ? 'display:none' : ''}">üéµ</div>
    <div class="tc-info">
      <div class="tc-title">${esc(tr.title)}</div>
      <div class="tc-artist">${esc(tr.artist)}</div>
      <div class="tc-meta">
        <span class="tc-dur">${fmtSec(tr.duration)}</span>
        <span class="tc-fmt" style="background:${fmtColor}">${tr.format}</span>
        ${tr.genre ? `<span class="tc-fmt" style="background:rgba(255,255,255,.06);color:var(--t2)">${esc(tr.genre)}</span>` : ''}
      </div>
    </div>
    <div class="tc-acts">
      <button class="ta ta-fav${favOn ? ' on' : ''}" onclick="event.stopPropagation();togFav('${tr.id}',this)">${favOn ? '‚ô•' : '‚ô°'}</button>
      <button class="ta ta-menu" onclick="event.stopPropagation();openCtx('${tr.id}',this)">‚ãØ</button>
    </div>
    ${isCur ? `<div class="play-ind"><div class="pi-bar${playing ? '' : ' paused'}"></div><div class="pi-bar${playing ? '' : ' paused'}"></div><div class="pi-bar${playing ? '' : ' paused'}"></div></div>` : ''}
  </div>`;
}

/* ============================================================
   PLAY
============================================================ */
function playTrack(id) {
  const tr = tracks.find(t => t.id === id);
  if (!tr) return;
  // Set queue from current filtered list if not in queue
  const filtered = getFilteredTracks();
  queue = [...filtered];
  ci = queue.findIndex(t => t.id === id);
  if (ci < 0) { queue.push(tr); ci = queue.length - 1; }
  playIdx(ci);
  goTab('player', document.querySelectorAll('.tab')[1]);
}

function playGroup(key, val) {
  const filtered = tracks.filter(t => (t[key] || 'Bilinmeyen') === val);
  queue = [...filtered];
  ci = 0;
  playIdx(0);
  goTab('player', document.querySelectorAll('.tab')[1]);
}

function playIdx(i) {
  if (i < 0 || i >= queue.length) return;
  ci = i;
  const tr = queue[ci];

  // Stop current
  aud.pause();
  if (source) { try { source.disconnect(); } catch {} source = null; }

  // Set source
  aud.src = tr.url;
  aud.playbackRate = speed;

  aud.play().then(() => {
    updatePlayState(true);
    updatePlayerUI(tr);
    updateMediaSession(tr);
    trackPlay(tr);
    setupAudioContext();
    startSpectrumAnim();
    renderLib();
    renderQueue();
  }).catch(e => {
    showToast('‚ùå Oynatƒ±lamadƒ±');
    updatePlayState(false);
  });
}

function trackPlay(tr) {
  // History
  playHistory = [tr.id, ...playHistory.filter(id => id !== tr.id)].slice(0, 100);
  localStorage.setItem('mb_hist', JSON.stringify(playHistory));
  // Count
  playCounts[tr.name] = (playCounts[tr.name] || 0) + 1;
  tr.plays = playCounts[tr.name];
  localStorage.setItem('mb_counts', JSON.stringify(playCounts));
}

/* ============================================================
   AUDIO CONTEXT & EQ
============================================================ */
function setupAudioContext() {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      buildEQ();
    }
    if (source) { try { source.disconnect(); } catch {} }
    source = audioCtx.createMediaElementSource(aud);

    // Chain: source ‚Üí eq filters ‚Üí analyser ‚Üí destination
    let node = source;
    eqFilters.forEach(f => { node.connect(f); node = f; });
    node.connect(analyser);
    analyser.connect(audioCtx.destination);

    if (audioCtx.state === 'suspended') audioCtx.resume();
  } catch (e) {
    console.warn('AudioContext error:', e);
  }
}

const EQ_FREQS  = [60, 250, 1000, 4000, 16000];
const EQ_LABELS = ['Bass', 'Low-Mid', 'Mid', 'Hi-Mid', 'Treble'];
const EQ_PRESETS_DATA = {
  'Normal':   [0,0,0,0,0],
  'Pop':      [2,-1,0,2,3],
  'Rock':     [4,2,-1,2,4],
  'Jazz':     [2,2,0,-1,-2],
  'Klasik':   [3,1,0,1,2],
  'Bass':     [6,4,0,-1,-2],
  'Vocal':    [-2,0,3,3,1],
  'Elektronik':[4,2,0,2,4],
};

function buildEQ() {
  eqFilters = EQ_FREQS.map((freq, i) => {
    const f = audioCtx.createBiquadFilter();
    f.type = i === 0 ? 'lowshelf' : i === EQ_FREQS.length - 1 ? 'highshelf' : 'peaking';
    f.frequency.value = freq;
    f.gain.value = 0;
    return f;
  });
  renderEQ();
}

function renderEQ() {
  // Presets
  const pDiv = document.getElementById('eqPresets');
  pDiv.innerHTML = Object.keys(EQ_PRESETS_DATA).map(name =>
    `<div class="eq-preset${name === 'Normal' ? ' on' : ''}" onclick="applyEQPreset('${name}',this)">${name}</div>`
  ).join('');

  // Bands
  const bDiv = document.getElementById('eqBands');
  bDiv.innerHTML = EQ_FREQS.map((freq, i) =>
    `<div class="eq-band">
      <input class="eq-slider" type="range" min="-12" max="12" value="0" step="0.5"
        oninput="setEQBand(${i},this.value)">
      <div class="eq-label">${EQ_LABELS[i]}</div>
    </div>`
  ).join('');
}

function setEQBand(i, val) {
  if (eqFilters[i]) eqFilters[i].gain.value = parseFloat(val);
}

function applyEQPreset(name, el) {
  document.querySelectorAll('.eq-preset').forEach(p => p.classList.remove('on'));
  el.classList.add('on');
  const vals = EQ_PRESETS_DATA[name];
  vals.forEach((v, i) => {
    if (eqFilters[i]) eqFilters[i].gain.value = v;
    const sl = document.querySelectorAll('.eq-slider')[i];
    if (sl) sl.value = v;
  });
}

function resetEQ() {
  applyEQPreset('Normal', document.querySelector('.eq-preset'));
}

function togEQ() {
  const panel = document.getElementById('eqPanel');
  panel.classList.toggle('show');
  document.getElementById('eqBtn').classList.toggle('on', panel.classList.contains('show'));
}

/* ============================================================
   SPECTRUM VISUALIZER
============================================================ */
function buildSpectrum() {
  const sp = document.getElementById('spectrum');
  sp.innerHTML = '';
  for (let i = 0; i < 48; i++) {
    const b = document.createElement('div');
    b.className = 'sp-bar';
    sp.appendChild(b);
  }
}

function startSpectrumAnim() {
  if (animFrame) cancelAnimationFrame(animFrame);
  if (!settings.spectrum || !analyser) return;
  const bars   = document.querySelectorAll('.sp-bar');
  const data   = new Uint8Array(analyser.frequencyBinCount);
  function draw() {
    animFrame = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(data);
    bars.forEach((bar, i) => {
      const val = data[Math.floor(i * data.length / bars.length)] / 255;
      bar.style.height = (val * 36 + 3) + 'px';
      bar.style.opacity = playing ? (0.4 + val * 0.6) : 0.2;
    });
  }
  draw();
}

/* ============================================================
   PLAYER UI UPDATE
============================================================ */
function updatePlayerUI(tr) {
  document.getElementById('playerTitle').textContent  = tr.title;
  document.getElementById('playerArtist').textContent = tr.artist;
  document.getElementById('playerAlbum').textContent  = tr.album !== 'Bilinmeyen Alb√ºm' ? tr.album : '';

  const img   = document.getElementById('artImg');
  const emoji = document.getElementById('artEmoji');
  if (tr.cover) {
    img.src = tr.cover; img.style.display = 'block'; emoji.style.display = 'none';
    if (settings.dynbg) updateDynBg(tr.cover);
  } else {
    img.style.display = 'none'; emoji.style.display = 'block';
    resetDynBg();
  }

  // Mini player
  document.getElementById('mpTitle').textContent = tr.title;
  const mpArt = document.getElementById('mpArt');
  mpArt.innerHTML = tr.cover
    ? `<img src="${tr.cover}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">`
    : 'üéµ';

  document.getElementById('miniPlayer').classList.add('show');

  // Fav
  const fav = favorites.has(tr.id);
  document.getElementById('favBtn').innerHTML = `${fav ? '‚ô•' : '‚ô°'}<span>Favori</span>`;
}

function updateDynBg(coverUrl) {
  document.getElementById('dynBg').style.background =
    `radial-gradient(ellipse at 20% 20%,var(--dyn1) 0%,transparent 50%),
     radial-gradient(ellipse at 80% 80%,var(--dyn2) 0%,transparent 50%),var(--dark)`;
  // Simple color extraction via canvas
  try {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const c  = document.createElement('canvas');
      c.width = c.height = 8;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, 8, 8);
      const d  = ctx.getImageData(0, 0, 8, 8).data;
      let r = 0, g = 0, b = 0, cnt = 0;
      for (let i = 0; i < d.length; i += 4) {
        r += d[i]; g += d[i+1]; b += d[i+2]; cnt++;
      }
      r = Math.round(r / cnt); g = Math.round(g / cnt); b = Math.round(b / cnt);
      document.documentElement.style.setProperty('--dyn1', `rgb(${r},${g},${b})`);
      document.documentElement.style.setProperty('--dyn2', `rgb(${Math.round(b*.6)},${Math.round(r*.4)},${Math.round(g*.8)})`);
      document.getElementById('artGlow').style.background =
        `radial-gradient(circle,rgb(${r},${g},${b}) 0%,transparent 65%)`;
    };
    img.src = coverUrl;
  } catch {}
}

function resetDynBg() {
  document.documentElement.style.setProperty('--dyn1', '#8b5cf6');
  document.documentElement.style.setProperty('--dyn2', '#6d28d9');
  document.getElementById('artGlow').style.background =
    'radial-gradient(circle,var(--dyn1) 0%,transparent 65%)';
}

/* ============================================================
   PLAY STATE
============================================================ */
function updatePlayState(isPlay) {
  playing = isPlay;
  document.getElementById('ppBtn').textContent  = isPlay ? '‚è∏' : '‚ñ∂';
  document.getElementById('mpPP').textContent   = isPlay ? '‚è∏' : '‚ñ∂';
  document.getElementById('artRing').classList.toggle('show', isPlay);
  document.getElementById('mpBars').classList.toggle('paused', !isPlay);
  if (!isPlay && animFrame) { cancelAnimationFrame(animFrame); animFrame = null; }
  if (isPlay) startSpectrumAnim();
}

/* ============================================================
   CONTROLS
============================================================ */
function togPP() {
  if (!aud.src) { if (queue.length) playIdx(0); return; }
  if (playing) { aud.pause(); updatePlayState(false); }
  else { aud.play().then(() => updatePlayState(true)); audioCtx?.resume(); }
}

function nextTr() {
  if (!queue.length) return;
  const ni = shuffle
    ? Math.floor(Math.random() * queue.length)
    : (ci + 1) % queue.length;
  playIdx(ni);
}

function prevTr() {
  if (!queue.length) return;
  if (aud.currentTime > 4) { aud.currentTime = 0; return; }
  playIdx((ci - 1 + queue.length) % queue.length);
}

function skipFwd()  { aud.currentTime = Math.min(aud.currentTime + 10, aud.duration || 0); }
function skipBack() { aud.currentTime = Math.max(aud.currentTime - 10, 0); }

function togShuffle() {
  shuffle = !shuffle;
  document.getElementById('shuffleBtn').classList.toggle('on', shuffle);
  showToast(shuffle ? 'üîÄ Karƒ±≈ütƒ±r a√ßƒ±k' : 'üîÄ Kapalƒ±');
}

function togRepeat() {
  repeat = (repeat + 1) % 3;
  const icons  = ['üîÅ','üîÅ','üîÇ'];
  const labels = ['Tekrar','T√ºm√º','Biri'];
  document.getElementById('repeatBtn').innerHTML = `${icons[repeat]}<span>${labels[repeat]}</span>`;
  document.getElementById('repeatBtn').classList.toggle('on', repeat > 0);
  showToast(['üîÅ Tekrar kapalƒ±','üîÅ T√ºm√ºn√º tekrar','üîÇ Birini tekrar'][repeat]);
}

function setSpeed(s) {
  speed = s;
  aud.playbackRate = s;
  document.getElementById('speedLbl').textContent = s + 'x';
  document.querySelectorAll('.speed-btn').forEach(b => {
    b.classList.toggle('on', parseFloat(b.textContent) === s);
  });
}

/* ============================================================
   SEEK
============================================================ */
const seekWrap = document.getElementById('seekWrap');

seekWrap.addEventListener('touchstart', e => {
  seekDragging = true;
  seekWrap.classList.add('dragging');
  updateSeekFromEvent(e);
}, { passive: true });

seekWrap.addEventListener('touchmove', e => {
  if (seekDragging) updateSeekFromEvent(e);
}, { passive: true });

seekWrap.addEventListener('touchend', () => {
  seekDragging = false;
  seekWrap.classList.remove('dragging');
});

seekWrap.addEventListener('click', updateSeekFromEvent);

function updateSeekFromEvent(e) {
  const rect = seekWrap.getBoundingClientRect();
  const x    = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const pct  = Math.max(0, Math.min(1, x / rect.width));
  if (aud.duration) aud.currentTime = aud.duration * pct;
}

function miniSeek(e) {
  const bar  = document.getElementById('mpProg');
  const pct  = e.offsetX / bar.clientWidth;
  if (aud.duration) aud.currentTime = aud.duration * pct;
}

/* ============================================================
   VOLUME
============================================================ */
document.getElementById('volTrack').addEventListener('click', setVol);
document.getElementById('volTrack').addEventListener('touchmove', e => {
  const rect = document.getElementById('volTrack').getBoundingClientRect();
  vol = Math.max(0, Math.min(1, (e.touches[0].clientX - rect.left) / rect.width));
  aud.volume = vol;
  document.getElementById('volFill').style.width = (vol * 100) + '%';
}, { passive: true });

function setVol(e) {
  const rect = document.getElementById('volTrack').getBoundingClientRect();
  vol = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  aud.volume = vol;
  document.getElementById('volFill').style.width = (vol * 100) + '%';
}

/* ============================================================
   AUDIO EVENTS
============================================================ */
aud.addEventListener('timeupdate', () => {
  if (!aud.duration || seekDragging) return;
  const pct = aud.currentTime / aud.duration * 100;
  document.getElementById('seekFill').style.width = pct + '%';
  document.getElementById('mpFill').style.width   = pct + '%';
  document.getElementById('curTime').textContent  = fmtSec(aud.currentTime);
  document.getElementById('durTime').textContent  = fmtSec(aud.duration);
});

aud.addEventListener('ended', () => {
  if (repeat === 2) { aud.currentTime = 0; aud.play(); return; }
  if (ci < queue.length - 1 || repeat === 1) nextTr();
  else updatePlayState(false);
});

aud.addEventListener('loadedmetadata', () => {
  document.getElementById('durTime').textContent = fmtSec(aud.duration);
});

/* ============================================================
   MEDIA SESSION (lock screen)
============================================================ */
function updateMediaSession(tr) {
  if (!('mediaSession' in navigator)) return;
  navigator.mediaSession.metadata = new MediaMetadata({
    title:  tr.title,
    artist: tr.artist,
    album:  tr.album,
    artwork: tr.cover ? [{ src: tr.cover, sizes: '300x300', type: 'image/jpeg' }] : []
  });
  navigator.mediaSession.setActionHandler('play',         () => togPP());
  navigator.mediaSession.setActionHandler('pause',        () => togPP());
  navigator.mediaSession.setActionHandler('nexttrack',    () => nextTr());
  navigator.mediaSession.setActionHandler('previoustrack',() => prevTr());
  navigator.mediaSession.setActionHandler('seekto', e => { aud.currentTime = e.seekTime; });
}

/* ============================================================
   FAVORITES
============================================================ */
function togFav(id, btn) {
  if (favorites.has(id)) {
    favorites.delete(id);
    btn.textContent = '‚ô°'; btn.classList.remove('on');
    showToast('üíî Favoriden √ßƒ±karƒ±ldƒ±');
  } else {
    favorites.add(id);
    btn.textContent = '‚ô•'; btn.classList.add('on');
    showToast('‚ù§Ô∏è Favorilere eklendi');
  }
  localStorage.setItem('mb_favs', JSON.stringify([...favorites]));
  // Update player fav btn
  if (queue[ci]?.id === id) {
    document.getElementById('favBtn').innerHTML = `${favorites.has(id) ? '‚ô•' : '‚ô°'}<span>Favori</span>`;
  }
}

function togFavCurrent() {
  if (ci < 0 || !queue[ci]) return;
  const btn = document.getElementById('favBtn');
  const id  = queue[ci].id;
  if (favorites.has(id)) {
    favorites.delete(id);
    btn.innerHTML = '‚ô°<span>Favori</span>';
    showToast('üíî Favoriden √ßƒ±karƒ±ldƒ±');
  } else {
    favorites.add(id);
    btn.innerHTML = '‚ô•<span>Favori</span>';
    showToast('‚ù§Ô∏è Favorilere eklendi');
  }
  localStorage.setItem('mb_favs', JSON.stringify([...favorites]));
}

/* ============================================================
   CONTEXT MENU
============================================================ */
function openCtx(id, btn) {
  ctxTrack = tracks.find(t => t.id === id);
  ctxEl    = btn;
  const menu = document.getElementById('ctxMenu');
  menu.classList.add('show');
  const rect = btn.getBoundingClientRect();
  menu.style.top  = (rect.bottom + 6) + 'px';
  menu.style.right = '18px';
  menu.style.left  = 'auto';
  const isFav = favorites.has(id);
  document.getElementById('ctxFavIco').textContent = isFav ? 'üíî' : '‚ù§Ô∏è';
  document.getElementById('ctxFavTxt').textContent = isFav ? 'Favoriden √áƒ±kar' : 'Favorilere Ekle';
  document.addEventListener('click', closeCtxOutside, { once: true });
}

function closeCtxOutside(e) {
  const menu = document.getElementById('ctxMenu');
  if (!menu.contains(e.target)) menu.classList.remove('show');
}

function ctxPlay()        { if (ctxTrack) playTrack(ctxTrack.id); closeCtx(); }
function ctxPlayNext()    { if (ctxTrack) { queue.splice(ci + 1, 0, { ...ctxTrack }); showToast('‚è≠ Sƒ±radaki ekle'); renderQueue(); } closeCtx(); }
function ctxAddQueue()    { if (ctxTrack) { queue.push({ ...ctxTrack }); showToast('üìã Sƒ±raya eklendi'); renderQueue(); } closeCtx(); }
function ctxTogFav()      { if (ctxTrack) togFav(ctxTrack.id, { textContent:'', classList: { add:()=>{}, remove:()=>{} } }); renderLib(); closeCtx(); }
function ctxAddPlaylist() { closeCtx(); openAddToPlaylist(ctxTrack); }
function ctxRemove()      { tracks = tracks.filter(t => t.id !== ctxTrack.id); renderLib(); closeCtx(); showToast('üóëÔ∏è Kaldƒ±rƒ±ldƒ±'); }
function closeCtx()       { document.getElementById('ctxMenu').classList.remove('show'); }

/* ============================================================
   QUEUE
============================================================ */
function showQueue() {
  renderQueue();
  document.getElementById('queuePanel').classList.add('show');
}
function closeQueue() { document.getElementById('queuePanel').classList.remove('show'); }

function renderQueue() {
  const list = document.getElementById('qpList');
  if (!queue.length) {
    list.innerHTML = `<div class="empty"><span class="eico">üì≠</span><div class="etit">Sƒ±ra Bo≈ü</div></div>`;
    return;
  }
  list.innerHTML = queue.map((tr, i) => `
    <div class="qi${i === ci ? ' active' : ''}" onclick="playIdx(${i})">
      <div class="qi-num">${i === ci ? '‚ñ∂' : (i + 1)}</div>
      <div class="qi-art">${tr.cover ? `<img src="${tr.cover}">` : 'üéµ'}</div>
      <div class="qi-info">
        <div class="qi-title">${esc(tr.title)}</div>
        <div class="qi-artist">${esc(tr.artist)}</div>
      </div>
      <div class="qi-dur">${fmtSec(tr.duration)}</div>
      <button class="qi-rm" onclick="event.stopPropagation();removeFromQueue(${i})">‚úï</button>
    </div>`).join('');
}

function removeFromQueue(i) {
  if (i === ci) { showToast('‚ö†Ô∏è √áalan ≈üarkƒ± kaldƒ±rƒ±lamaz'); return; }
  queue.splice(i, 1);
  if (i < ci) ci--;
  renderQueue();
  showToast('üóëÔ∏è Sƒ±radan kaldƒ±rƒ±ldƒ±');
}

function clearQueue() {
  if (!confirm('Sƒ±rayƒ± temizle?')) return;
  queue = []; ci = -1;
  aud.pause(); updatePlayState(false);
  document.getElementById('miniPlayer').classList.remove('show');
  renderQueue();
  closeQueue();
}

function shuffleQueue() {
  for (let i = queue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [queue[i], queue[j]] = [queue[j], queue[i]];
  }
  ci = 0;
  renderQueue();
  showToast('üîÄ Karƒ±≈ütƒ±rƒ±ldƒ±');
}

/* ============================================================
   PLAYLISTS
============================================================ */
function renderPlaylists() {
  // Smart playlists
  const smart = [
    { name: 'En √áok √áalƒ±nanlar', ico: 'üî•', key: 'plays' },
    { name: 'Son Eklenenler',     ico: 'üÜï', key: 'recent' },
    { name: 'Favoriler',          ico: '‚ù§Ô∏è', key: 'fav' },
    { name: 'T√ºm ≈ûarkƒ±lar',      ico: 'üéµ', key: 'all' },
  ];

  document.getElementById('smartPlaylists').innerHTML = smart.map(s => `
    <div class="pl-card smart-pl" onclick="playSmartList('${s.key}')">
      <div class="pl-art" style="background:linear-gradient(135deg,var(--p3),var(--pk))">${s.ico}</div>
      <div class="pl-info">
        <div class="pl-name">${s.name}</div>
        <div class="pl-cnt">${getSmartCount(s.key)} ≈üarkƒ±</div>
      </div>
      <div class="pl-acts">
        <button class="pa pa-play" onclick="event.stopPropagation();playSmartList('${s.key}')">‚ñ∂</button>
      </div>
    </div>`).join('');

  // Manual playlists
  const manDiv = document.getElementById('manualPlaylists');
  if (!playlists.length) {
    manDiv.innerHTML = `<div class="empty"><span class="eico">üìã</span><div class="etit">Liste Yok</div><div class="esub">Yukarƒ±dan yeni liste olu≈ütur</div></div>`;
    return;
  }
  manDiv.innerHTML = playlists.map((pl, i) => `
    <div class="pl-card" onclick="playPlaylist(${i})">
      <div class="pl-art">${pl.ico || 'üìã'}</div>
      <div class="pl-info">
        <div class="pl-name">${esc(pl.name)}</div>
        <div class="pl-cnt">${pl.tracks.length} ≈üarkƒ±</div>
      </div>
      <div class="pl-acts">
        <button class="pa pa-play" onclick="event.stopPropagation();playPlaylist(${i})">‚ñ∂</button>
        <button class="pa pa-del" onclick="event.stopPropagation();deletePlaylist(${i})">üóë</button>
      </div>
    </div>`).join('');
}

function getSmartCount(key) {
  if (key === 'all')    return tracks.length;
  if (key === 'fav')    return favorites.size;
  if (key === 'plays')  return Math.min(tracks.length, 20);
  if (key === 'recent') return Math.min(playHistory.length, 20);
  return 0;
}

function playSmartList(key) {
  let list = [...tracks];
  if (key === 'fav')    list = list.filter(t => favorites.has(t.id));
  if (key === 'plays')  list = list.sort((a,b)=>(b.plays||0)-(a.plays||0)).slice(0,20);
  if (key === 'recent') list = playHistory.map(id=>tracks.find(t=>t.id===id)).filter(Boolean).slice(0,20);
  if (!list.length) { showToast('‚ö†Ô∏è Liste bo≈ü'); return; }
  queue = [...list]; ci = 0;
  playIdx(0);
  goTab('player', document.querySelectorAll('.tab')[1]);
}

function playPlaylist(i) {
  const pl = playlists[i];
  const list = pl.tracks.map(id => tracks.find(t => t.id === id)).filter(Boolean);
  if (!list.length) { showToast('‚ö†Ô∏è Liste bo≈ü'); return; }
  queue = [...list]; ci = 0;
  playIdx(0);
  goTab('player', document.querySelectorAll('.tab')[1]);
}

function deletePlaylist(i) {
  if (!confirm('Listeyi sil?')) return;
  playlists.splice(i, 1);
  savePlaylists();
  renderPlaylists();
}

function openCreatePlaylist() {
  document.getElementById('modalTitle').textContent = '‚ú® Yeni Playlist';
  document.getElementById('modalInput').placeholder = 'Playlist adƒ±...';
  document.getElementById('modalInput').value = '';
  document.getElementById('modalOverlay').classList.add('show');
  window._modalMode = 'create';
}

function openAddToPlaylist(tr) {
  document.getElementById('modalTitle').textContent = '‚ûï Playliste Ekle';
  document.getElementById('modalInput').placeholder = 'Playlist adƒ± (yeni veya mevcut)...';
  document.getElementById('modalInput').value = '';
  document.getElementById('modalOverlay').classList.add('show');
  window._modalMode = 'addtrack';
  window._modalTrack = tr;
}

function modalConfirm() {
  const name = document.getElementById('modalInput').value.trim();
  if (!name) { showToast('‚ö†Ô∏è ƒ∞sim gir'); return; }
  if (window._modalMode === 'create') {
    playlists.push({ name, ico: 'üìã', tracks: [] });
    savePlaylists();
    renderPlaylists();
    showToast('‚úÖ Liste olu≈üturuldu');
  } else if (window._modalMode === 'addtrack') {
    let pl = playlists.find(p => p.name.toLowerCase() === name.toLowerCase());
    if (!pl) { pl = { name, ico: 'üìã', tracks: [] }; playlists.push(pl); }
    if (!pl.tracks.includes(window._modalTrack.id)) {
      pl.tracks.push(window._modalTrack.id);
      savePlaylists();
      showToast(`‚úÖ "${pl.name}"e eklendi`);
    } else {
      showToast('‚ö†Ô∏è Zaten listede');
    }
  }
  closeModal();
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modalOverlay')) return;
  document.getElementById('modalOverlay').classList.remove('show');
}

function savePlaylists() {
  localStorage.setItem('mb_pls', JSON.stringify(playlists));
}

/* ============================================================
   SETTINGS
============================================================ */
function renderSettings() {
  // Toggles
  Object.keys(DEF_SETS).forEach(k => {
    const el = document.getElementById('tog-' + k);
    if (el) el.classList.toggle('on', !!settings[k]);
  });
  // Theme colors
  const themes = [
    { name:'Mor',    c:'#8b5cf6', c2:'#6d28d9' },
    { name:'Mavi',   c:'#3b82f6', c2:'#1d4ed8' },
    { name:'Ye≈üil',  c:'#10b981', c2:'#065f46' },
    { name:'Pembe',  c:'#ec4899', c2:'#9d174d' },
    { name:'Turuncu',c:'#f59e0b', c2:'#b45309' },
    { name:'Kƒ±rmƒ±zƒ±',c:'#ef4444', c2:'#991b1b' },
    { name:'Cyan',   c:'#06b6d4', c2:'#0e7490' },
  ];
  const curTheme = settings.theme || '#8b5cf6';
  document.getElementById('themeColors').innerHTML = themes.map(t =>
    `<div class="theme-c${t.c === curTheme ? ' on' : ''}"
      style="background:linear-gradient(135deg,${t.c},${t.c2})"
      onclick="setTheme('${t.c}','${t.c2}','${t.name}',this)"
      title="${t.name}"></div>`
  ).join('');
  // Stats
  renderStats();
  // Sleep
  document.querySelectorAll('.sleep-btn').forEach(b => b.classList.remove('on'));
}

function togSetting(key) {
  settings[key] = !settings[key];
  const el = document.getElementById('tog-' + key);
  if (el) el.classList.toggle('on', settings[key]);
  localStorage.setItem('mb_sets', JSON.stringify(settings));
  showToast(settings[key] ? `‚úÖ ${key} a√ßƒ±k` : `‚ùå ${key} kapalƒ±`);
}

function setTheme(c, c2, name, el) {
  document.querySelectorAll('.theme-c').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
  document.documentElement.style.setProperty('--p',  c);
  document.documentElement.style.setProperty('--p2', c);
  document.documentElement.style.setProperty('--p3', c2);
  settings.theme = c; settings.theme2 = c2;
  localStorage.setItem('mb_sets', JSON.stringify(settings));
  showToast('üé® ' + name + ' temasƒ±');
}

function renderStats() {
  const totalMin  = Math.round(tracks.reduce((a, t) => a + t.duration, 0) / 60);
  const artists   = new Set(tracks.map(t => t.artist)).size;
  const albums    = new Set(tracks.map(t => t.album)).size;
  const totalPlay = Object.values(playCounts).reduce((a, b) => a + b, 0);
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-item"><div class="stat-n">${tracks.length}</div><div class="stat-l">≈ûarkƒ±</div></div>
    <div class="stat-item"><div class="stat-n">${totalMin}</div><div class="stat-l">Dakika</div></div>
    <div class="stat-item"><div class="stat-n">${artists}</div><div class="stat-l">Sanat√ßƒ±</div></div>
    <div class="stat-item"><div class="stat-n">${albums}</div><div class="stat-l">Alb√ºm</div></div>
    <div class="stat-item"><div class="stat-n">${favorites.size}</div><div class="stat-l">Favori</div></div>
    <div class="stat-item"><div class="stat-n">${totalPlay}</div><div class="stat-l">Toplam Oynatma</div></div>
  `;
}

function clearCache() {
  if (!confirm('√ñnbellek ve istatistikler temizlensin mi?')) return;
  localStorage.clear();
  playCounts = {}; playHistory = []; favorites = new Set(); playlists = [];
  updateBadge(); renderLib(); renderPlaylists();
  showToast('üóëÔ∏è Temizlendi');
}

/* ============================================================
   SLEEP TIMER
============================================================ */
function setSleep(min) {
  if (sleepTimer) clearTimeout(sleepTimer);
  document.querySelectorAll('.sleep-btn').forEach(b => b.classList.remove('on'));
  event.target.classList.add('on');
  if (min === 0) {
    sleepEnd = 0;
    document.getElementById('sleepDisplay').textContent = '‚Äî';
    showToast('üò¥ Zamanlayƒ±cƒ± kapalƒ±');
    return;
  }
  sleepEnd = Date.now() + min * 60 * 1000;
  sleepTimer = setTimeout(() => { aud.pause(); updatePlayState(false); showToast('üò¥ Uyku zamanlayƒ±cƒ±sƒ± devreye girdi'); }, min * 60 * 1000);
  showToast(`üò¥ ${min} dakikada kapanacak`);
  // Update display
  const iv = setInterval(() => {
    const rem = sleepEnd - Date.now();
    if (rem <= 0) { clearInterval(iv); document.getElementById('sleepDisplay').textContent = '‚Äî'; return; }
    const m = Math.floor(rem / 60000), s = Math.floor((rem % 60000) / 1000);
    document.getElementById('sleepDisplay').textContent = `${m}:${s.toString().padStart(2,'0')}`;
  }, 1000);
}

function openSleepTimer() {
  goTab('settings', document.querySelectorAll('.tab')[3]);
  showToast('‚è± Uyku zamanlayƒ±cƒ±sƒ±');
}

/* ============================================================
   UTILS
============================================================ */
function fmtSec(s) {
  if (isNaN(s) || !s) return '0:00';
  const m = Math.floor(s / 60);
  const ss = Math.floor(s % 60);
  return `${m}:${ss.toString().padStart(2, '0')}`;
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function updateBadge() {
  document.getElementById('libBadge').textContent = tracks.length;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 2600);
}

/* ============================================================
   INIT
============================================================ */
buildSpectrum();
// Apply saved theme
if (settings.theme) {
  document.documentElement.style.setProperty('--p',  settings.theme);
  document.documentElement.style.setProperty('--p2', settings.theme);
  document.documentElement.style.setProperty('--p3', settings.theme2 || settings.theme);
}
// Folder name display
if (folderName) document.getElementById('folderNameDisplay').textContent = folderName;
// Hide PWA prompt if already installed
if (window.navigator.standalone) document.getElementById('pwaPrompt').style.display = 'none';

// Resume AudioContext on user interaction
document.addEventListener('touchstart', () => { audioCtx?.resume(); }, { once: true });

console.log('üéµ M√ºzikBox Pro y√ºklendi');
</script>
</body>
</html>
