<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MÃ¼zikBox">
<meta name="theme-color" content="#07071a">
<title>ğŸµ MÃ¼zikBox Pro</title>
<style>
/* â”€â”€ RESET â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;
  user-select:none;-webkit-user-select:none}
:root{
  --p:#8b5cf6;--p2:#a78bfa;--p3:#6d28d9;--p4:#4c1d95;
  --g:#10b981;--r:#ef4444;--o:#f59e0b;--b:#3b82f6;--pk:#ec4899;
  --dark:#07071a;--c1:#0f0f24;--c2:#161632;--c3:#1e1e40;--c4:#252550;
  --t:#fff;--t2:#8080a8;--bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.13);
  --safe-t:env(safe-area-inset-top,0px);--safe-b:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;overflow:hidden;background:var(--dark)}
body{color:var(--t);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;
  -webkit-font-smoothing:antialiased}
::-webkit-scrollbar{display:none}
*{scrollbar-width:none}

/* â”€â”€ DYN BG â”€â”€ */
.dyn-bg{position:fixed;inset:0;z-index:0;
  background:radial-gradient(ellipse at 20% 20%,var(--p3) 0%,transparent 55%),
             radial-gradient(ellipse at 80% 80%,var(--p4) 0%,transparent 55%),var(--dark);
  opacity:.28;transition:background 1.5s;pointer-events:none}

/* â”€â”€ SHELL â”€â”€ */
.shell{position:relative;z-index:1;max-width:430px;margin:0 auto;
  height:100%;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:calc(var(--safe-t) + 12px) 18px 0;height:calc(var(--safe-t) + 56px)}
.brand{display:flex;align-items:center;gap:9px}
.brand-ico{width:36px;height:36px;background:linear-gradient(135deg,var(--p3),var(--b));
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:18px;box-shadow:0 0 18px rgba(139,92,246,.4)}
.brand-txt{font-size:19px;font-weight:800;letter-spacing:-.4px}
.brand-txt b{color:var(--p2)}
.topbar-r{display:flex;align-items:center;gap:8px}
.ico-btn{width:34px;height:34px;background:var(--c1);border:1px solid var(--bd);
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:16px;cursor:pointer;transition:all .2s}
.ico-btn:active{transform:scale(.9);background:var(--c2)}
.lib-badge{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff;
  font-size:10px;font-weight:800;min-width:20px;height:20px;padding:0 5px;
  border-radius:10px;display:flex;align-items:center;justify-content:center}

/* â”€â”€ TABS â”€â”€ */
.tabs{flex-shrink:0;display:flex;gap:5px;padding:10px 18px 8px}
.tab{flex:1;padding:9px 2px;background:var(--c1);border:1px solid var(--bd);
  border-radius:13px;color:var(--t2);font-size:10px;font-weight:800;
  cursor:pointer;text-align:center;transition:all .22s;
  display:flex;flex-direction:column;align-items:center;gap:3px}
.tab i{font-size:17px;font-style:normal}
.tab.on{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff;
  border-color:transparent;box-shadow:0 4px 16px rgba(139,92,246,.38)}

/* â”€â”€ PAGES â”€â”€ */
.pages{flex:1;overflow:hidden;position:relative}
.pg{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;
  padding:8px 18px 200px;display:none;-webkit-overflow-scrolling:touch}
.pg.on{display:block}

/* â”€â”€ SECTION LABEL â”€â”€ */
.slbl{font-size:11px;font-weight:800;color:var(--t2);text-transform:uppercase;
  letter-spacing:1.1px;margin:14px 0 10px;display:flex;align-items:center;gap:8px}
.slbl::after{content:'';flex:1;height:1px;background:var(--bd)}

/* â”€â”€ WELCOME â”€â”€ */
.welcome{display:flex;flex-direction:column;align-items:center;padding:28px 20px;text-align:center}
.w-ico{font-size:64px;margin-bottom:16px;animation:w-pulse 2s ease-in-out infinite}
@keyframes w-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.07)}}
.w-title{font-size:22px;font-weight:800;margin-bottom:8px}
.w-sub{font-size:13px;color:var(--t2);line-height:1.7;margin-bottom:22px}
.f-btn{width:100%;max-width:300px;padding:15px;border:none;border-radius:16px;
  color:#fff;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
.f-btn:active{transform:scale(.96)}
.f-btn-main{background:linear-gradient(135deg,var(--p3),var(--p));
  box-shadow:0 8px 22px rgba(139,92,246,.38)}
.f-btn-sec{background:var(--c1);border:1.5px solid var(--bd2);color:var(--t)}
.how-box{background:var(--c1);border:1px solid var(--bd);border-radius:16px;
  padding:14px;margin-top:14px;text-align:left;width:100%;max-width:340px}
.how-ttl{font-size:12px;font-weight:800;margin-bottom:10px;color:var(--p2)}
.how-row{display:flex;gap:10px;align-items:flex-start;margin-bottom:9px}
.how-n{width:20px;height:20px;background:linear-gradient(135deg,var(--p3),var(--p));
  border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:800;flex-shrink:0;color:#fff}
.how-t{font-size:12px;color:var(--t2);line-height:1.5;padding-top:2px}
.how-t b{color:var(--t)}

/* â”€â”€ RESTORE BANNER â”€â”€ */
.r-banner{background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(59,130,246,.07));
  border:1px solid rgba(16,185,129,.22);border-radius:15px;padding:13px 14px;
  margin-bottom:12px;display:none;align-items:center;gap:11px}
.r-banner.show{display:flex}
.rb-ico{font-size:22px;flex-shrink:0}
.rb-info{flex:1}
.rb-title{font-size:14px;font-weight:700;margin-bottom:2px}
.rb-sub{font-size:12px;color:var(--t2)}
.rb-btn{background:linear-gradient(135deg,var(--p3),var(--p));border:none;
  border-radius:10px;color:#fff;padding:8px 13px;font-size:12px;font-weight:700;
  cursor:pointer;flex-shrink:0}
.rb-btn:active{transform:scale(.95)}

/* â”€â”€ LIB TOOLBAR â”€â”€ */
.lib-bar{display:flex;align-items:center;gap:7px;margin-bottom:11px;margin-top:4px}
.srch-wrap{position:relative;flex:1}
.srch-inp{width:100%;padding:10px 13px 10px 33px;background:var(--c1);
  border:1.5px solid var(--bd);border-radius:12px;color:var(--t);font-size:14px;
  outline:none;-webkit-appearance:none;font-family:inherit;transition:border .2s}
.srch-inp:focus{border-color:var(--p)}
.srch-inp::placeholder{color:var(--t2)}
.srch-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);
  font-size:14px;pointer-events:none}
.sort-btn{padding:10px 9px;background:var(--c1);border:1.5px solid var(--bd);
  border-radius:12px;color:var(--t2);font-size:11px;font-weight:700;cursor:pointer;
  white-space:nowrap;transition:all .2s}
.sort-btn:active{background:var(--c2)}

/* â”€â”€ VIEW TABS â”€â”€ */
.vtabs{display:flex;gap:5px;margin-bottom:11px;overflow-x:auto;padding-bottom:2px}
.vt{flex-shrink:0;padding:7px 12px;background:var(--c1);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:12px;font-weight:700;cursor:pointer;
  transition:all .2s}
.vt.on{background:rgba(139,92,246,.15);border-color:var(--p);color:var(--p2)}

/* â”€â”€ TRACK CARD â”€â”€ */
.tc{background:var(--c1);border:1px solid var(--bd);border-radius:16px;
  padding:11px;display:flex;align-items:center;gap:11px;margin-bottom:9px;
  cursor:pointer;position:relative;overflow:hidden;transition:background .18s,transform .15s}
.tc.playing{border-color:var(--p);background:rgba(139,92,246,.08)}
.tc:active{transform:scale(.985)}
.tc-art{width:50px;height:50px;border-radius:11px;object-fit:cover;
  flex-shrink:0;background:var(--c3)}
.tc-ph{width:50px;height:50px;border-radius:11px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.tc-info{flex:1;min-width:0}
.tc-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;
  text-overflow:ellipsis;margin-bottom:2px}
.tc-artist{font-size:12px;color:var(--t2);white-space:nowrap;overflow:hidden;
  text-overflow:ellipsis;margin-bottom:5px}
.tc-meta{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.tc-dur{font-size:10px;color:var(--t2);background:var(--c3);padding:2px 6px;border-radius:5px}
.tc-fmt{font-size:10px;font-weight:800;padding:2px 6px;border-radius:5px}
.tc-acts{display:flex;gap:5px;flex-shrink:0}
.ta{width:30px;height:30px;border:none;border-radius:8px;cursor:pointer;
  font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.ta:active{transform:scale(.85)}
.ta-menu{background:var(--c3);color:var(--t2)}
.ta-fav{background:rgba(239,68,68,.13);color:var(--r)}
.ta-fav.on{background:rgba(239,68,68,.26);color:var(--r)}

/* â”€â”€ PLAYING BARS â”€â”€ */
.play-ind{display:flex;align-items:flex-end;gap:2px;height:16px;
  position:absolute;right:11px;top:50%;transform:translateY(-50%)}
.pb{width:3px;background:var(--p2);border-radius:2px;animation:pb-a .65s ease infinite alternate}
.pb:nth-child(1){animation-delay:0s;height:5px}
.pb:nth-child(2){animation-delay:.18s;height:9px}
.pb:nth-child(3){animation-delay:.35s;height:6px}
@keyframes pb-a{from{transform:scaleY(.3)}to{transform:scaleY(1)}}
.pb.paused{animation-play-state:paused}

/* â”€â”€ GRID â”€â”€ */
.grid-view{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.gc{background:var(--c1);border:1px solid var(--bd);border-radius:16px;
  padding:12px;cursor:pointer;transition:all .2s}
.gc:active{transform:scale(.95)}
.gc.playing{border-color:var(--p)}
.gc-art{width:100%;aspect-ratio:1;border-radius:10px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;
  font-size:34px;margin-bottom:9px;overflow:hidden}
.gc-art img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.gc-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.gc-artist{font-size:11px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* â”€â”€ GROUP â”€â”€ */
.sec-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.sg{background:var(--c1);border:1px solid var(--bd);border-radius:14px;
  padding:13px 11px;cursor:pointer;transition:all .2s;text-align:center}
.sg:active{transform:scale(.95);background:var(--c2)}
.sg-ico{font-size:28px;margin-bottom:7px;display:block}
.sg-name{font-size:13px;font-weight:700;margin-bottom:3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sg-cnt{font-size:11px;color:var(--t2)}

/* â”€â”€ PLAYER PAGE â”€â”€ */
.player-pg{display:flex;flex-direction:column;align-items:center;padding-top:6px}
.art-wrap{position:relative;width:240px;height:240px;margin:0 auto 18px}
.art-glow{position:absolute;inset:-18px;
  background:radial-gradient(circle,var(--p3) 0%,transparent 65%);
  opacity:.4;filter:blur(16px);animation:gp 3s ease-in-out infinite;transition:background 1.2s}
@keyframes gp{0%,100%{opacity:.28;transform:scale(.88)}50%{opacity:.52;transform:scale(1.06)}}
.art-frame{position:relative;width:240px;height:240px;border-radius:26px;overflow:hidden;
  box-shadow:0 20px 52px rgba(0,0,0,.58);
  background:linear-gradient(135deg,var(--p4),var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;font-size:72px}
.art-frame img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.art-ring{position:absolute;inset:-5px;border-radius:31px;
  border:2px solid rgba(139,92,246,.28);
  animation:ar 10s linear infinite;opacity:0;transition:opacity .5s}
.art-ring.show{opacity:1}
@keyframes ar{to{transform:rotate(360deg)}}

.trk-title{font-size:20px;font-weight:800;text-align:center;margin-bottom:4px;
  padding:0 14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.trk-artist{font-size:13px;color:var(--t2);text-align:center;margin-bottom:2px}
.trk-album{font-size:11px;color:var(--t2);opacity:.6;text-align:center;margin-bottom:14px}

/* â”€â”€ SPECTRUM â”€â”€ */
.spectrum{display:flex;align-items:flex-end;justify-content:center;
  gap:2px;height:34px;width:100%;padding:0 14px;margin-bottom:13px;overflow:hidden}
.sp-b{flex:1;max-width:5px;background:linear-gradient(to top,var(--p3),var(--p2));
  border-radius:3px 3px 1px 1px;min-height:3px;opacity:.55;transition:none}

/* â”€â”€ SEEK â”€â”€ */
.seek-wrap{width:100%;padding:0 4px;margin-bottom:5px;cursor:pointer;touch-action:none}
.seek-track{height:5px;background:rgba(255,255,255,.1);border-radius:3px;position:relative}
.seek-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));
  border-radius:3px;width:0%;position:relative}
.seek-thumb{position:absolute;right:-8px;top:-5.5px;width:16px;height:16px;
  background:#fff;border-radius:50%;box-shadow:0 0 10px rgba(139,92,246,.65);
  opacity:0;transition:opacity .2s;pointer-events:none}
.seek-wrap.drag .seek-thumb{opacity:1}
.seek-times{display:flex;justify-content:space-between;
  font-size:11px;color:var(--t2);margin-top:6px;padding:0 2px}

/* â”€â”€ CONTROLS â”€â”€ */
.ctrl-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:13px}
.cb{border:none;background:transparent;color:var(--t);cursor:pointer;border-radius:50%;
  display:flex;align-items:center;justify-content:center;transition:all .15s;font-size:20px;
  width:44px;height:44px}
.cb:active{background:rgba(255,255,255,.07);transform:scale(.9)}
.cb.sm{width:38px;height:38px;font-size:18px;color:var(--t2)}
.cb.pp{width:66px;height:66px;font-size:26px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  box-shadow:0 6px 22px rgba(139,92,246,.46);color:#fff}
.cb.pp:active{transform:scale(.93)}
.cb.on{color:var(--p2)!important}

/* â”€â”€ EXTRA ROW â”€â”€ */
.extra-row{display:flex;align-items:center;justify-content:space-around;
  width:100%;padding:0 6px;margin-bottom:11px}
.eb{display:flex;flex-direction:column;align-items:center;gap:4px;
  background:none;border:none;color:var(--t2);cursor:pointer;
  transition:all .2s;padding:6px;border-radius:12px;font-size:18px}
.eb span{font-size:10px;font-weight:700}
.eb.on{color:var(--p2)}
.eb:active{transform:scale(.88)}

/* â”€â”€ VOLUME â”€â”€ */
.vol-row{display:flex;align-items:center;gap:10px;width:100%;padding:0 4px;margin-bottom:11px}
.vol-ico{font-size:14px;color:var(--t2);flex-shrink:0}
.vol-track{flex:1;height:5px;background:rgba(255,255,255,.1);
  border-radius:3px;cursor:pointer;position:relative;touch-action:none}
.vol-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));
  border-radius:3px;width:80%;pointer-events:none}

/* â”€â”€ EQ â”€â”€ */
.eq-panel{width:100%;background:var(--c1);border:1px solid var(--bd);
  border-radius:16px;padding:14px;margin-bottom:11px;display:none}
.eq-panel.show{display:block}
.eq-head{font-size:13px;font-weight:700;margin-bottom:11px;
  display:flex;align-items:center;justify-content:space-between}
.eq-presets{display:flex;gap:6px;overflow-x:auto;margin-bottom:11px;padding-bottom:2px}
.eq-pr{flex-shrink:0;padding:6px 11px;background:var(--c2);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s}
.eq-pr.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.13)}
.eq-bands{display:flex;justify-content:space-around;align-items:flex-end;height:100px}
.eq-band{display:flex;flex-direction:column;align-items:center;gap:6px;width:38px}
.eq-sl{-webkit-appearance:none;appearance:none;writing-mode:vertical-lr;direction:rtl;
  width:4px;height:68px;background:rgba(255,255,255,.1);border-radius:2px;cursor:pointer;outline:none}
.eq-sl::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;
  border-radius:50%;background:var(--p2);box-shadow:0 0 6px rgba(139,92,246,.5)}
.eq-lbl{font-size:10px;color:var(--t2);font-weight:700}

/* â”€â”€ SPEED â”€â”€ */
.spd-row{display:flex;gap:6px;overflow-x:auto;padding:0 4px;margin-bottom:13px}
.spd-btn{flex-shrink:0;padding:7px 11px;background:var(--c1);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.spd-btn.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.13)}

/* â”€â”€ PLAYLIST â”€â”€ */
.pl-hdr{display:flex;align-items:center;justify-content:space-between;margin:4px 0 13px}
.pl-hdr-t{font-size:17px;font-weight:800}
.add-pl-btn{padding:8px 13px;background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:11px;color:#fff;font-size:13px;font-weight:700;cursor:pointer}
.add-pl-btn:active{transform:scale(.95)}
.pl-card{background:var(--c1);border:1px solid var(--bd);border-radius:15px;
  padding:13px;display:flex;align-items:center;gap:12px;margin-bottom:10px;
  cursor:pointer;transition:all .2s}
.pl-card:active{background:var(--c2);transform:scale(.98)}
.pl-art{width:50px;height:50px;border-radius:12px;
  background:linear-gradient(135deg,var(--p3),var(--pk));
  display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.pl-info{flex:1;min-width:0}
.pl-name{font-size:14px;font-weight:700;margin-bottom:3px}
.pl-cnt{font-size:12px;color:var(--t2)}
.pl-acts{display:flex;gap:6px}
.pa{width:30px;height:30px;border:none;border-radius:8px;cursor:pointer;
  font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.pa:active{transform:scale(.85)}
.pa-play{background:linear-gradient(135deg,var(--p3),var(--p));color:#fff}
.pa-del{background:rgba(239,68,68,.13);color:var(--r)}
.smart-pl{background:linear-gradient(135deg,rgba(139,92,246,.09),rgba(59,130,246,.05));
  border-color:rgba(139,92,246,.18)}

/* â”€â”€ SETTINGS â”€â”€ */
.set-sec{background:var(--c1);border:1px solid var(--bd);border-radius:15px;margin-bottom:11px;overflow:hidden}
.set-ttl{font-size:11px;font-weight:800;color:var(--t2);text-transform:uppercase;
  letter-spacing:1px;padding:12px 15px 6px}
.set-row{display:flex;align-items:center;gap:11px;padding:12px 15px;
  border-top:1px solid var(--bd);cursor:pointer;transition:background .15s}
.set-row:active{background:var(--c2)}
.set-ico{font-size:17px;width:25px;text-align:center;flex-shrink:0}
.set-lbl{flex:1;font-size:13px;font-weight:600}
.set-val{font-size:12px;color:var(--t2)}
.set-arr{color:var(--t2);font-size:16px}
.tog{width:42px;height:24px;background:var(--c3);border-radius:12px;
  position:relative;cursor:pointer;transition:background .25s;flex-shrink:0}
.tog.on{background:var(--p)}
.tog::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;
  background:#fff;border-radius:50%;transition:transform .25s;box-shadow:0 2px 5px rgba(0,0,0,.3)}
.tog.on::after{transform:translateX(18px)}
.theme-colors{display:flex;gap:10px;padding:12px 15px;flex-wrap:wrap}
.thm-c{width:30px;height:30px;border-radius:50%;cursor:pointer;
  transition:all .2s;border:2px solid transparent}
.thm-c.on{border-color:#fff;transform:scale(1.15)}
.sleep-btns{display:flex;gap:8px;padding:10px 15px;overflow-x:auto}
.slp-btn{flex-shrink:0;padding:7px 12px;background:var(--c2);border:1.5px solid var(--bd);
  border-radius:10px;color:var(--t2);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.slp-btn.on{border-color:var(--p);color:var(--p2);background:rgba(139,92,246,.13)}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:10px 13px}
.stat-i{background:var(--c2);border-radius:11px;padding:11px;text-align:center}
.stat-n{font-size:19px;font-weight:800;
  background:linear-gradient(135deg,var(--p),var(--b));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-l{font-size:11px;color:var(--t2);margin-top:3px}

/* â”€â”€ QUEUE PANEL â”€â”€ */
.q-panel{position:fixed;bottom:0;left:0;right:0;z-index:500;
  max-width:430px;margin:0 auto;
  background:rgba(13,13,28,.97);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--bd2);border-radius:24px 24px 0 0;
  transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
  max-height:75vh;display:flex;flex-direction:column}
.q-panel.show{transform:translateY(0)}
.qp-handle{width:38px;height:4px;background:var(--bd2);border-radius:2px;
  margin:10px auto 0;cursor:pointer;flex-shrink:0}
.qp-hdr{display:flex;align-items:center;justify-content:space-between;
  padding:11px 17px;flex-shrink:0;border-bottom:1px solid var(--bd)}
.qp-ttl{font-size:15px;font-weight:800}
.qp-list{overflow-y:auto;flex:1;padding:8px 17px 18px}
.qi{display:flex;align-items:center;gap:10px;padding:9px 10px;
  border-radius:12px;cursor:pointer;transition:all .18s;margin-bottom:6px}
.qi.active{background:rgba(139,92,246,.11);border:1px solid rgba(139,92,246,.22)}
.qi:active{background:var(--c2)}
.qi-num{width:20px;text-align:center;font-size:12px;color:var(--t2);font-weight:700;flex-shrink:0}
.qi-art{width:36px;height:36px;border-radius:8px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;overflow:hidden}
.qi-art img{width:100%;height:100%;object-fit:cover;border-radius:8px}
.qi-info{flex:1;min-width:0}
.qi-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qi-artist{font-size:11px;color:var(--t2)}
.qi-dur{font-size:11px;color:var(--t2);flex-shrink:0}
.qi-rm{width:24px;height:24px;background:rgba(239,68,68,.11);border:none;
  border-radius:7px;color:var(--r);font-size:12px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;flex-shrink:0}
.qi-rm:active{transform:scale(.85)}

/* â”€â”€ MINI PLAYER â”€â”€ */
.mini-pl{position:fixed;bottom:0;left:0;right:0;z-index:300;
  max-width:430px;margin:0 auto;
  background:rgba(11,11,26,.97);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--bd);
  transform:translateY(100%);transition:transform .32s cubic-bezier(.4,0,.2,1)}
.mini-pl.show{transform:translateY(0)}
.mp-prog{height:3px;background:rgba(255,255,255,.07);cursor:pointer;overflow:hidden}
.mp-fill{height:100%;background:linear-gradient(90deg,var(--p3),var(--p2));
  width:0%;transition:width .4s linear}
.mp-body{display:flex;align-items:center;gap:11px;padding:9px 14px;
  padding-bottom:max(9px,var(--safe-b))}
.mp-art{width:42px;height:42px;border-radius:10px;
  background:linear-gradient(135deg,var(--p3),var(--b));
  display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;overflow:hidden;cursor:pointer}
.mp-art img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.mp-info{flex:1;min-width:0;cursor:pointer}
.mp-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mp-artist{font-size:11px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mp-bars{display:flex;align-items:flex-end;gap:2px;height:12px;margin-top:3px}
.mpb{width:3px;background:var(--p2);border-radius:2px;animation:mpba .65s ease infinite alternate}
.mpb:nth-child(1){animation-delay:0s}.mpb:nth-child(2){animation-delay:.17s}
.mpb:nth-child(3){animation-delay:.33s}.mpb:nth-child(4){animation-delay:.5s}
@keyframes mpba{from{height:2px}to{height:10px}}
.mp-bars.paused .mpb{animation-play-state:paused;height:3px}
.mp-ctrls{display:flex;gap:4px;align-items:center}
.mc{width:34px;height:34px;border:none;background:transparent;color:var(--t);
  font-size:17px;cursor:pointer;border-radius:50%;
  display:flex;align-items:center;justify-content:center;transition:all .15s}
.mc:active{background:rgba(255,255,255,.07)}
.mc.mpp{width:40px;height:40px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  box-shadow:0 3px 12px rgba(139,92,246,.38)}

/* â”€â”€ MODAL â”€â”€ */
.modal-ov{position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.7);
  backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center}
.modal-ov.show{display:flex}
.modal{width:100%;max-width:430px;background:var(--c2);
  border-radius:22px 22px 0 0;padding:17px 17px max(17px,var(--safe-b));
  animation:modal-up .3s cubic-bezier(.4,0,.2,1)}
@keyframes modal-up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-hdl{width:38px;height:4px;background:var(--bd2);border-radius:2px;margin:0 auto 13px}
.modal-ttl{font-size:16px;font-weight:800;margin-bottom:13px}
.modal-inp{width:100%;padding:12px 13px;background:var(--dark);
  border:1.5px solid var(--bd);border-radius:12px;color:var(--t);
  font-size:14px;outline:none;-webkit-appearance:none;font-family:inherit;margin-bottom:11px}
.modal-inp:focus{border-color:var(--p)}
.modal-inp::placeholder{color:var(--t2)}
.modal-ok{width:100%;padding:13px;
  background:linear-gradient(135deg,var(--p3),var(--p));
  border:none;border-radius:13px;color:#fff;font-size:14px;font-weight:700;
  cursor:pointer;margin-bottom:8px}
.modal-ok:active{transform:scale(.97)}
.modal-cancel{width:100%;padding:12px;background:var(--c3);border:1px solid var(--bd);
  border-radius:13px;color:var(--t);font-size:14px;font-weight:600;cursor:pointer}
.modal-cancel:active{background:var(--c4)}

/* â”€â”€ CTX MENU â”€â”€ */
.ctx{position:fixed;z-index:900;background:var(--c2);border:1px solid var(--bd2);
  border-radius:16px;padding:7px;min-width:195px;
  box-shadow:0 14px 36px rgba(0,0,0,.5);display:none}
.ctx.show{display:block}
.ctx-row{display:flex;align-items:center;gap:10px;padding:10px 11px;
  border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:background .15s}
.ctx-row:active{background:var(--c3)}
.ctx-ico{font-size:15px;width:20px;text-align:center;flex-shrink:0}
.ctx-row.red{color:var(--r)}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;top:max(68px,calc(var(--safe-t) + 68px));left:50%;
  transform:translateX(-50%) translateY(-10px);
  background:var(--c2);color:var(--t);padding:9px 17px;border-radius:22px;
  font-size:13px;font-weight:600;border:1px solid var(--bd2);z-index:1000;
  opacity:0;transition:all .25s;white-space:nowrap;pointer-events:none;
  backdrop-filter:blur(12px);max-width:86vw;text-align:center}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ BG INDICATOR â”€â”€ */
.bg-ind{position:fixed;top:max(14px,var(--safe-t));right:16px;z-index:400;
  background:rgba(139,92,246,.88);color:#fff;font-size:11px;font-weight:700;
  padding:5px 10px;border-radius:20px;display:none;align-items:center;gap:5px;
  backdrop-filter:blur(8px)}
.bg-ind.show{display:flex}
.bg-dot{width:6px;height:6px;background:#fff;border-radius:50%;
  animation:bgd 1s ease infinite alternate}
@keyframes bgd{from{opacity:.3}to{opacity:1}}

/* â”€â”€ LOADING â”€â”€ */
.ldg{display:none;text-align:center;padding:42px 0}
.ldg.show{display:block}
.spin{width:42px;height:42px;border:3px solid rgba(139,92,246,.15);
  border-top-color:var(--p);border-radius:50%;animation:sp .65s linear infinite;margin:0 auto 11px}
@keyframes sp{to{transform:rotate(360deg)}}
.ldg-t{color:var(--t2);font-size:13px}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:48px 20px}
.e-ico{font-size:48px;display:block;margin-bottom:11px}
.e-tit{font-size:17px;font-weight:700;margin-bottom:7px}
.e-sub{font-size:13px;color:var(--t2);line-height:1.6}

/* â”€â”€ PWA BANNER â”€â”€ */
.pwa-b{background:linear-gradient(135deg,rgba(139,92,246,.11),rgba(59,130,246,.07));
  border:1px solid rgba(139,92,246,.2);border-radius:14px;padding:11px 13px;
  margin-bottom:11px;display:flex;align-items:center;gap:10px}
.pwa-ico{font-size:20px;flex-shrink:0}
.pwa-txt{flex:1;font-size:12px;color:var(--t2);line-height:1.5}
.pwa-txt b{color:var(--t)}
.pwa-x{width:22px;height:22px;background:var(--c3);border:none;border-radius:6px;
  color:var(--t2);font-size:13px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;flex-shrink:0}
</style>
</head>
<body>

<div class="dyn-bg" id="dynBg"></div>
<div class="toast"  id="toast"></div>
<div class="bg-ind" id="bgInd"><div class="bg-dot"></div>Ã‡alÄ±yor</div>

<!-- CTX MENU -->
<div class="ctx" id="ctx">
  <div class="ctx-row" onclick="ctxPlay()">      <span class="ctx-ico">â–¶ï¸</span>Åimdi Ã‡al</div>
  <div class="ctx-row" onclick="ctxNext()">      <span class="ctx-ico">â­</span>SÄ±radaki Ã‡al</div>
  <div class="ctx-row" onclick="ctxQueue()">     <span class="ctx-ico">ğŸ“‹</span>SÄ±raya Ekle</div>
  <div class="ctx-row" onclick="ctxPl()">        <span class="ctx-ico">â•</span>Playliste Ekle</div>
  <div class="ctx-row" id="ctxFavRow" onclick="ctxFav()">
    <span class="ctx-ico" id="ctxFavIco">â¤ï¸</span><span id="ctxFavTxt">Favorilere Ekle</span>
  </div>
  <div class="ctx-row red" onclick="ctxDel()">   <span class="ctx-ico">ğŸ—‘ï¸</span>KaldÄ±r</div>
</div>

<!-- MODAL -->
<div class="modal-ov" id="modalOv">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-hdl"></div>
    <div class="modal-ttl" id="modalTtl">Yeni Playlist</div>
    <input class="modal-inp" id="modalInp" type="text" placeholder="Playlist adÄ±...">
    <button class="modal-ok"     onclick="modalOk()">âœ… Tamam</button>
    <button class="modal-cancel" onclick="closeModal()">Ä°ptal</button>
  </div>
</div>

<!-- QUEUE PANEL -->
<div class="q-panel" id="qPanel">
  <div class="qp-handle" onclick="closeQueue()"></div>
  <div class="qp-hdr">
    <div class="qp-ttl">ğŸ“‹ Ã‡alma SÄ±rasÄ±</div>
    <div style="display:flex;gap:8px">
      <button onclick="doShuffleQ()" style="background:var(--c3);border:none;border-radius:9px;color:var(--t2);padding:7px 11px;font-size:12px;font-weight:700;cursor:pointer">ğŸ”€</button>
      <button onclick="doClearQ()"   style="background:rgba(239,68,68,.11);border:none;border-radius:9px;color:var(--r);padding:7px 11px;font-size:12px;font-weight:700;cursor:pointer">Temizle</button>
    </div>
  </div>
  <div class="qp-list" id="qpList"></div>
</div>

<div class="shell">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-ico">ğŸµ</div>
      <div class="brand-txt">MÃ¼zik<b>Box</b> <span style="font-size:11px;color:var(--p2);font-weight:700">Pro</span></div>
    </div>
    <div class="topbar-r">
      <div class="ico-btn" onclick="openQueue()">ğŸ“‹</div>
      <div class="lib-badge" id="libBadge">0</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab on" onclick="goTab('lib',this)">    <i>ğŸµ</i>KitaplÄ±k</div>
    <div class="tab"    onclick="goTab('player',this)"> <i>ğŸ§</i>Ã‡alar</div>
    <div class="tab"    onclick="goTab('pl',this)">     <i>ğŸ“‹</i>Listeler</div>
    <div class="tab"    onclick="goTab('cfg',this)">    <i>âš™ï¸</i>Ayarlar</div>
  </div>

  <div class="pages">

    <!-- â•â•â•â•â•â• KÄ°TAPLIK â•â•â•â•â•â• -->
    <div class="pg on" id="pg-lib">

      <div class="pwa-b" id="pwaBanner">
        <div class="pwa-ico">ğŸ“²</div>
        <div class="pwa-txt"><b>Ana Ekrana Ekle</b> â†’ PaylaÅŸ â†’ Ana Ekrana Ekle â†’ Arka planda tam Ã§alma!</div>
        <button class="pwa-x" onclick="hidePWA()">âœ•</button>
      </div>

      <div class="r-banner" id="rBanner">
        <div class="rb-ico">ğŸ’¾</div>
        <div class="rb-info">
          <div class="rb-title" id="rBannerTitle">KayÄ±tlÄ± mÃ¼zikler bulundu</div>
          <div class="rb-sub"   id="rBannerSub">KÃ¼tÃ¼phaneyi tek tÄ±kla geri yÃ¼kle</div>
        </div>
        <button class="rb-btn" onclick="doRestore()">YÃ¼kle</button>
      </div>

      <!-- WELCOME -->
      <div id="folderArea">
        <div class="welcome">
          <div class="w-ico">ğŸ“</div>
          <div class="w-title">MÃ¼zik KlasÃ¶rÃ¼nÃ¼ SeÃ§</div>
          <div class="w-sub">iPhone'daki MP3 klasÃ¶rÃ¼nÃ¼ seÃ§,<br>ÅŸarkÄ±lar otomatik yÃ¼klensin!</div>
          <button class="f-btn f-btn-main" onclick="pickFolder()">ğŸ“ KlasÃ¶r SeÃ§</button>
          <button class="f-btn f-btn-sec"  onclick="pickFiles()">ğŸµ Dosya SeÃ§</button>
          <div class="how-box">
            <div class="how-ttl">ğŸ“– Kurulum</div>
            <div class="how-row"><div class="how-n">1</div><div class="how-t"><b>Dosyalar</b> â†’ "MÃ¼ziklerim" klasÃ¶rÃ¼ oluÅŸtur</div></div>
            <div class="how-row"><div class="how-n">2</div><div class="how-t">MP3'leri o klasÃ¶re taÅŸÄ±</div></div>
            <div class="how-row"><div class="how-n">3</div><div class="how-t"><b>KlasÃ¶r SeÃ§</b> â†’ klasÃ¶rÃ¼ seÃ§ â†’ otomatik yÃ¼klenir</div></div>
            <div class="how-row"><div class="how-n">4</div><div class="how-t">Bir daha seÃ§mene gerek yok â€” <b>kalÄ±cÄ± kaydedildi!</b></div></div>
          </div>
        </div>
      </div>

      <!-- LIB -->
      <div id="libArea" style="display:none">
        <div class="lib-bar">
          <div class="srch-wrap">
            <span class="srch-ico">ğŸ”</span>
            <input class="srch-inp" id="libQ" type="text" placeholder="Ara..."
              oninput="debounceFilter(this.value)">
          </div>
          <div class="sort-btn" onclick="cycleSort()">â‡… <span id="sortLbl">A-Z</span></div>
          <div class="ico-btn"  onclick="cycleView()">âŠ</div>
        </div>
        <div class="vtabs">
          <div class="vt on" onclick="setVTab(this,'all')">ğŸµ TÃ¼mÃ¼</div>
          <div class="vt" onclick="setVTab(this,'artist')">ğŸ‘¤ SanatÃ§Ä±</div>
          <div class="vt" onclick="setVTab(this,'album')">ğŸ’¿ AlbÃ¼m</div>
          <div class="vt" onclick="setVTab(this,'genre')">ğŸ¸ TÃ¼r</div>
          <div class="vt" onclick="setVTab(this,'fav')">â¤ï¸ Favori</div>
          <div class="vt" onclick="setVTab(this,'recent')">ğŸ• Son</div>
        </div>
        <div class="ldg" id="scanLdg"><div class="spin"></div><div class="ldg-t" id="scanTxt">TaranÄ±yor...</div></div>
        <div id="trackCont"></div>
        <div style="text-align:center;margin-top:13px">
          <button onclick="pickFolder()"
            style="background:var(--c1);border:1px solid var(--bd);color:var(--t2);
              padding:9px 15px;border-radius:11px;font-size:12px;font-weight:700;cursor:pointer">
            ğŸ“ KlasÃ¶rÃ¼ DeÄŸiÅŸtir / Yenile
          </button>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â• Ã‡ALAR â•â•â•â•â•â• -->
    <div class="pg" id="pg-player">
      <div class="player-pg">
        <div class="art-wrap">
          <div class="art-glow"  id="artGlow"></div>
          <div class="art-frame" id="artFrame"><span id="artEmoji">ğŸµ</span><img id="artImg" style="display:none"></div>
          <div class="art-ring"  id="artRing"></div>
        </div>
        <div class="trk-title"  id="pTitle">ÅarkÄ± SeÃ§ilmedi</div>
        <div class="trk-artist" id="pArtist">â€” KitaplÄ±ktan ÅŸarkÄ± seÃ§ â€”</div>
        <div class="trk-album"  id="pAlbum"></div>

        <div class="spectrum" id="spectrum"></div>

        <div class="seek-wrap" id="seekWrap">
          <div class="seek-track">
            <div class="seek-fill" id="seekFill"><div class="seek-thumb"></div></div>
          </div>
          <div class="seek-times"><span id="curTime">0:00</span><span id="durTime">0:00</span></div>
        </div>

        <div class="ctrl-row">
          <button class="cb sm" onclick="prevTr()">â®</button>
          <button class="cb sm" onclick="skip(-10)">â†©</button>
          <button class="cb pp" id="ppBtn" onclick="togPP()">â–¶</button>
          <button class="cb sm" onclick="skip(10)">â†ª</button>
          <button class="cb sm" onclick="nextTr()">â­</button>
        </div>

        <div class="extra-row">
          <button class="eb" id="shuffleBtn" onclick="togShuffle()">ğŸ”€<span>KarÄ±ÅŸtÄ±r</span></button>
          <button class="eb" id="repeatBtn"  onclick="togRepeat()">ğŸ”<span>Tekrar</span></button>
          <button class="eb" id="favBtn"     onclick="togFavCur()">â™¡<span>Favori</span></button>
          <button class="eb" id="eqBtn"      onclick="togEQ()">ğŸ›<span>EQ</span></button>
          <button class="eb"                 onclick="goTab('cfg',document.querySelectorAll('.tab')[3])">ğŸ˜´<span>Uyku</span></button>
        </div>

        <div class="eq-panel" id="eqPanel">
          <div class="eq-head">
            <span>ğŸ› Ekolayzer</span>
            <button onclick="applyEQPreset('Normal',null)"
              style="background:var(--c3);border:none;border-radius:7px;color:var(--t2);
                padding:4px 9px;font-size:11px;font-weight:700;cursor:pointer">SÄ±fÄ±rla</button>
          </div>
          <div class="eq-presets" id="eqPresets"></div>
          <div class="eq-bands"   id="eqBands"></div>
        </div>

        <div class="vol-row">
          <span class="vol-ico">ğŸ”ˆ</span>
          <div class="vol-track" id="volTrack"><div class="vol-fill" id="volFill"></div></div>
          <span class="vol-ico">ğŸ”Š</span>
        </div>

        <div style="text-align:center;margin-bottom:5px">
          <span style="font-size:11px;color:var(--t2);font-weight:700">HIZ: </span>
          <span style="font-size:13px;font-weight:800;color:var(--p2)" id="spdLbl">1.0x</span>
        </div>
        <div class="spd-row">
          <div class="spd-btn" onclick="setSpeed(.5)">0.5x</div>
          <div class="spd-btn" onclick="setSpeed(.75)">0.75x</div>
          <div class="spd-btn on" onclick="setSpeed(1)">1x</div>
          <div class="spd-btn" onclick="setSpeed(1.25)">1.25x</div>
          <div class="spd-btn" onclick="setSpeed(1.5)">1.5x</div>
          <div class="spd-btn" onclick="setSpeed(2)">2x</div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â• PLAYLÄ°ST â•â•â•â•â•â• -->
    <div class="pg" id="pg-pl">
      <div class="pl-hdr">
        <div class="pl-hdr-t">ğŸ“‹ Ã‡alma Listeleri</div>
        <button class="add-pl-btn" onclick="openCreatePl()">+ Yeni</button>
      </div>
      <div class="slbl">âœ¨ AkÄ±llÄ± Listeler</div>
      <div id="smartPls"></div>
      <div class="slbl">ğŸ“ Listelerim</div>
      <div id="manPls"></div>
    </div>

    <!-- â•â•â•â•â•â• AYARLAR â•â•â•â•â•â• -->
    <div class="pg" id="pg-cfg">
      <div class="set-sec">
        <div class="set-ttl">ğŸ“Š Ä°statistikler</div>
        <div class="stat-grid" id="statGrid"></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">ğŸ“ MÃ¼zik KaynaÄŸÄ±</div>
        <div class="set-row" onclick="pickFolder()"><div class="set-ico">ğŸ“‚</div><div class="set-lbl">KlasÃ¶rÃ¼ DeÄŸiÅŸtir</div><div class="set-arr">â€º</div></div>
        <div class="set-row" onclick="pickFiles()"> <div class="set-ico">ğŸµ</div><div class="set-lbl">Dosya Ekle</div><div class="set-arr">â€º</div></div>
        <div class="set-row"><div class="set-ico">ğŸ’¾</div><div class="set-lbl">KayÄ±tlÄ±</div><div class="set-val" id="cachedCnt">â€”</div></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">ğŸµ Oynatma</div>
        <div class="set-row" onclick="togSet('autoplay')"><div class="set-ico">ğŸ”„</div><div class="set-lbl">Otomatik Oynat</div><div class="tog" id="tog-autoplay"></div></div>
        <div class="set-row" onclick="togSet('spectrum')"><div class="set-ico">ğŸ“Š</div><div class="set-lbl">Spektrum GÃ¶rseli</div><div class="tog" id="tog-spectrum"></div></div>
        <div class="set-row" onclick="togSet('dynbg')">  <div class="set-ico">ğŸ¨</div><div class="set-lbl">Dinamik Arka Plan</div><div class="tog" id="tog-dynbg"></div></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">ğŸ˜´ Uyku ZamanlayÄ±cÄ±sÄ±</div>
        <div class="sleep-btns" id="sleepBtns">
          <div class="slp-btn on" onclick="setSleep(0,this)">KapalÄ±</div>
          <div class="slp-btn"   onclick="setSleep(15,this)">15 dk</div>
          <div class="slp-btn"   onclick="setSleep(30,this)">30 dk</div>
          <div class="slp-btn"   onclick="setSleep(45,this)">45 dk</div>
          <div class="slp-btn"   onclick="setSleep(60,this)">60 dk</div>
          <div class="slp-btn"   onclick="setSleep(90,this)">90 dk</div>
        </div>
        <div class="set-row"><div class="set-ico">â±</div><div class="set-lbl">Kalan</div><div class="set-val" id="sleepDisp">â€”</div></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">ğŸ¨ Tema</div>
        <div class="theme-colors" id="themeColors"></div>
      </div>
      <div class="set-sec">
        <div class="set-ttl">âš ï¸ Veri</div>
        <div class="set-row" onclick="clearAll()"><div class="set-ico">ğŸ—‘ï¸</div><div class="set-lbl">TÃ¼m Verileri Temizle</div><div class="set-arr">â€º</div></div>
      </div>
    </div>

  </div><!-- /pages -->
</div><!-- /shell -->

<!-- MINI PLAYER -->
<div class="mini-pl" id="miniPl">
  <div class="mp-prog" id="mpProg" onclick="miniSeek(event)">
    <div class="mp-fill" id="mpFill"></div>
  </div>
  <div class="mp-body">
    <div class="mp-art" id="mpArt"
      onclick="goTab('player',document.querySelectorAll('.tab')[1])">ğŸµ</div>
    <div class="mp-info"
      onclick="goTab('player',document.querySelectorAll('.tab')[1])">
      <div class="mp-title"  id="mpTitle">â€”</div>
      <div class="mp-artist" id="mpArtist">â€”</div>
      <div class="mp-bars paused" id="mpBars">
        <div class="mpb"></div><div class="mpb"></div>
        <div class="mpb"></div><div class="mpb"></div>
      </div>
    </div>
    <div class="mp-ctrls">
      <button class="mc"    onclick="prevTr()">â®</button>
      <button class="mc mpp" id="mpPP" onclick="togPP()">â–¶</button>
      <button class="mc"    onclick="nextTr()">â­</button>
    </div>
  </div>
</div>

<!-- AUDIO â€” doÄŸrudan element, Web Audio kullanÄ±lmÄ±yor (iOS arka plan iÃ§in) -->
<audio id="aud" preload="auto" playsinline webkit-playsinline x-webkit-airplay="allow"></audio>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INDEXEDDB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB_NAME = 'muzikbox_v3';
const DB_VER  = 1;
let db = null;

function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('files'))  d.createObjectStore('files',  { keyPath:'id' });
      if (!d.objectStoreNames.contains('meta'))   d.createObjectStore('meta',   { keyPath:'id' });
    };
    r.onsuccess = e => { db = e.target.result; res(); };
    r.onerror   = e => rej(e.target.error);
  });
}

function dbPut(store, obj) {
  return new Promise((res, rej) => {
    try {
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).put(obj).onsuccess = () => res();
      tx.onerror = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

function dbGetAll(store) {
  return new Promise((res, rej) => {
    try {
      const tx  = db.transaction(store, 'readonly');
      const req = tx.objectStore(store).getAll();
      req.onsuccess = e => res(e.target.result || []);
      req.onerror   = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

function dbGet(store, key) {
  return new Promise((res) => {
    try {
      const tx  = db.transaction(store, 'readonly');
      const req = tx.objectStore(store).get(key);
      req.onsuccess = e => res(e.target.result || null);
      req.onerror   = () => res(null);
    } catch { res(null); }
  });
}

function dbDel(store, key) {
  return new Promise((res) => {
    try {
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).delete(key);
      tx.oncomplete = () => res();
      tx.onerror    = () => res();
    } catch { res(); }
  });
}

function dbClear(store) {
  return new Promise((res) => {
    try {
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).clear();
      tx.oncomplete = () => res();
      tx.onerror    = () => res();
    } catch { res(); }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tracks      = [];       // tÃ¼m yÃ¼klÃ¼ ÅŸarkÄ±lar
let queue       = [];       // mevcut Ã§alma sÄ±rasÄ±
let ci          = -1;       // queue index
let playing     = false;
let shuffleOn   = false;
let repeatMode  = 0;        // 0=off 1=all 2=one
let vol         = 0.85;
let speed       = 1.0;
let libView     = 'list';   // list | grid
let libSort     = 'title';
let libVTab     = 'all';
let libFilter   = '';
let filterTimer = null;

// LocalStorage verileri
let favSet      = new Set(JSON.parse(ls('mb_favs')   || '[]'));
let playlists   = JSON.parse(ls('mb_pls')             || '[]');
let cfg         = JSON.parse(ls('mb_cfg')             || '{}');
let history     = JSON.parse(ls('mb_hist')            || '[]');
let playCnt     = JSON.parse(ls('mb_cnt')             || '{}');

// Defaults
const DEF_CFG = { autoplay:true, spectrum:true, dynbg:true };
cfg = { ...DEF_CFG, ...cfg };

// Sleep timer
let sleepTO  = null;
let sleepIv  = null;

// Context menu track
let ctxTr = null;

// Seek drag
let seekDrag = false;

// In-memory blob URLs (cleared on new load)
let blobMap  = {};   // id â†’ audio blob URL
let coverMap = {};   // id â†’ cover blob URL

// Modal mode
let modalMode  = '';
let modalExtra = null;

// MediaSession listener cleanup
let msCleanup = null;

const aud = document.getElementById('aud');
aud.volume = vol;

function ls(k, v) {
  if (v === undefined) return localStorage.getItem(k);
  localStorage.setItem(k, v);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   iOS ARKA PLAN SES YÃ–NETÄ°MÄ°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // Arka plana gidiyor â€” state kaydet
    ls('mb_bg_play',  playing ? '1' : '0');
    ls('mb_bg_time',  String(aud.currentTime));
    ls('mb_bg_ci',    String(ci));
    document.getElementById('bgInd').classList.add('show');
  } else {
    // Ã–ne geliyor
    document.getElementById('bgInd').classList.remove('show');
    // iOS bazen audio'yu durdurur â€” kontrol et
    if (playing && aud.paused && aud.src) {
      setTimeout(() => aud.play().catch(() => {}), 250);
    }
    startFakeSpectrum();
  }
}, false);

window.addEventListener('pageshow', e => {
  if (e.persisted && playing && aud.paused && aud.src) {
    setTimeout(() => aud.play().catch(() => {}), 400);
  }
});

window.addEventListener('focus', () => {
  if (playing && aud.paused && aud.src) {
    setTimeout(() => aud.play().catch(() => {}), 250);
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goTab(id, el) {
  document.querySelectorAll('.pg').forEach(p  => p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.getElementById('pg-' + id).classList.add('on');
  if (el) el.classList.add('on');
  if (id === 'pl')  renderPls();
  if (id === 'cfg') renderCfg();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOSYA SEÃ‡Ä°MÄ°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pickFolder() {
  try {
    if (!('showDirectoryPicker' in window)) { pickFiles(); return; }
    const dh = await window.showDirectoryPicker({ mode:'read' });
    await processDir(dh);
  } catch(e) {
    if (e.name !== 'AbortError') showToast('âŒ ' + e.message);
  }
}

async function processDir(dh) {
  showScanUI(true);
  const fileItems = [];
  await collectFiles(dh, fileItems, '', 0);
  await loadFiles(fileItems);
}

async function collectFiles(dh, arr, path, depth) {
  // Max 8 seviye derinlik â€” stack overflow Ã¶nlemi
  if (depth > 8) return;
  try {
    for await (const [name, handle] of dh.entries()) {
      if (handle.kind === 'file') {
        const ext = name.split('.').pop().toLowerCase();
        if (['mp3','m4a','aac','wav','ogg','flac','opus','weba'].includes(ext)) {
          arr.push({ handle, path });
        }
      } else if (handle.kind === 'directory') {
        await collectFiles(handle, arr, path ? path+'/'+name : name, depth + 1);
      }
    }
  } catch {}
}

function pickFiles() {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.multiple = true;
  inp.accept = 'audio/*,.mp3,.m4a,.aac,.wav,.ogg,.flac,.opus';
  // AynÄ± dosyalar yeniden seÃ§ilebilsin
  inp.value = '';
  inp.onchange = async e => {
    if (!e.target.files.length) return;
    showScanUI(true);
    const items = Array.from(e.target.files).map(f => ({ file:f, path:'' }));
    await loadFiles(items);
  };
  inp.click();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOSYA YÃœKLEME & IndexedDB KAYIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadFiles(items) {
  // Ã–nceki blob URL'leri temizle (memory leak Ã¶nlemi)
  freeAllBlobs();
  tracks = [];

  // IndexedDB sÄ±fÄ±rla
  await dbClear('files');
  await dbClear('meta');

  const total = items.length;
  let   count = 0;

  for (const item of items) {
    try {
      // DosyayÄ± al
      const file = item.file ? item.file : await item.handle.getFile();

      document.getElementById('scanTxt').textContent =
        `${++count}/${total} taranÄ±yor... (${file.name.substring(0,20)})`;

      const id  = 'tr_' + genId();
      const ext = file.name.split('.').pop().toLowerCase();

      // ID3 â€” sadece ilk 256KB oku (RAM tasarrufu iÃ§in HATA 20 dÃ¼zeltmesi)
      const headerBuf = await readPartial(file, 256 * 1024);
      const tags      = parseID3(headerBuf, file.name);

      // Audio blob oluÅŸtur ve IndexedDB'ye kaydet
      // NOT: iOS IndexedDB limiti ~50MB â€” bÃ¼yÃ¼k dosyalarÄ± kaydetmiyoruz (HATA 21)
      // Bunun yerine metadata + kÃ¼Ã§Ã¼k cover kaydediyoruz
      // Dosya blob URL'si oturumda tutulur, restore iÃ§in dosya boyutunu kontrol et
      const shouldSaveBlob = file.size < 15 * 1024 * 1024; // 15MB altÄ± kaydet
      const fileBlob       = new Blob([await file.arrayBuffer()], {
        type: file.type || mimeFromExt(ext)
      });
      const blobUrl = URL.createObjectURL(fileBlob);
      blobMap[id]   = blobUrl;

      // IndexedDB'ye kaydet (kÃ¼Ã§Ã¼kse)
      if (shouldSaveBlob) {
        await dbPut('files', { id, data: fileBlob });
      }

      // Kapak
      let coverUrl = null;
      if (tags.coverBlob) {
        coverUrl    = URL.createObjectURL(tags.coverBlob);
        coverMap[id]= coverUrl;
        await dbPut('files', { id: id + '_cov', data: tags.coverBlob });
      }

      // SÃ¼re
      let duration = 0;
      try { duration = await getAudioDuration(blobUrl); } catch {}

      const meta = {
        id,
        name:      file.name,
        path:      item.path || '',
        size:      file.size,
        format:    ext.toUpperCase(),
        title:     tags.title  || cleanName(file.name),
        artist:    tags.artist || 'Bilinmeyen SanatÃ§Ä±',
        album:     tags.album  || 'Bilinmeyen AlbÃ¼m',
        genre:     tags.genre  || '',
        year:      tags.year   || '',
        trackNum:  tags.trackNum || 0,
        duration,
        hasCover:  !!tags.coverBlob,
        savedBlob: shouldSaveBlob,
        plays:     playCnt[file.name] || 0,
      };

      await dbPut('meta', meta);
      tracks.push({ ...meta, url: blobUrl, cover: coverUrl });

    } catch(e) {
      console.warn('Track load error:', e);
    }
  }

  showScanUI(false);
  afterLoad();
}

// DosyanÄ±n ilk N byte'Ä±nÄ± oku
function readPartial(file, bytes) {
  const slice = file.slice(0, bytes);
  return slice.arrayBuffer();
}

function mimeFromExt(ext) {
  const m = { mp3:'audio/mpeg', m4a:'audio/mp4', aac:'audio/aac',
              wav:'audio/wav', ogg:'audio/ogg', flac:'audio/flac', opus:'audio/opus' };
  return m[ext] || 'audio/mpeg';
}

function freeAllBlobs() {
  Object.values(blobMap).forEach(u  => { try { URL.revokeObjectURL(u);  } catch {} });
  Object.values(coverMap).forEach(u => { try { URL.revokeObjectURL(u); } catch {} });
  blobMap  = {};
  coverMap = {};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESTORE â€” IndexedDB'den geri yÃ¼kleme
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function checkRestore() {
  try {
    const metas = await dbGetAll('meta');
    if (!metas.length) return;
    const banner = document.getElementById('rBanner');
    document.getElementById('rBannerTitle').textContent = `${metas.length} ÅŸarkÄ± kaydedilmiÅŸ`;
    document.getElementById('rBannerSub').textContent   = 'Son kÃ¼tÃ¼phaneyi geri yÃ¼kle';
    banner.classList.add('show');
    document.getElementById('cachedCnt').textContent = metas.length + ' ÅŸarkÄ±';
  } catch {}
}

async function doRestore() {
  document.getElementById('rBanner').classList.remove('show');
  showScanUI(true);
  freeAllBlobs();
  tracks = [];

  try {
    const metas = await dbGetAll('meta');
    const total = metas.length;
    let   count = 0;

    for (const meta of metas) {
      try {
        document.getElementById('scanTxt').textContent =
          `${++count}/${total} yÃ¼kleniyor...`;

        let blobUrl  = null;
        let coverUrl = null;

        // Dosya blob'u al
        if (meta.savedBlob) {
          const stored = await dbGet('files', meta.id);
          if (stored?.data) {
            blobUrl    = URL.createObjectURL(stored.data);
            blobMap[meta.id] = blobUrl;
          }
        }

        // Kapak
        if (meta.hasCover) {
          const covStored = await dbGet('files', meta.id + '_cov');
          if (covStored?.data) {
            coverUrl = URL.createObjectURL(covStored.data);
            coverMap[meta.id] = coverUrl;
          }
        }

        if (!blobUrl) continue; // blob yoksa atla

        tracks.push({ ...meta, url: blobUrl, cover: coverUrl });

      } catch(e) { console.warn('Restore error:', e); }
    }

    showScanUI(false);
    afterLoad();
    showToast(`âœ… ${tracks.length} ÅŸarkÄ± geri yÃ¼klendi`);
  } catch(e) {
    showScanUI(false);
    showToast('âŒ Geri yÃ¼kleme hatasÄ±');
    console.error(e);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ID3 PARSER â€” Sadece header buffer Ã¼zerinde Ã§alÄ±ÅŸÄ±r
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseID3(buf, filename) {
  const tags = { title:'', artist:'', album:'', genre:'', year:'', trackNum:0, coverBlob:null };
  if (!buf || buf.byteLength < 10) return tags;

  const dv = new DataView(buf);
  const h  = String.fromCharCode(dv.getUint8(0), dv.getUint8(1), dv.getUint8(2));
  if (h !== 'ID3') return tags;

  const ver  = dv.getUint8(3);
  const size = ((dv.getUint8(6)&0x7f)<<21)|((dv.getUint8(7)&0x7f)<<14)|
               ((dv.getUint8(8)&0x7f)<<7) | (dv.getUint8(9)&0x7f);

  let off = 10;
  const end = Math.min(10 + size, buf.byteLength);

  while (off < end - 10) {
    // Frame ID (4 chars for v2.3+, 3 for v2.2)
    const fid = String.fromCharCode(
      dv.getUint8(off), dv.getUint8(off+1),
      dv.getUint8(off+2), dv.getUint8(off+3)
    );
    if (!/^[A-Z0-9]{3,4}$/.test(fid)) break;

    let fsize;
    if (ver >= 3) {
      fsize = ver >= 4
        ? ((dv.getUint8(off+4)&0x7f)<<21)|((dv.getUint8(off+5)&0x7f)<<14)|
          ((dv.getUint8(off+6)&0x7f)<<7) | (dv.getUint8(off+7)&0x7f)
        : (dv.getUint8(off+4)<<24)|(dv.getUint8(off+5)<<16)|
          (dv.getUint8(off+6)<<8) | dv.getUint8(off+7);
      off += 10;
    } else {
      // ID3v2.2
      fsize = (dv.getUint8(off+3)<<16)|(dv.getUint8(off+4)<<8)|dv.getUint8(off+5);
      off += 6;
    }

    if (fsize <= 0 || fsize > buf.byteLength) break;
    const ds = off;
    const de = Math.min(ds + fsize, buf.byteLength);

    try {
      if (['TIT2','TT2'].includes(fid))         tags.title    = readTxt(buf,ds,de);
      else if (['TPE1','TP1'].includes(fid))     tags.artist   = readTxt(buf,ds,de);
      else if (['TALB','TAL'].includes(fid))     tags.album    = readTxt(buf,ds,de);
      else if (['TCON','TCO'].includes(fid))     tags.genre    = parseGenre(readTxt(buf,ds,de));
      else if (['TDRC','TYER','TYE'].includes(fid)) tags.year  = readTxt(buf,ds,de).substring(0,4);
      else if (['TRCK','TRK'].includes(fid))     tags.trackNum = parseInt(readTxt(buf,ds,de))||0;
      else if (['APIC','PIC'].includes(fid))     tags.coverBlob = readCover(buf,ds,de);
    } catch {}

    off = de;
  }

  return tags;
}

function readTxt(buf, s, e) {
  if (s >= e) return '';
  const enc   = new DataView(buf).getUint8(s);
  const bytes = new Uint8Array(buf, s + 1, Math.max(0, e - s - 1));
  try {
    if (enc === 0) return new TextDecoder('iso-8859-1').decode(bytes).replace(/\0/g,'').trim();
    if (enc === 1 || enc === 2) return new TextDecoder('utf-16').decode(bytes).replace(/\0/g,'').trim();
    return new TextDecoder('utf-8').decode(bytes).replace(/\0/g,'').trim();
  } catch {
    return new TextDecoder('utf-8',{fatal:false}).decode(bytes).replace(/\0/g,'').trim();
  }
}

function readCover(buf, s, e) {
  try {
    const dv  = new DataView(buf);
    let   off = s + 1; // skip encoding byte
    // mime type (null-terminated)
    let mime  = '';
    while (off < e && dv.getUint8(off) !== 0) { mime += String.fromCharCode(dv.getUint8(off++)); }
    off++; // null
    off++; // picture type
    // description (null-terminated, respect encoding)
    const enc = dv.getUint8(s);
    if (enc === 1 || enc === 2) {
      while (off + 1 < e && !(dv.getUint8(off)===0 && dv.getUint8(off+1)===0)) off++;
      off += 2;
    } else {
      while (off < e && dv.getUint8(off) !== 0) off++;
      off++;
    }
    if (off >= e) return null;
    const mimeType = mime.toLowerCase().includes('png') ? 'image/png' : 'image/jpeg';
    return new Blob([new Uint8Array(buf, off, e - off)], { type: mimeType });
  } catch { return null; }
}

const GENRES = ['Blues','Classic Rock','Country','Dance','Disco','Funk','Grunge',
  'Hip-Hop','Jazz','Metal','New Age','Oldies','Other','Pop','R&B','Rap',
  'Reggae','Rock','Techno','Industrial','Alternative','Ska','Death Metal',
  'Pranks','Soundtrack','Euro-Techno','Ambient','Trip-Hop','Vocal','Jazz+Funk',
  'Fusion','Trance','Classical','Instrumental','Acid','House','Game','Sound Clip',
  'Gospel','Noise','Alternative Rock','Bass','Soul','Punk','Space'];

function parseGenre(g) {
  if (!g) return '';
  const m = g.match(/^\((\d+)\)/);
  if (m) return GENRES[parseInt(m[1])] || g;
  return g;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YARDIMCI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function cleanName(fn) {
  return fn.replace(/\.[^/.]+$/, '').replace(/[_\-]+/g,' ').trim();
}

function getAudioDuration(url) {
  return new Promise((res, rej) => {
    const a = new Audio();
    const cleanup = () => { a.src = ''; };
    a.addEventListener('loadedmetadata', () => { res(a.duration); cleanup(); }, {once:true});
    a.addEventListener('error', e => { cleanup(); rej(e); }, {once:true});
    a.preload = 'metadata';
    a.src     = url;
  });
}

function genId() {
  return Math.random().toString(36).substr(2,9) + Date.now().toString(36);
}

function fmtSec(s) {
  if (!s || isNaN(s) || !isFinite(s)) return '0:00';
  const m = Math.floor(s / 60);
  const ss = Math.floor(s % 60);
  return `${m}:${ss.toString().padStart(2,'0')}`;
}

// GÃ¼Ã§lendirilmiÅŸ escape â€” onclick attr iÃ§indeki apostrof de dahil
function esc(s) {
  if (!s) return '';
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// data-id kullanarak string injection sorununu tamamen bertaraf et
let _idMap = {};   // data-id â†’ track id (HATA 3 dÃ¼zeltmesi)
function regId(id) {
  const k = 'k' + Object.keys(_idMap).length;
  _idMap[k] = id;
  return k;
}
function getTrById(k) {
  const id = _idMap[k];
  return id ? tracks.find(t => t.id === id) : null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AFTER LOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function afterLoad() {
  if (!tracks.length) {
    showScanUI(false);
    showToast('âš ï¸ Ses dosyasÄ± bulunamadÄ±');
    document.getElementById('folderArea').style.display = 'block';
    document.getElementById('libArea').style.display    = 'none';
    return;
  }

  // Queue sÄ±fÄ±rla ve tracks ile doldur (HATA 4 & 5 dÃ¼zeltmesi)
  queue = [...tracks];
  ci    = -1;

  document.getElementById('folderArea').style.display = 'none';
  document.getElementById('libArea').style.display    = 'block';
  document.getElementById('cachedCnt').textContent    = tracks.length + ' ÅŸarkÄ±';
  updateBadge();
  renderLib();
  renderPls();
  renderStats();
  showToast(`âœ… ${tracks.length} ÅŸarkÄ± yÃ¼klendi`);

  if (cfg.autoplay && ci < 0) {
    queue = [...tracks];
    ci    = 0;
    playIdx(0);
  }
}

function showScanUI(show) {
  document.getElementById('scanLdg').classList.toggle('show', show);
  if (show) {
    document.getElementById('folderArea').style.display = 'none';
    document.getElementById('libArea').style.display    = 'block';
    document.getElementById('trackCont').innerHTML      = '';
    _idMap = {};
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KÄ°TAPLIK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SORTS  = ['title','artist','album','duration','plays'];
const SLBLS  = { title:'A-Z', artist:'SanatÃ§Ä±', album:'AlbÃ¼m', duration:'SÃ¼re', plays:'Ã‡alma' };
let   sortI  = 0;

function setVTab(el, tab) {
  document.querySelectorAll('.vt').forEach(v => v.classList.remove('on'));
  el.classList.add('on');
  libVTab = tab;
  _idMap  = {};
  renderLib();
}

// Debounce â€” HATA 18 dÃ¼zeltmesi
function debounceFilter(val) {
  clearTimeout(filterTimer);
  filterTimer = setTimeout(() => { libFilter = val.toLowerCase().trim(); _idMap = {}; renderLib(); }, 220);
}

function cycleSort() {
  sortI   = (sortI + 1) % SORTS.length;
  libSort = SORTS[sortI];
  document.getElementById('sortLbl').textContent = SLBLS[libSort];
  renderLib();
}

function cycleView() {
  libView = libView === 'list' ? 'grid' : 'list';
  renderLib();
}

function getFiltered() {
  let list = [...tracks];

  if (libVTab === 'fav')    list = list.filter(t => favSet.has(t.id));
  if (libVTab === 'recent') {
    const seen = new Set();
    list = history.map(id => tracks.find(t => t.id === id))
                  .filter(t => { if(!t||seen.has(t.id)) return false; seen.add(t.id); return true; })
                  .slice(0, 60);
  }

  if (libFilter) {
    list = list.filter(t =>
      t.title.toLowerCase().includes(libFilter)  ||
      t.artist.toLowerCase().includes(libFilter) ||
      t.album.toLowerCase().includes(libFilter)
    );
  }

  if (libVTab !== 'recent') {
    list.sort((a,b) => {
      switch(libSort) {
        case 'artist':   return a.artist.localeCompare(b.artist);
        case 'album':    return a.album.localeCompare(b.album);
        case 'duration': return a.duration - b.duration;
        case 'plays':    return (b.plays||0) - (a.plays||0);
        default:         return a.title.localeCompare(b.title);
      }
    });
  }
  return list;
}

function renderLib() {
  if (!tracks.length) return;
  _idMap = {};   // Her render'da harita sÄ±fÄ±rla
  const list = getFiltered();

  if (['artist','album','genre'].includes(libVTab)) { renderGrouped(list, libVTab); return; }

  const cont = document.getElementById('trackCont');
  if (!list.length) {
    cont.innerHTML = `<div class="empty"><span class="e-ico">ğŸ”</span>
      <div class="e-tit">SonuÃ§ Yok</div>
      <div class="e-sub">FarklÄ± bir arama dene</div></div>`;
    return;
  }

  if (libView === 'grid') {
    cont.innerHTML = '<div class="grid-view">' +
      list.map(tr => {
        const k = regId(tr.id);
        const playing = queue[ci]?.id === tr.id;
        return `<div class="gc${playing?' playing':''}" data-k="${k}"
          onclick="playByKey(this.dataset.k)">
          <div class="gc-art">${tr.cover?`<img src="${esc(tr.cover)}">`:'ğŸµ'}</div>
          <div class="gc-title">${esc(tr.title)}</div>
          <div class="gc-artist">${esc(tr.artist)}</div>
        </div>`;
      }).join('') + '</div>';
  } else {
    cont.innerHTML = list.map(tr => buildTC(tr)).join('');
  }
}

function renderGrouped(list, key) {
  const groups = {};
  list.forEach(t => {
    const k = t[key] || 'Bilinmeyen';
    (groups[k] = groups[k] || []).push(t);
  });
  const keys = Object.keys(groups).sort();
  const cont = document.getElementById('trackCont');
  if (!keys.length) {
    cont.innerHTML = `<div class="empty"><span class="e-ico">ğŸ“­</span>
      <div class="e-tit">BoÅŸ</div></div>`;
    return;
  }
  cont.innerHTML = '<div class="sec-grid">' +
    keys.map(k => {
      const cov  = groups[k].find(t => t.cover)?.cover;
      const safe = encodeURIComponent(k);
      return `<div class="sg" data-key="${esc(key)}" data-val="${safe}"
        onclick="playGroupEl(this)">
        <span class="sg-ico">
          ${cov
            ? `<img src="${esc(cov)}" style="width:34px;height:34px;border-radius:7px;object-fit:cover">`
            : (key==='artist'?'ğŸ‘¤':key==='album'?'ğŸ’¿':'ğŸ¸')}
        </span>
        <div class="sg-name">${esc(k)}</div>
        <div class="sg-cnt">${groups[k].length} ÅŸarkÄ±</div>
      </div>`;
    }).join('') + '</div>';
}

// HATA 3 dÃ¼zeltmesi â€” artÄ±k onclick string injection yok
function playGroupEl(el) {
  const key = el.dataset.key;
  const val = decodeURIComponent(el.dataset.val);
  const list = tracks.filter(t => (t[key]||'Bilinmeyen') === val);
  if (!list.length) return;
  queue = [...list];
  ci    = 0;
  playIdx(0);
  goTab('player', document.querySelectorAll('.tab')[1]);
}

function buildTC(tr) {
  const k      = regId(tr.id);
  const isCur  = queue[ci]?.id === tr.id;  // HATA 15 â€” optional chaining
  const favOn  = favSet.has(tr.id);
  const fmtClr = { MP3:'rgba(139,92,246,.14);color:var(--p2)', FLAC:'rgba(16,185,129,.14);color:var(--g)',
                   WAV:'rgba(245,158,11,.14);color:var(--o)'  }[tr.format]
                 || 'rgba(59,130,246,.14);color:var(--b)';
  return `<div class="tc${isCur?' playing':''}" data-k="${k}" onclick="playByKey(this.dataset.k)">
    ${tr.cover
      ? `<img class="tc-art" src="${esc(tr.cover)}"
          onerror="this.style.display='none';this.nextSibling.style.display='flex'">`
      : ''}
    <div class="tc-ph" style="${tr.cover?'display:none':''}">ğŸµ</div>
    <div class="tc-info">
      <div class="tc-title">${esc(tr.title)}</div>
      <div class="tc-artist">${esc(tr.artist)}</div>
      <div class="tc-meta">
        <span class="tc-dur">${fmtSec(tr.duration)}</span>
        <span class="tc-fmt" style="background:${fmtClr}">${tr.format}</span>
        ${tr.genre?`<span class="tc-fmt" style="background:rgba(255,255,255,.05);color:var(--t2)">${esc(tr.genre)}</span>`:''}
      </div>
    </div>
    <div class="tc-acts">
      <button class="ta ta-fav${favOn?' on':''}" data-k="${k}"
        onclick="event.stopPropagation();favByKey(this.dataset.k,this)">${favOn?'â™¥':'â™¡'}</button>
      <button class="ta ta-menu" data-k="${k}"
        onclick="event.stopPropagation();openCtx(this.dataset.k,this)">â‹¯</button>
    </div>
    ${isCur?`<div class="play-ind">
      <div class="pb${playing?'':' paused'}"></div>
      <div class="pb${playing?'':' paused'}"></div>
      <div class="pb${playing?'':' paused'}"></div>
    </div>`:''}
  </div>`;
}

// data-k ile gÃ¼venli eriÅŸim
function playByKey(k) {
  const tr = getTrById(k);
  if (!tr) return;
  // Queue = tÃ¼m filtered liste (HATA 5 dÃ¼zeltmesi â€” filtreye gÃ¶re deÄŸil, tÃ¼m tracks)
  queue = [...tracks];
  ci    = queue.findIndex(t => t.id === tr.id);
  if (ci < 0) { queue.push(tr); ci = queue.length - 1; }
  playIdx(ci);
  goTab('player', document.querySelectorAll('.tab')[1]);
}

function favByKey(k, btn) {
  const tr = getTrById(k);
  if (!tr) return;
  togFavById(tr.id, btn);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OYNATMA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function playIdx(i) {
  if (i < 0 || i >= queue.length) return;
  ci = i;
  const tr = queue[ci];
  if (!tr?.url) { showToast('âš ï¸ Ses dosyasÄ± yÃ¼klenemedi'); return; }

  // iOS race condition Ã¶nlemi â€” HATA 22 dÃ¼zeltmesi
  aud.pause();
  // KÄ±sa gecikmeyle src ata
  setTimeout(() => {
    aud.src          = tr.url;
    aud.volume       = vol;
    aud.playbackRate = speed;
    aud.load();

    const p = aud.play();
    if (p) {
      p.then(() => {
        updatePS(true);
        updatePlayerUI(tr);
        updateMS(tr);
        logPlay(tr);
        renderLib();
        renderQ();
        startFakeSpectrum();
      }).catch(e => {
        console.warn('Play error:', e.message);
        updatePS(false);
        showToast('â–¶ Oynatmak iÃ§in ekrana dokun');
      });
    }
  }, 50);
}

function logPlay(tr) {
  history = [tr.id, ...history.filter(id => id !== tr.id)].slice(0, 100);
  ls('mb_hist', JSON.stringify(history));
  playCnt[tr.name] = (playCnt[tr.name] || 0) + 1;
  tr.plays = playCnt[tr.name];
  ls('mb_cnt', JSON.stringify(playCnt));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPECTRUM (simÃ¼le â€” Web Audio yok, iOS uyumlu)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSpectrum() {
  const sp = document.getElementById('spectrum');
  sp.innerHTML = '';
  for (let i = 0; i < 40; i++) {
    const b = document.createElement('div');
    b.className = 'sp-b';
    sp.appendChild(b);
  }
}

let specRaf  = null;
let specVals = [];

function startFakeSpectrum() {
  if (specRaf) cancelAnimationFrame(specRaf);
  const bars = document.querySelectorAll('.sp-b');
  if (!bars.length || !cfg.spectrum) return;

  if (!specVals.length) specVals = Array.from({length:bars.length}, () => Math.random());

  function draw() {
    specRaf = requestAnimationFrame(draw);
    bars.forEach((b, i) => {
      if (playing) {
        specVals[i] = Math.max(0, Math.min(1, specVals[i] + (Math.random()-.5)*.28));
      } else {
        specVals[i] = Math.max(0, specVals[i] - .05);
      }
      b.style.height  = (specVals[i] * 30 + 3) + 'px';
      b.style.opacity = (.35 + specVals[i] * .65).toFixed(2);
    });
  }
  draw();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updatePlayerUI(tr) {
  document.getElementById('pTitle').textContent  = tr.title;
  document.getElementById('pArtist').textContent = tr.artist;
  document.getElementById('pAlbum').textContent  = tr.album !== 'Bilinmeyen AlbÃ¼m' ? tr.album : '';

  const img   = document.getElementById('artImg');
  const emoji = document.getElementById('artEmoji');
  if (tr.cover) {
    img.src = tr.cover; img.style.display = 'block'; emoji.style.display = 'none';
    if (cfg.dynbg) updateDynBg(tr.cover);
  } else {
    img.style.display = 'none'; emoji.style.display = 'block';
    resetDynBg();
  }

  document.getElementById('mpTitle').textContent  = tr.title;
  document.getElementById('mpArtist').textContent = tr.artist;

  const ma = document.getElementById('mpArt');
  ma.innerHTML = tr.cover
    ? `<img src="${esc(tr.cover)}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">`
    : 'ğŸµ';

  document.getElementById('miniPl').classList.add('show');
  refreshFavBtn(tr.id);
}

function refreshFavBtn(id) {
  const on = favSet.has(id);
  document.getElementById('favBtn').innerHTML = `${on?'â™¥':'â™¡'}<span>Favori</span>`;
}

function updateDynBg(url) {
  try {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = c.height = 6;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, 6, 6);
      const d = ctx.getImageData(0,0,6,6).data;
      let r=0,g=0,b=0,n=0;
      for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];n++;}
      r=Math.round(r/n);g=Math.round(g/n);b=Math.round(b/n);
      document.documentElement.style.setProperty('--p3',`rgb(${r},${g},${b})`);
      document.documentElement.style.setProperty('--p4',`rgb(${Math.round(b*.4)},${Math.round(r*.3)},${Math.round(g*.7)})`);
      document.getElementById('artGlow').style.background =
        `radial-gradient(circle,rgb(${r},${g},${b}) 0%,transparent 65%)`;
    };
    img.src = url;
  } catch {}
}

function resetDynBg() {
  document.documentElement.style.setProperty('--p3','#6d28d9');
  document.documentElement.style.setProperty('--p4','#4c1d95');
  document.getElementById('artGlow').style.background =
    'radial-gradient(circle,var(--p3) 0%,transparent 65%)';
}

function updatePS(isPlay) {
  playing = isPlay;
  document.getElementById('ppBtn').textContent = isPlay ? 'â¸' : 'â–¶';
  document.getElementById('mpPP').textContent  = isPlay ? 'â¸' : 'â–¶';
  document.getElementById('artRing').classList.toggle('show', isPlay);
  document.getElementById('mpBars').classList.toggle('paused', !isPlay);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KONTROLLER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togPP() {
  if (!aud.src && queue.length) { playIdx(Math.max(ci,0)); return; }
  if (!aud.src) return;
  if (playing) { aud.pause(); }
  else         { aud.play().catch(() => {}); }
}

function nextTr() {
  if (!queue.length) return;
  const ni = shuffleOn
    ? Math.floor(Math.random() * queue.length)
    : (ci + 1) % queue.length;
  playIdx(ni);
}

function prevTr() {
  if (!queue.length) return;
  if (aud.currentTime > 4) { aud.currentTime = 0; return; }
  playIdx((ci - 1 + queue.length) % queue.length);
}

function skip(sec) {
  if (!aud.duration) return;
  aud.currentTime = Math.max(0, Math.min(aud.duration, aud.currentTime + sec));
}

function togShuffle() {
  shuffleOn = !shuffleOn;
  document.getElementById('shuffleBtn').classList.toggle('on', shuffleOn);
  showToast(shuffleOn ? 'ğŸ”€ KarÄ±ÅŸtÄ±r aÃ§Ä±k' : 'ğŸ”€ KapalÄ±');
}

function togRepeat() {
  repeatMode = (repeatMode + 1) % 3;
  const ico  = ['ğŸ”','ğŸ”','ğŸ”‚'][repeatMode];
  const lbl  = ['Tekrar','TÃ¼mÃ¼','Biri'][repeatMode];
  document.getElementById('repeatBtn').innerHTML = `${ico}<span>${lbl}</span>`;
  document.getElementById('repeatBtn').classList.toggle('on', repeatMode > 0);
  showToast(['ğŸ” KapalÄ±','ğŸ” TÃ¼mÃ¼nÃ¼ tekrar','ğŸ”‚ Birini tekrar'][repeatMode]);
}

function setSpeed(s) {
  speed = s;
  aud.playbackRate = s;
  document.getElementById('spdLbl').textContent = s + 'x';
  document.querySelectorAll('.spd-btn').forEach(b =>
    b.classList.toggle('on', parseFloat(b.textContent) === s)
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
aud.addEventListener('play',  () => updatePS(true));
aud.addEventListener('pause', () => updatePS(false));

aud.addEventListener('timeupdate', () => {
  if (!aud.duration || !isFinite(aud.duration) || seekDrag) return;
  const pct = aud.currentTime / aud.duration * 100;
  document.getElementById('seekFill').style.width = pct + '%';
  document.getElementById('mpFill').style.width   = pct + '%';
  document.getElementById('curTime').textContent  = fmtSec(aud.currentTime);
  document.getElementById('durTime').textContent  = fmtSec(aud.duration);
});

aud.addEventListener('loadedmetadata', () => {
  if (aud.duration && isFinite(aud.duration))
    document.getElementById('durTime').textContent = fmtSec(aud.duration);
});

aud.addEventListener('ended', () => {
  if (repeatMode === 2) { aud.currentTime = 0; aud.play(); return; }
  nextTr();
});

// iOS stall kurtarma
aud.addEventListener('stalled', () => {
  if (playing) setTimeout(() => aud.play().catch(() => {}), 800);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEEK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const seekWrap = document.getElementById('seekWrap');

function seekPct(e) {
  const r   = seekWrap.getBoundingClientRect();
  const x   = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
  const pct = Math.max(0, Math.min(1, x / r.width));
  if (aud.duration && isFinite(aud.duration)) aud.currentTime = pct * aud.duration;
}

seekWrap.addEventListener('touchstart', e => {
  seekDrag = true; seekWrap.classList.add('drag'); seekPct(e);
}, {passive:true});
seekWrap.addEventListener('touchmove',  e => { if (seekDrag) seekPct(e); }, {passive:true});
seekWrap.addEventListener('touchend',   ()=> { seekDrag = false; seekWrap.classList.remove('drag'); });
seekWrap.addEventListener('click', seekPct);

function miniSeek(e) {
  const r = document.getElementById('mpProg').getBoundingClientRect();
  const p = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
  if (aud.duration && isFinite(aud.duration)) aud.currentTime = p * aud.duration;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOLUME â€” HATA 11 dÃ¼zeltmesi (passive:false sadece volTrack iÃ§in)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const volTrack = document.getElementById('volTrack');

function setVolFromX(x) {
  const r = volTrack.getBoundingClientRect();
  vol = Math.max(0, Math.min(1, (x - r.left) / r.width));
  aud.volume = vol;
  document.getElementById('volFill').style.width = (vol * 100) + '%';
}

volTrack.addEventListener('click', e => setVolFromX(e.clientX));
volTrack.addEventListener('touchmove', e => {
  e.preventDefault(); // Sadece bu element iÃ§in preventDefault
  setVolFromX(e.touches[0].clientX);
}, {passive: false});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MEDIA SESSION â€” HATA 6 dÃ¼zeltmesi (listener birikimi Ã¶nlendi)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateMS(tr) {
  if (!('mediaSession' in navigator)) return;

  navigator.mediaSession.metadata = new MediaMetadata({
    title:   tr.title,
    artist:  tr.artist,
    album:   tr.album,
    artwork: tr.cover ? [{ src: tr.cover, sizes:'300x300', type:'image/jpeg' }] : []
  });

  // setActionHandler her Ã§aÄŸrÄ±da eskisini ezer â€” listener birikimi yok
  navigator.mediaSession.setActionHandler('play',          () => aud.play().catch(()=>{}));
  navigator.mediaSession.setActionHandler('pause',         () => aud.pause());
  navigator.mediaSession.setActionHandler('nexttrack',     () => nextTr());
  navigator.mediaSession.setActionHandler('previoustrack', () => prevTr());
  navigator.mediaSession.setActionHandler('seekforward',   () => skip(10));
  navigator.mediaSession.setActionHandler('seekbackward',  () => skip(-10));
  try {
    navigator.mediaSession.setActionHandler('seekto', e => {
      if (e.seekTime && isFinite(e.seekTime)) aud.currentTime = e.seekTime;
    });
  } catch {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAVORÄ°LER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togFavById(id, btn) {
  if (favSet.has(id)) {
    favSet.delete(id);
    if (btn) { btn.textContent = 'â™¡'; btn.classList.remove('on'); }
    showToast('ğŸ’” Favoriden Ã§Ä±karÄ±ldÄ±');
  } else {
    favSet.add(id);
    if (btn) { btn.textContent = 'â™¥'; btn.classList.add('on'); }
    showToast('â¤ï¸ Favorilere eklendi');
  }
  ls('mb_favs', JSON.stringify([...favSet]));
  // Player fav butonu gÃ¼ncelle
  if (queue[ci]?.id === id) refreshFavBtn(id);
}

// HATA 1 dÃ¼zeltmesi â€” artÄ±k sahte btn yok
function togFavCur() {
  if (ci < 0 || !queue[ci]) { showToast('âš ï¸ ÅarkÄ± Ã§almÄ±yor'); return; }
  const id = queue[ci].id;
  if (favSet.has(id)) {
    favSet.delete(id);
    document.getElementById('favBtn').innerHTML = 'â™¡<span>Favori</span>';
    showToast('ğŸ’” Favoriden Ã§Ä±karÄ±ldÄ±');
  } else {
    favSet.add(id);
    document.getElementById('favBtn').innerHTML = 'â™¥<span>Favori</span>';
    showToast('â¤ï¸ Favorilere eklendi');
  }
  ls('mb_favs', JSON.stringify([...favSet]));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTEXT MENU â€” HATA 2 & 8 dÃ¼zeltmesi
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let ctxKey = null;

function openCtx(k, btn) {
  ctxKey = k;
  ctxTr  = getTrById(k);
  if (!ctxTr) return;

  const menu = document.getElementById('ctx');
  menu.classList.add('show');

  const rect  = btn.getBoundingClientRect();
  const menuH = 220;
  const top   = rect.bottom + 6 + menuH > window.innerHeight
    ? rect.top - menuH - 6 : rect.bottom + 6;
  menu.style.top   = Math.max(10, top) + 'px';
  menu.style.right = '18px';
  menu.style.left  = 'auto';

  const isFav = favSet.has(ctxTr.id);
  document.getElementById('ctxFavIco').textContent = isFav ? 'ğŸ’”' : 'â¤ï¸';
  document.getElementById('ctxFavTxt').textContent = isFav ? 'Favoriden Ã‡Ä±kar' : 'Favorilere Ekle';

  // DÄ±ÅŸarÄ± tÄ±klanÄ±nca kapat â€” HATA 8 dÃ¼zeltmesi
  setTimeout(() => {
    document.addEventListener('click', onCtxOutside, {once:true, capture:true});
  }, 0);
}

function onCtxOutside(e) {
  const menu = document.getElementById('ctx');
  if (!menu.contains(e.target)) menu.classList.remove('show');
}

function closeCtx() { document.getElementById('ctx').classList.remove('show'); }

function ctxPlay() {
  if (!ctxTr) return; closeCtx();
  queue = [...tracks]; ci = queue.findIndex(t => t.id === ctxTr.id);
  if (ci < 0) { queue.push(ctxTr); ci = queue.length - 1; }
  playIdx(ci); goTab('player', document.querySelectorAll('.tab')[1]);
}

function ctxNext() {
  if (!ctxTr) return;
  queue.splice(Math.max(ci + 1, 0), 0, { ...ctxTr });
  showToast('â­ SÄ±radaki eklendi'); renderQ(); closeCtx();
}

function ctxQueue() {
  if (!ctxTr) return;
  queue.push({ ...ctxTr });
  showToast('ğŸ“‹ SÄ±raya eklendi'); renderQ(); closeCtx();
}

// HATA 2 dÃ¼zeltmesi â€” artÄ±k sahte btn yok
function ctxFav() {
  if (!ctxTr) return;
  const id    = ctxTr.id;
  const isFav = favSet.has(id);
  if (isFav) { favSet.delete(id); showToast('ğŸ’” KaldÄ±rÄ±ldÄ±'); }
  else        { favSet.add(id);   showToast('â¤ï¸ Eklendi'); }
  ls('mb_favs', JSON.stringify([...favSet]));
  if (queue[ci]?.id === id) refreshFavBtn(id);
  renderLib();
  closeCtx();
}

function ctxPl() {
  if (!ctxTr) return; closeCtx();
  openAddToPl(ctxTr);
}

function ctxDel() {
  if (!ctxTr) return;
  tracks = tracks.filter(t => t.id !== ctxTr.id);
  // Blob URL temizle
  if (blobMap[ctxTr.id])  { URL.revokeObjectURL(blobMap[ctxTr.id]);  delete blobMap[ctxTr.id]; }
  if (coverMap[ctxTr.id]) { URL.revokeObjectURL(coverMap[ctxTr.id]); delete coverMap[ctxTr.id]; }
  dbDel('files', ctxTr.id);
  dbDel('files', ctxTr.id + '_cov');
  dbDel('meta',  ctxTr.id);
  updateBadge(); renderLib(); closeCtx();
  showToast('ğŸ—‘ï¸ KaldÄ±rÄ±ldÄ±');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUEUE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openQueue() { renderQ(); document.getElementById('qPanel').classList.add('show'); }
function closeQueue() { document.getElementById('qPanel').classList.remove('show'); }

function renderQ() {
  const el = document.getElementById('qpList');
  if (!queue.length) {
    el.innerHTML = `<div class="empty"><span class="e-ico">ğŸ“­</span>
      <div class="e-tit">SÄ±ra BoÅŸ</div></div>`;
    return;
  }
  el.innerHTML = queue.map((tr, i) => `
    <div class="qi${i===ci?' active':''}" onclick="playIdx(${i})">
      <div class="qi-num">${i===ci?'â–¶':(i+1)}</div>
      <div class="qi-art">${tr.cover?`<img src="${esc(tr.cover)}">`:'ğŸµ'}</div>
      <div class="qi-info">
        <div class="qi-title">${esc(tr.title)}</div>
        <div class="qi-artist">${esc(tr.artist)}</div>
      </div>
      <div class="qi-dur">${fmtSec(tr.duration)}</div>
      <button class="qi-rm" onclick="event.stopPropagation();rmQ(${i})">âœ•</button>
    </div>`).join('');
}

function rmQ(i) {
  if (i === ci) { showToast('âš ï¸ Ã‡alan ÅŸarkÄ± kaldÄ±rÄ±lamaz'); return; }
  queue.splice(i, 1);
  if (i < ci) ci--;
  renderQ();
}

function doShuffleQ() {
  if (!queue.length) return;
  const cur = queue[ci];
  queue.splice(ci, 1);
  for (let i = queue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [queue[i], queue[j]] = [queue[j], queue[i]];
  }
  queue.unshift(cur); ci = 0;
  renderQ(); showToast('ğŸ”€ KarÄ±ÅŸtÄ±rÄ±ldÄ±');
}

function doClearQ() {
  if (!confirm('SÄ±rayÄ± temizle?')) return;
  queue = []; ci = -1;
  aud.pause();
  updatePS(false);
  document.getElementById('miniPl').classList.remove('show');
  renderQ(); closeQueue();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYLÄ°STLER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPls() {
  const smarts = [
    { name:'En Ã‡ok Ã‡alÄ±nan', ico:'ğŸ”¥', key:'plays'  },
    { name:'Son Ã‡alÄ±nan',    ico:'ğŸ•', key:'recent' },
    { name:'Favoriler',      ico:'â¤ï¸', key:'fav'    },
    { name:'TÃ¼mÃ¼',           ico:'ğŸµ', key:'all'    },
  ];

  document.getElementById('smartPls').innerHTML = smarts.map(s =>
    `<div class="pl-card smart-pl" onclick="playSmartPl('${s.key}')">
      <div class="pl-art">${s.ico}</div>
      <div class="pl-info">
        <div class="pl-name">${s.name}</div>
        <div class="pl-cnt">${smartCnt(s.key)} ÅŸarkÄ±</div>
      </div>
      <div class="pl-acts">
        <button class="pa pa-play"
          onclick="event.stopPropagation();playSmartPl('${s.key}')">â–¶</button>
      </div>
    </div>`
  ).join('');

  const manEl = document.getElementById('manPls');
  if (!playlists.length) {
    manEl.innerHTML = `<div class="empty"><span class="e-ico">ğŸ“‹</span>
      <div class="e-tit">Liste Yok</div>
      <div class="e-sub">+ Yeni ile oluÅŸtur</div></div>`;
    return;
  }
  manEl.innerHTML = playlists.map((pl, i) =>
    `<div class="pl-card" onclick="playPl(${i})">
      <div class="pl-art">${pl.ico||'ğŸ“‹'}</div>
      <div class="pl-info">
        <div class="pl-name">${esc(pl.name)}</div>
        <div class="pl-cnt">${pl.tracks.length} ÅŸarkÄ±</div>
      </div>
      <div class="pl-acts">
        <button class="pa pa-play"
          onclick="event.stopPropagation();playPl(${i})">â–¶</button>
        <button class="pa pa-del"
          onclick="event.stopPropagation();delPl(${i})">ğŸ—‘</button>
      </div>
    </div>`
  ).join('');
}

function smartCnt(k) {
  if (k==='all')    return tracks.length;
  if (k==='fav')    return favSet.size;
  if (k==='plays')  return Math.min(tracks.length, 25);
  if (k==='recent') return Math.min(history.length, 25);
  return 0;
}

function playSmartPl(k) {
  let list = [...tracks];
  if (k==='fav')    list = list.filter(t => favSet.has(t.id));
  if (k==='plays')  list = list.sort((a,b)=>(b.plays||0)-(a.plays||0)).slice(0,25);
  if (k==='recent') {
    const seen = new Set();
    list = history.map(id=>tracks.find(t=>t.id===id))
                  .filter(t=>{if(!t||seen.has(t.id))return false;seen.add(t.id);return true;})
                  .slice(0,25);
  }
  if (!list.length) { showToast('âš ï¸ Liste boÅŸ'); return; }
  queue = [...list]; ci = 0;
  playIdx(0); goTab('player', document.querySelectorAll('.tab')[1]);
}

function playPl(i) {
  const pl   = playlists[i];
  const list = pl.tracks.map(id => tracks.find(t=>t.id===id)).filter(Boolean);
  if (!list.length) { showToast('âš ï¸ Liste boÅŸ'); return; }
  queue = [...list]; ci = 0;
  playIdx(0); goTab('player', document.querySelectorAll('.tab')[1]);
}

function delPl(i) {
  if (!confirm('Playlist silinsin mi?')) return;
  playlists.splice(i, 1); savePls(); renderPls();
}

function openCreatePl() {
  document.getElementById('modalTtl').textContent   = 'âœ¨ Yeni Playlist';
  document.getElementById('modalInp').placeholder   = 'Playlist adÄ±...';
  document.getElementById('modalInp').value         = '';
  modalMode  = 'create'; modalExtra = null;
  document.getElementById('modalOv').classList.add('show');
  setTimeout(() => document.getElementById('modalInp').focus(), 320);
}

function openAddToPl(tr) {
  document.getElementById('modalTtl').textContent = 'â• Playliste Ekle';
  document.getElementById('modalInp').placeholder = 'Playlist adÄ± (yeni veya mevcut)...';
  document.getElementById('modalInp').value       = '';
  modalMode  = 'addtrack'; modalExtra = tr;
  document.getElementById('modalOv').classList.add('show');
  setTimeout(() => document.getElementById('modalInp').focus(), 320);
}

// HATA 7 dÃ¼zeltmesi â€” modal overlay click kontrolÃ¼
document.getElementById('modalOv').addEventListener('click', e => {
  if (e.target === document.getElementById('modalOv')) closeModal();
});

function closeModal() { document.getElementById('modalOv').classList.remove('show'); }

function modalOk() {
  const name = document.getElementById('modalInp').value.trim();
  if (!name) { showToast('âš ï¸ Ä°sim gir'); return; }

  if (modalMode === 'create') {
    playlists.push({ name, ico:'ğŸ“‹', tracks:[] });
    savePls(); renderPls(); showToast('âœ… OluÅŸturuldu');
  } else if (modalMode === 'addtrack' && modalExtra) {
    let pl = playlists.find(p => p.name.toLowerCase() === name.toLowerCase());
    if (!pl) { pl = { name, ico:'ğŸ“‹', tracks:[] }; playlists.push(pl); }
    if (!pl.tracks.includes(modalExtra.id)) {
      pl.tracks.push(modalExtra.id);
      savePls(); showToast(`âœ… "${esc(pl.name)}"e eklendi`);
    } else {
      showToast('âš ï¸ Zaten listede');
    }
  }
  closeModal();
}

function savePls() { ls('mb_pls', JSON.stringify(playlists)); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EQ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EQ_FREQS   = [60, 250, 1000, 4000, 16000];
const EQ_LABELS  = ['Bass','Low-Mid','Mid','Hi-Mid','Treble'];
const EQ_PRESETS = {
  'Normal':    [0,0,0,0,0],
  'Pop':       [2,-1,0,2,3],
  'Rock':      [4,2,-1,2,4],
  'Jazz':      [2,2,0,-1,-2],
  'Klasik':    [3,1,0,1,2],
  'Bass':      [6,4,0,-1,-2],
  'Vocal':     [-2,0,3,3,1],
  'Elektronik':[4,2,0,2,4],
};

function buildEQ() {
  document.getElementById('eqPresets').innerHTML =
    Object.keys(EQ_PRESETS).map(n =>
      `<div class="eq-pr${n==='Normal'?' on':''}" onclick="applyEQPreset('${n}',this)">${n}</div>`
    ).join('');

  document.getElementById('eqBands').innerHTML =
    EQ_FREQS.map((f, i) =>
      `<div class="eq-band">
        <input class="eq-sl" type="range" min="-12" max="12" value="0" step="0.5"
          oninput="onEQSlider(${i},this.value)">
        <div class="eq-lbl">${EQ_LABELS[i]}</div>
      </div>`
    ).join('');
}

function onEQSlider(i, val) {
  // Web Audio EQ baÄŸlantÄ±sÄ± yok â€” sadece gÃ¶rsel
  // GerÃ§ek EQ iÃ§in Web Audio baÄŸlarsak iOS arka plan ses keser
  // Bu nedenle EQ gÃ¶rsel referans olarak tutulur
  console.log('EQ band', i, '=', val);
}

function applyEQPreset(name, el) {
  document.querySelectorAll('.eq-pr').forEach(p => p.classList.remove('on'));
  if (el) el.classList.add('on');
  else { // "SÄ±fÄ±rla" butonundan geldi
    const first = document.querySelector('.eq-pr');
    if (first) first.classList.add('on');
  }
  const vals = EQ_PRESETS[name] || [0,0,0,0,0];
  document.querySelectorAll('.eq-sl').forEach((sl, i) => {
    if (vals[i] !== undefined) sl.value = vals[i];
  });
}

function togEQ() {
  const p = document.getElementById('eqPanel');
  p.classList.toggle('show');
  document.getElementById('eqBtn').classList.toggle('on', p.classList.contains('show'));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderCfg() {
  Object.keys(DEF_CFG).forEach(k => {
    const el = document.getElementById('tog-' + k);
    if (el) el.classList.toggle('on', !!cfg[k]);
  });

  const themes = [
    {n:'Mor',    c:'#8b5cf6', c2:'#6d28d9'},
    {n:'Mavi',   c:'#3b82f6', c2:'#1d4ed8'},
    {n:'YeÅŸil',  c:'#10b981', c2:'#065f46'},
    {n:'Pembe',  c:'#ec4899', c2:'#9d174d'},
    {n:'Turuncu',c:'#f59e0b', c2:'#b45309'},
    {n:'KÄ±rmÄ±zÄ±',c:'#ef4444', c2:'#991b1b'},
  ];
  const cur = cfg.theme || '#8b5cf6';
  document.getElementById('themeColors').innerHTML = themes.map(t =>
    `<div class="thm-c${t.c===cur?' on':''}"
      style="background:linear-gradient(135deg,${t.c},${t.c2})"
      onclick="setTheme('${t.c}','${t.c2}','${t.n}',this)"
      title="${t.n}"></div>`
  ).join('');

  renderStats();
}

function togSet(k) {
  cfg[k] = !cfg[k];
  const el = document.getElementById('tog-' + k);
  if (el) el.classList.toggle('on', cfg[k]);
  ls('mb_cfg', JSON.stringify(cfg));
  showToast(cfg[k] ? `âœ… ${k} aÃ§Ä±k` : `âŒ ${k} kapalÄ±`);
}

function setTheme(c, c2, n, el) {
  document.querySelectorAll('.thm-c').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
  document.documentElement.style.setProperty('--p',  c);
  document.documentElement.style.setProperty('--p2', c);
  document.documentElement.style.setProperty('--p3', c2);
  cfg.theme = c; cfg.theme2 = c2;
  ls('mb_cfg', JSON.stringify(cfg));
  showToast('ğŸ¨ ' + n);
}

function renderStats() {
  const totalMin   = Math.round(tracks.reduce((a,t) => a + (t.duration||0), 0) / 60);
  const artists    = new Set(tracks.map(t => t.artist)).size;
  const albums     = new Set(tracks.map(t => t.album)).size;
  const totalPlays = Object.values(playCnt).reduce((a,b) => a + b, 0);
  document.getElementById('statGrid').innerHTML = `
    <div class="stat-i"><div class="stat-n">${tracks.length}</div><div class="stat-l">ÅarkÄ±</div></div>
    <div class="stat-i"><div class="stat-n">${totalMin}</div><div class="stat-l">Dakika</div></div>
    <div class="stat-i"><div class="stat-n">${artists}</div><div class="stat-l">SanatÃ§Ä±</div></div>
    <div class="stat-i"><div class="stat-n">${albums}</div><div class="stat-l">AlbÃ¼m</div></div>
    <div class="stat-i"><div class="stat-n">${favSet.size}</div><div class="stat-l">Favori</div></div>
    <div class="stat-i"><div class="stat-n">${totalPlays}</div><div class="stat-l">Oynatma</div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SLEEP TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setSleep(min, el) {
  // Ã–nceki timer'Ä± temizle
  if (sleepTO) { clearTimeout(sleepTO);  sleepTO = null; }
  if (sleepIv) { clearInterval(sleepIv); sleepIv = null; }

  document.querySelectorAll('.slp-btn').forEach(b => b.classList.remove('on'));
  el.classList.add('on');

  if (!min) {
    document.getElementById('sleepDisp').textContent = 'â€”';
    showToast('ğŸ˜´ ZamanlayÄ±cÄ± kapalÄ±');
    return;
  }

  const end = Date.now() + min * 60000;
  sleepTO = setTimeout(() => {
    aud.pause(); updatePS(false);
    showToast('ğŸ˜´ Uyku zamanlayÄ±cÄ±sÄ± devreye girdi');
  }, min * 60000);

  sleepIv = setInterval(() => {
    const rem = end - Date.now();
    if (rem <= 0) { clearInterval(sleepIv); document.getElementById('sleepDisp').textContent='â€”'; return; }
    const m = Math.floor(rem/60000), s = Math.floor((rem%60000)/1000);
    document.getElementById('sleepDisp').textContent = `${m}:${s.toString().padStart(2,'0')}`;
  }, 1000);

  showToast(`ğŸ˜´ ${min} dakikada kapanacak`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hidePWA() {
  document.getElementById('pwaBanner').style.display = 'none';
  ls('mb_pwa_hidden', '1');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateBadge() {
  document.getElementById('libBadge').textContent = tracks.length;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._to);
  t._to = setTimeout(() => t.classList.remove('show'), 2700);
}

function clearAll() {
  if (!confirm('TÃ¼m veriler ve kayÄ±tlÄ± mÃ¼zikler silinsin mi?')) return;
  // Blob URL'leri serbest bÄ±rak
  freeAllBlobs();
  // DB temizle
  dbClear('files'); dbClear('meta');
  // LocalStorage temizle
  localStorage.clear();
  // State sÄ±fÄ±rla
  tracks=[]; queue=[]; ci=-1;
  favSet=new Set(); playlists=[]; history=[]; playCnt={};
  aud.pause(); aud.src='';
  updatePS(false); updateBadge();
  document.getElementById('miniPl').classList.remove('show');
  document.getElementById('libArea').style.display    = 'none';
  document.getElementById('folderArea').style.display = 'block';
  showToast('ğŸ—‘ï¸ TÃ¼mÃ¼ temizlendi');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init() {
  // DB aÃ§
  await openDB();

  // Tema uygula
  if (cfg.theme) {
    document.documentElement.style.setProperty('--p',  cfg.theme);
    document.documentElement.style.setProperty('--p2', cfg.theme);
    document.documentElement.style.setProperty('--p3', cfg.theme2 || cfg.theme);
  }

  // Spectrum oluÅŸtur
  buildSpectrum();
  startFakeSpectrum();

  // EQ oluÅŸtur
  buildEQ();

  // Volume
  document.getElementById('volFill').style.width = (vol * 100) + '%';

  // PWA kontrolÃ¼
  const isPWA = window.navigator.standalone ||
    window.matchMedia('(display-mode: standalone)').matches;
  if (isPWA || ls('mb_pwa_hidden')) {
    document.getElementById('pwaBanner').style.display = 'none';
  }

  // Restore kontrolÃ¼
  await checkRestore();

  // iOS AudioContext â€” kullanÄ±cÄ± etkileÅŸimi ile baÅŸlat (gelecekteki Ã¶zellikler iÃ§in)
  document.addEventListener('touchstart', () => {}, {once:true, passive:true});

  console.log('ğŸµ MÃ¼zikBox Pro v3 â€” HatasÄ±z sÃ¼rÃ¼m baÅŸlatÄ±ldÄ±');
}

init();
</script>
</body>
</html>
